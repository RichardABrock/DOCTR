<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DOCTR - Loading packages and exploring data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../css/mastemr.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="index.qmd" class="navbar-brand navbar-brand-logo">
    <img src="../images/KCL_logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="index.qmd">
    <span class="navbar-title">DOCTR</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/01-1-Loading_R.html">Introduction to R</a></li><li class="breadcrumb-item"><a href="../chapters/01-2-Intro_tidyverse.html">Loading packages and exploring data</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introduction to R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-1-Loading_R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-2-Intro_tidyverse.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Loading packages and exploring data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Introduction to Stats</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-1-Descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Descriptive Statistics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-2-ChisqPISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hypothesis testing and Chi-square tests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-3-T-testsPISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">T-tests</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-Intro_to_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Making graphs</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-Correlation_and_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Correlation and regression</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">SEM and Bayesian</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-1-SEM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SEM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-2-Bayesian.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Statistics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-PISA_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PISA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-DfE_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DfE England</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A3-TIMSS_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TIMSS, PIRLS and ICILS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A4-Other_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A5-Self_Study_Tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self Study Tasks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A6-selecting_statistical_tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Selecting statistical tools</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A7-QandA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Questions and Answers</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#exploring-data" id="toc-exploring-data" class="nav-link active" data-scroll-target="#exploring-data"><span class="header-section-number">1</span> Exploring data</a>
  <ul class="collapse">
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">1.1</span> Questions</a></li>
  <li><a href="#piping-and-dplyr" id="toc-piping-and-dplyr" class="nav-link" data-scroll-target="#piping-and-dplyr"><span class="header-section-number">1.2</span> “Piping and dplyr”</a></li>
  </ul></li>
  <li><a href="#select" id="toc-select" class="nav-link" data-scroll-target="#select"><span class="header-section-number">2</span> select</a>
  <ul class="collapse">
  <li><a href="#questions-1" id="toc-questions-1" class="nav-link" data-scroll-target="#questions-1"><span class="header-section-number">2.1</span> Questions</a></li>
  </ul></li>
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter"><span class="header-section-number">3</span> filter</a>
  <ul class="collapse">
  <li><a href="#questions-2" id="toc-questions-2" class="nav-link" data-scroll-target="#questions-2"><span class="header-section-number">3.1</span> Questions</a></li>
  </ul></li>
  <li><a href="#sec-renaming" id="toc-sec-renaming" class="nav-link" data-scroll-target="#sec-renaming"><span class="header-section-number">4</span> renaming columns</a></li>
  <li><a href="#group_by-and-summarise" id="toc-group_by-and-summarise" class="nav-link" data-scroll-target="#group_by-and-summarise"><span class="header-section-number">5</span> group_by and summarise</a>
  <ul class="collapse">
  <li><a href="#questions-3" id="toc-questions-3" class="nav-link" data-scroll-target="#questions-3"><span class="header-section-number">5.1</span> Questions</a></li>
  </ul></li>
  <li><a href="#sec-mutate" id="toc-sec-mutate" class="nav-link" data-scroll-target="#sec-mutate"><span class="header-section-number">6</span> mutate</a></li>
  <li><a href="#arrange" id="toc-arrange" class="nav-link" data-scroll-target="#arrange"><span class="header-section-number">7</span> arrange</a></li>
  <li><a href="#bring-everyting-together" id="toc-bring-everyting-together" class="nav-link" data-scroll-target="#bring-everyting-together"><span class="header-section-number">8</span> Bring everyting together</a></li>
  <li><a href="#advanced-topics" id="toc-advanced-topics" class="nav-link" data-scroll-target="#advanced-topics"><span class="header-section-number">9</span> Advanced topics</a>
  <ul class="collapse">
  <li><a href="#sec-ifelse" id="toc-sec-ifelse" class="nav-link" data-scroll-target="#sec-ifelse"><span class="header-section-number">9.1</span> Recoding data (ifelse)</a></li>
  <li><a href="#sec-factors" id="toc-sec-factors" class="nav-link" data-scroll-target="#sec-factors"><span class="header-section-number">9.2</span> Factors and statistical data types</a></li>
  </ul></li>
  <li><a href="#seminar-tasks" id="toc-seminar-tasks" class="nav-link" data-scroll-target="#seminar-tasks"><span class="header-section-number">10</span> Seminar tasks</a>
  <ul class="collapse">
  <li><a href="#student-dataset" id="toc-student-dataset" class="nav-link" data-scroll-target="#student-dataset"><span class="header-section-number">10.1</span> Student dataset</a></li>
  <li><a href="#teacher-dataset" id="toc-teacher-dataset" class="nav-link" data-scroll-target="#teacher-dataset"><span class="header-section-number">10.2</span> Teacher dataset</a></li>
  <li><a href="#graphing" id="toc-graphing" class="nav-link" data-scroll-target="#graphing"><span class="header-section-number">10.3</span> Graphing</a></li>
  </ul></li>
  <li><a href="#sec-graphing" id="toc-sec-graphing" class="nav-link" data-scroll-target="#sec-graphing"><span class="header-section-number">11</span> ggplot</a></li>
  <li><a href="#geoms" id="toc-geoms" class="nav-link" data-scroll-target="#geoms"><span class="header-section-number">12</span> geoms</a>
  <ul class="collapse">
  <li><a href="#sec-geom_point" id="toc-sec-geom_point" class="nav-link" data-scroll-target="#sec-geom_point"><span class="header-section-number">12.1</span> geom_point</a>
  <ul class="collapse">
  <li><a href="#questions-4" id="toc-questions-4" class="nav-link" data-scroll-target="#questions-4"><span class="header-section-number">12.1.1</span> Questions</a></li>
  </ul></li>
  <li><a href="#sec-geom_bar" id="toc-sec-geom_bar" class="nav-link" data-scroll-target="#sec-geom_bar"><span class="header-section-number">12.2</span> geom_bar</a>
  <ul class="collapse">
  <li><a href="#raising-the-bars-yourself" id="toc-raising-the-bars-yourself" class="nav-link" data-scroll-target="#raising-the-bars-yourself"><span class="header-section-number">12.2.1</span> Raising the bars yourself</a></li>
  <li><a href="#questions-5" id="toc-questions-5" class="nav-link" data-scroll-target="#questions-5"><span class="header-section-number">12.2.2</span> Questions</a></li>
  </ul></li>
  <li><a href="#geom_text" id="toc-geom_text" class="nav-link" data-scroll-target="#geom_text"><span class="header-section-number">12.3</span> geom_text</a></li>
  </ul></li>
  <li><a href="#faceting" id="toc-faceting" class="nav-link" data-scroll-target="#faceting"><span class="header-section-number">13</span> faceting</a>
  <ul class="collapse">
  <li><a href="#exporting-plots" id="toc-exporting-plots" class="nav-link" data-scroll-target="#exporting-plots"><span class="header-section-number">13.1</span> Exporting plots</a></li>
  </ul></li>
  <li><a href="#additional-support-on-graphing" id="toc-additional-support-on-graphing" class="nav-link" data-scroll-target="#additional-support-on-graphing"><span class="header-section-number">14</span> Additional support on graphing</a>
  <ul class="collapse">
  <li><a href="#using-r-to-do-descriptive-statistics-and-plot-graphs" id="toc-using-r-to-do-descriptive-statistics-and-plot-graphs" class="nav-link" data-scroll-target="#using-r-to-do-descriptive-statistics-and-plot-graphs"><span class="header-section-number">14.1</span> Using R to do descriptive statistics and plot graphs</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Loading packages and exploring data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="exploring-data" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Exploring data</h1>
<p>Now that we have loaded the <code>PISA_2022</code> dataset we can start to explore it.</p>
<p>You can check that the tables have loaded correctly by typing the object name and ‘<em>running</em>’ the line (<code>control</code>|<code>command ⌘</code> and <code>Enter</code>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>PISA_2022</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 82
   CNT     CNTSCHID CNTSTUID REGION  OECD  LANGTEST_QQQ ST003D02T ST003D03T
 * &lt;fct&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt; &lt;fct&gt;        &lt;fct&gt;     &lt;fct&gt;    
 1 Albania   800282   800001 Albania No    Albanian     May       2006     
 2 Albania   800115   800002 Albania No    Albanian     February  2006     
 3 Albania   800242   800003 Albania No    Albanian     August    2006     
 4 Albania   800245   800005 Albania No    Albanian     July      2006     
 5 Albania   800285   800006 Albania No    Albanian     January   2006     
 6 Albania   800172   800007 Albania No    Albanian     May       2006     
 7 Albania   800082   800008 Albania No    Albanian     May       2006     
 8 Albania   800274   800009 Albania No    Albanian     December  2006     
 9 Albania   800057   800010 Albania No    Albanian     August    2006     
10 Albania   800132   800012 Albania No    Albanian     September 2006     
# ℹ 613,734 more rows
# ℹ 74 more variables: ST004D01T &lt;fct&gt;, ST250Q01JA &lt;fct&gt;, ST250Q02JA &lt;fct&gt;,
#   ST250Q03JA &lt;fct&gt;, ST250Q05JA &lt;fct&gt;, ST251Q01JA &lt;fct&gt;, ST251Q06JA &lt;fct&gt;,
#   ST251Q07JA &lt;fct&gt;, ST253Q01JA &lt;fct&gt;, ST254Q01JA &lt;fct&gt;, ST254Q02JA &lt;fct&gt;,
#   ST254Q03JA &lt;fct&gt;, ST254Q04JA &lt;fct&gt;, ST254Q05JA &lt;fct&gt;, ST254Q06JA &lt;fct&gt;,
#   ST255Q01JA &lt;fct&gt;, ST256Q02JA &lt;fct&gt;, ST005Q01JA &lt;fct&gt;, ST007Q01JA &lt;fct&gt;,
#   ST019AQ01T &lt;fct&gt;, ST019BQ01T &lt;fct&gt;, ST019CQ01T &lt;fct&gt;, ST125Q01NA &lt;fct&gt;, …</code></pre>
</div>
</div>
<p>We can see from this that the <code>tibble</code> (another word for <em>dataframe</em>, basically a spreadsheet table) is 613744 rows, with 82 columns <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. This is data for all the students from around the world that took part in PISA 2022. The actual PISA dataset has many more columns than this, but for the examples here we have selected 82 of the more interesting data variables. The column names might seem rather confusing and you might want to refer to the <a href="https://webfs.oecd.org/pisa2022/CY08MSP_CODEBOOK_5thDecember23.xlsx">PISA 2022 code book</a> to find out what everything means.</p>
<p>The data shown in the console window is only the top few rows and first few columns. To see the whole table click on the <code>Environment panel</code> and the table icon <img src="images/icon_table.png" class="img-fluid"> to explore the table:</p>
<p><img src="images/environment_view_table.png" class="img-fluid"></p>
<p>Alternatively, you can also hold down <code>command ⌘</code>|<code>control</code> and click on the table name in your R Script to view the table. You can also type <code>View(&lt;table_name&gt;)</code>. <strong>Note:</strong> this has a capital “V”</p>
<p>In the table view mode you can read the label attached to each column, this will give you more detail about what the column stores. If you hover over columns it will display the label:</p>
<p><img src="images/environment_col_label.png" class="img-fluid"></p>
<p>Alternatively, to read the full label of a column, the following code can be used:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># You might also want to read the label of a field</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">attr</span>(PISA_2022<span class="sc">$</span>ST324Q11JA, <span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Agree/disagree: School has been a waste of time."</code></pre>
</div>
</div>
<p>Each view only shows you 50 columns, to see more use the navigation panel:</p>
<p><img src="images/navigation_panel.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>To learn more about loading data from in other formats, e.g.&nbsp;SPSS and STATA, look at the tidyverse documentation for <a href="https://haven.tidyverse.org/">haven</a>.</p>
</div>
</div>
<p>The <code>PISA_2022</code> dataframe is made up of multiple columns, with each column acting like a <em>vector</em>, which means each column stores values of only one datatype. If we look at the first four columns of the schools table, you can see the <code>CNTSTUID</code>, <code>ESCS</code> and <code>PV1MATH</code> columns are <code>&lt;dbl&gt;</code> (<code>numeric</code>) and the other three columns are of <code>&lt;fctr&gt;</code> (<code>factor</code>), a special datatype in R that helps store categorical and ordinal variables, see <a href="#sec-factors">Section&nbsp;9.2</a> for more information on how factors work.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  CNTSTUID ST004D01T CNT       ESCS PV1MATH
     &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;    &lt;dbl&gt;   &lt;dbl&gt;
1   800001 Female    Albania  1.11     180.
2   800002 Male      Albania -3.05     308.
3   800003 Male      Albania -0.187    268.
4   800005 Female    Albania -3.22     273.
5   800006 Female    Albania -1.05     435.</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Vectors are data structures that bring together one or more data elements of the same datatype. E.g. we might have a numeric vector recording the grades of a class, or a character vector storing the gender of a set of students. To define a vector we use <code>c(item, item, ...)</code>, where <code>c</code> stands for combine. Vectors are very important to R, even declaring a single object, <code>x &lt;- 6</code>, is creating a vector of size one. To find out more about vectors see: <strong>?@sec-vectors</strong></p>
</div>
</div>
<p>We can find out some general information about the table we have loaded. <code>nrow</code> and <code>ncol</code> tell you about the dimensions of the table</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">nrow</span>(PISA_2022)  <span class="co"># how many rows are in the results table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 613744</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">ncol</span>(PISA_2022)  <span class="co"># how many columns are in the results table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 82</code></pre>
</div>
</div>
<p>If we want to know the names of the columns we can use the <code>names()</code> command that returns a vector. This can be a little confusing as it’ll return the names used in the dataframe, which can be hard to interpret, e.g.&nbsp;<code>ST004D01T</code> is PISA’s way of encoding gender. You might find the labels in the view of the table available through <code>View(PISA_2022)</code> (<strong>note:</strong> the capital V in View) and the <em>Environment</em> panel easier to navigate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">names</span>(PISA_2022) <span class="co"># the column names of a table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "CNT"          "CNTSCHID"     "CNTSTUID"     "REGION"       "OECD"        
 [6] "LANGTEST_QQQ" "ST003D02T"    "ST003D03T"    "ST004D01T"    "ST250Q01JA"  
[11] "ST250Q02JA"   "ST250Q03JA"   "ST250Q05JA"   "ST251Q01JA"   "ST251Q06JA"  
[16] "ST251Q07JA"   "ST253Q01JA"   "ST254Q01JA"   "ST254Q02JA"   "ST254Q03JA"  
[21] "ST254Q04JA"   "ST254Q05JA"   "ST254Q06JA"   "ST255Q01JA"   "ST256Q02JA"  
[26] "ST005Q01JA"   "ST007Q01JA"   "ST019AQ01T"   "ST019BQ01T"   "ST019CQ01T"  
[31] "ST125Q01NA"   "ST261Q01JA"   "ST261Q04JA"   "ST062Q02TA"   "ST038Q08NA"  
[36] "ST016Q01NA"   "ST337Q07JA"   "ST324Q11JA"   "ST355Q03JA"   "FL150Q02TA"  
 [ reached getOption("max.print") -- omitted 42 entries ]</code></pre>
</div>
</div>
<p>As mentioned, the columns in the tables are very much like a collection of <em>vectors</em>, to access these columns we can put a <code>$</code> [dollar sign] after the name of a table. This allows us to see all the columns that table has, using the up and down arrows to select, press the <code>Tab</code> key to complete:</p>
<p><img src="images/dollar_fields.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>PISA_2022<span class="sc">$</span>ST038Q08NA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] Never or almost never A few times a year    &lt;NA&gt;                 
 [4] A few times a month   Never or almost never Never or almost never
 [7] Never or almost never Never or almost never Never or almost never
[10] &lt;NA&gt;                  Never or almost never &lt;NA&gt;                 
[13] Once a week or more   Never or almost never Never or almost never
[16] Never or almost never Never or almost never Never or almost never
[19] A few times a month   Never or almost never &lt;NA&gt;                 
[22] Never or almost never Never or almost never Never or almost never
[25] &lt;NA&gt;                  Never or almost never Never or almost never
[28] Never or almost never Never or almost never Never or almost never
[31] A few times a year    Never or almost never Never or almost never
[34] Never or almost never Never or almost never Never or almost never
[37] Never or almost never &lt;NA&gt;                  Once a week or more  
[40] Never or almost never
 [ reached getOption("max.print") -- omitted 613704 entries ]
attr(,"label")
[1] In past 12 months, how often: Other students spread nasty rumours about me.
8 Levels: Never or almost never A few times a year ... No Response</code></pre>
</div>
</div>
<p>We can apply functions to the returned column/vector, for example: <code>sum</code>, <code>mean</code>, <code>median</code>, <code>max</code>, <code>min</code>, <code>sd</code>, <code>round</code>, <code>unique</code>, <code>summary</code>, <code>length</code>. To find all the different/unique values contained in a column we can write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">unique</span>(PISA_2022<span class="sc">$</span>CNT) <span class="co"># the unique values in this column</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] Albania               Baku (Azerbaijan)     Argentina            
 [4] Australia             Austria               Belgium              
 [7] Brazil                Brunei Darussalam     Bulgaria             
[10] Cambodia              Canada                Chile                
[13] Chinese Taipei        Colombia              Costa Rica           
[16] Croatia               Czech Republic        Denmark              
[19] Dominican Republic    El Salvador           Estonia              
[22] Finland               France                Georgia              
[25] Palestinian Authority Germany               Greece               
[28] Guatemala             Hong Kong (China)     Hungary              
[31] Iceland               Indonesia             Ireland              
[34] Israel                Italy                 Kosovo               
[37] Jamaica               Japan                 Kazakhstan           
[40] Jordan               
 [ reached getOption("max.print") -- omitted 40 entries ]
81 Levels: Albania United Arab Emirates Argentina Australia Austria ... Viet Nam</code></pre>
</div>
</div>
<p>We can also combine commands, with <code>length(&lt;vector&gt;)</code> telling you how many items are in the <code>unique(PISA_2022$CNT)</code> command</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># tells you the number of countries in PISA 2022</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="fu">length</span>(<span class="fu">unique</span>(PISA_2022<span class="sc">$</span>CNT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 80</code></pre>
</div>
</div>
<p>You might meet errors when you try and run some of the commands because a field has missing data, recorded as <code>NA</code>. In the case below it doesn’t know what to do with the <code>NA</code> values in <code>ESCS</code>, so it gives up and returns <code>NA</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">max</span>(PISA_2022<span class="sc">$</span>ESCS) <span class="co"># max cultural capital value for all students</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA</code></pre>
</div>
</div>
<p>You can see one of the <code>NA</code>s by just looking at this column:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>PISA_2022<span class="sc">$</span>ESCS <span class="co"># NAs present in data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1.1112 -3.0507 -0.1867 -3.2198 -1.0548  1.0855 -0.7623 -1.0237 -1.1697
[10]  0.2857 -1.9799  0.0630 -0.1699 -2.5828 -1.1781 -0.5965 -1.0903  0.7457
[19] -0.8850 -1.6258 -0.3345 -2.0967 -1.1041 -1.0403      NA  0.3638 -2.7519
[28] -0.1190 -1.2030 -0.4250 -0.1505 -1.7077 -1.6741 -1.0123 -1.0653 -0.4197
[37] -1.7776 -0.2216 -1.1821  0.3523
 [ reached getOption("max.print") -- omitted 613704 entries ]
attr(,"label")
[1] "Index of economic, social and cultural status"</code></pre>
</div>
</div>
<p>To get around this you can tell R to remove the <code>NA</code> values when performing maths calculations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># max cultural capital score for all students</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="fu">max</span>(PISA_2022<span class="sc">$</span>ESCS, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.38</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>R’s inbuilt <code>mode</code> function doesn’t calculate the mathematical <em>mode</em>, instead it tells you what type of data you are dealing with. You can work out the mode of data by using the <code>modeest</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">library</span>(modeest)</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="fu">mlv</span>(PISA_2022<span class="sc">$</span>PV1MATH, <span class="at">method =</span> <span class="st">"mfv"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 386.086</code></pre>
</div>
</div>
<p>There is more discussion on how to use modes in R <a href="https://stackoverflow.com/questions/2547402/how-to-find-the-statistical-mode">here</a></p>
</div>
</div>
<p>Calculations might also be upset when you try to perform maths on a column that you think is a number but is actually stored as another datatype. For example if you wanted to work out the mean number of “How many [digital devices] with screens are there in your [home]?” - <code>ST253Q01JA</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">mean</span>(PISA_2022<span class="sc">$</span>ST253Q01JA, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA</code></pre>
</div>
</div>
<p>Looking at the structure of this column, we can see it is stored as a <code>factor</code>, not as a <code>numeric</code>. Factors are a special datatype that use numbers to link to categorical values. For <code>ST253Q01JA</code> there are 12 different <em>levels</em> that you can explore using the <code>str()</code> and <code>levels()</code> commands:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">str</span>(PISA_2022<span class="sc">$</span>ST253Q01JA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Factor w/ 12 levels "There are no &lt;digital devices&gt; with screens.",..: 8 2 8 2 7 8 7 NA 6 7 ...
 - attr(*, "label")= chr "How many [digital devices] with screens are there in your [home]?"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">levels</span>(PISA_2022<span class="sc">$</span>ST253Q01JA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "There are no &lt;digital devices&gt; with screens."
 [2] "One"                                         
 [3] "Two"                                         
 [4] "Three"                                       
 [5] "Four"                                        
 [6] "Five"                                        
 [7] "6 to 10"                                     
 [8] "More than 10"                                
 [9] "Valid Skip"                                  
[10] "Not Applicable"                              
[11] "Invalid"                                     
[12] "No Response"                                 </code></pre>
</div>
</div>
<p>You can change the type of the column to make it work with the <code>mean</code> command, changing the column to <code>as.numeric(&lt;column&gt;)</code> for the calculation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># note: this isn't ideal for proper analysis!</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="fu">mean</span>(<span class="fu">as.numeric</span>(PISA_2022<span class="sc">$</span>ST253Q01JA), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.312233</code></pre>
</div>
</div>
<p>This is far from ideal as we are now treating a categorical field as a numeric! Looking at the coding for the numbers in the field and the corresponding levels, we see that <code>1</code> is actually no digital devices. For more details on datatypes, see <strong>?@sec-datatypes</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">paste</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">levels</span>(PISA_2022<span class="sc">$</span>ST253Q01JA)), <span class="st">":"</span>, <span class="fu">levels</span>(PISA_2022<span class="sc">$</span>ST253Q01JA))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "1 : There are no &lt;digital devices&gt; with screens."
 [2] "2 : One"                                         
 [3] "3 : Two"                                         
 [4] "4 : Three"                                       
 [5] "5 : Four"                                        
 [6] "6 : Five"                                        
 [7] "7 : 6 to 10"                                     
 [8] "8 : More than 10"                                
 [9] "9 : Valid Skip"                                  
[10] "10 : Not Applicable"                             
[11] "11 : Invalid"                                    
[12] "12 : No Response"                                </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>To get a good overview of what a table contains, you can use the <code>str(&lt;table_name&gt;)</code> and <code>summary(&lt;table_name&gt;)</code> commands.</p>
</div>
</div>
<section id="questions" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="questions"><span class="header-section-number">1.1</span> Questions</h2>
<div class="question">
<p>Using the <code>PISA_2022</code> dataset:</p>
<ol type="1">
<li>use the Environment window to view the dataset, what is the name and the label of the 26th column?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># the 26th column is ST062Q02TA</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="co"># the label is: "In the last two full weeks of school, how often: I [skipped] some classes"</span></span>
<span id="cb36-3"><a href="#cb36-3"></a></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="co"># you could use View() instead of the environment window, note the capital V</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="fu">View</span>(PISA_2022)</span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="co"># use could use the vector subset to fetch the 100th name</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="fu">names</span>(PISA_2022)[<span class="dv">26</span>]</span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="co"># [1] "ST062Q02JA"</span></span>
<span id="cb36-9"><a href="#cb36-9"></a></span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="co"># you could use the attr function to find the label</span></span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="fu">attr</span>(PISA_2022<span class="sc">$</span>ST062Q02TA, <span class="st">"label"</span>)</span>
<span id="cb36-12"><a href="#cb36-12"></a><span class="co">#  "In the last two full weeks of school, how often: I [skipped] some classes"</span></span>
<span id="cb36-13"><a href="#cb36-13"></a></span>
<span id="cb36-14"><a href="#cb36-14"></a><span class="co"># or using the dollar sign to load this field will also give the label</span></span>
<span id="cb36-15"><a href="#cb36-15"></a>PISA_2022<span class="sc">$</span>ST062Q02TA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Use the dollar sign <code>$</code> to return the column <code>ST004D01T</code>. What is stored in this column?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># Student (Standardized) Gender</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>PISA_2022<span class="sc">$</span>ST004D01T</span>
<span id="cb37-3"><a href="#cb37-3"></a></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="co">#  [1] Female Male   Male   Female Female Male   Male   Female Female Female Male  </span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="co">#  [12] Male   Male   Male   Female Female Male   Female Female Female Male   Male  </span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="co">#  [23] Male   Female Female Female Female Female Male   Female Male   Male   Male  </span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="co">#  [34] Female Female Male   Female Female Female Female Female Male   Female Male  </span></span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="co">#   [ reached getOption("max.print") -- omitted 612744 entries ]</span></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="co"># attr(,"label")</span></span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="co"># [1] Student (Standardized) Gender</span></span>
<span id="cb37-11"><a href="#cb37-11"></a><span class="co"># Levels: Female Male Valid Skip Not Applicable Invalid No Response</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>How many students results are in the whole table?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="fu">nrow</span>(PISA_2022)</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="co"># [1] 613744</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>What <code>unique</code> values does the dataset hold for Mother’s occupation <code>OCOD1</code> and Father’s occupation <code>OCOD2</code>? Which is larger?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">unique</span>(PISA_2022<span class="sc">$</span>OCOD1)</span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="fu">unique</span>(PISA_2022<span class="sc">$</span>OCOD2)</span>
<span id="cb39-3"><a href="#cb39-3"></a></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="co"># you can read the length from the above, or you could use the</span></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="co"># length command to tell you the length of the vector</span></span>
<span id="cb39-6"><a href="#cb39-6"></a></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="fu">length</span>(<span class="fu">unique</span>(PISA_2022<span class="sc">$</span>OCOD1))</span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="co"># [1] 590</span></span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="fu">length</span>(<span class="fu">unique</span>(PISA_2022<span class="sc">$</span>OCOD2))</span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="co"># [1] 590</span></span>
<span id="cb39-11"><a href="#cb39-11"></a></span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="co"># Both fields are the same size implying there are no jobs that women do, but men don't.</span></span>
<span id="cb39-13"><a href="#cb39-13"></a><span class="co"># to confirm this we can use the set difference command `setdiff(vector1, vector2)`.</span></span>
<span id="cb39-14"><a href="#cb39-14"></a></span>
<span id="cb39-15"><a href="#cb39-15"></a><span class="fu">setdiff</span>(<span class="fu">unique</span>(PISA_2022<span class="sc">$</span>OCOD1),</span>
<span id="cb39-16"><a href="#cb39-16"></a>        <span class="fu">unique</span>(PISA_2022<span class="sc">$</span>OCOD2))</span>
<span id="cb39-17"><a href="#cb39-17"></a><span class="co"># character(0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>What are the <code>max</code>imum, <code>mean</code>, <code>median</code> and <code>min</code>umum science grades <code>PV1SCIE</code> achieved by any student</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># remember to set the na.rm = TRUE</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="fu">max</span>(PISA_2022<span class="sc">$</span>PV1SCIE, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="co"># [1] 895.375</span></span>
<span id="cb40-4"><a href="#cb40-4"></a><span class="fu">mean</span>(PISA_2022<span class="sc">$</span>PV1SCIE, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb40-5"><a href="#cb40-5"></a><span class="co"># [1] 450.4625</span></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="fu">median</span>(PISA_2022<span class="sc">$</span>PV1SCIE, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="co"># [1] 444.464</span></span>
<span id="cb40-8"><a href="#cb40-8"></a><span class="fu">min</span>(PISA_2022<span class="sc">$</span>PV1SCIE, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb40-9"><a href="#cb40-9"></a><span class="co"># [1] 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="6" type="1">
<li>Explore the dataset and makes notes about the range of values of 2 other columns</li>
</ol>
</div>
</section>
<section id="piping-and-dplyr" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="piping-and-dplyr"><span class="header-section-number">1.2</span> “Piping and dplyr”</h2>
<p>Piping allows us to break down complex tasks into manageable chunks that can be written and tested one after another. There are several powerful commands in the tidyverse as part of the <em>dplyr</em> package that can help us <code>group</code>, <code>filter</code>, <code>select</code>, <code>mutate</code> and <code>summarise</code> datasets. With this small set of commands we can use piping to convert massive datasets into simple and useful results.</p>
<p>Using the pipe <code>%&gt;%</code> command, we can feed the results from one command into the next command making for reusable and easy to read code.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/pipe_drawing.svg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">how piping works</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The pipe command we are using <code>%&gt;%</code> is from the <em>magrittr</em> package which is installed alongside the tidyverse. Recently <em>R</em> introduced another pipe <code>|&gt;</code> which offers very similar functionality and tutorials online might use either. The examples below use the <code>%&gt;%</code> pipe.</p>
</div>
</div>
<p>Let’s look at an example of using the pipe on the <code>PISA_2022</code> table to calculate the best performing OECD countries for maths <code>PV1MATH</code> by gender <code>ST004D01T</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-17"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-17-1" class="code-annotation-target"><a href="#annotated-cell-17-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-17-2" class="code-annotation-target"><a href="#annotated-cell-17-2"></a>  <span class="fu">filter</span>(OECD <span class="sc">==</span> <span class="st">"Yes"</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-17-3" class="code-annotation-target"><a href="#annotated-cell-17-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-17-4" class="code-annotation-target"><a href="#annotated-cell-17-4"></a>  <span class="fu">summarise</span>(<span class="at">mean_maths =</span> <span class="fu">mean</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="annotated-cell-17-5"><a href="#annotated-cell-17-5"></a>            <span class="at">sd_maths =</span> <span class="fu">sd</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>),       </span>
<span id="annotated-cell-17-6"><a href="#annotated-cell-17-6"></a>            <span class="at">students =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span>                       </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-17-7" class="code-annotation-target"><a href="#annotated-cell-17-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-17-8" class="code-annotation-target"><a href="#annotated-cell-17-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mean_maths))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-17" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-cell="annotated-cell-17" data-code-annotation="1">line 1 passes the whole <code>PISA_2022</code> dataset and pipes it into the next line using <code>%&gt;%</code></span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-cell="annotated-cell-17" data-code-annotation="2">line 2 <code>filters</code> out any results that are from non-OECD countries by finding all the rows where <code>OECD</code> equals <code>==</code> “Yes”, this is then piped to the next line</span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-17" data-code-annotation="3">line 3 groups the data by country <code>CNT</code> and by student gender <code>ST004D01T</code>, this is then piped to the next line</span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="4" data-code-cell="annotated-cell-17" data-code-annotation="4">line 4-6 the <code>summarise</code> command performs a calculation on the country and gender groupings returning three new columns, each command is described by code on a new line and separated by a comma: the mean value for maths <code>mean_maths</code>, the standard deviation <code>sd_maths</code>, and a column telling us how many students were in each grouping using the <code>n()</code> which returns the number of rows in a group. These new columns and the grouping columns are then piped to the next line, all other columns are dropped</span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="7" data-code-cell="annotated-cell-17" data-code-annotation="5">line 7 filters out any gender <code>ST004D01T</code> that is <code>NA</code>. First is finds all the students that have <code>NA</code> as their gender by using <code>is.na(ST004D01T)</code>, then it <em>NOTs</em>/flips the result using the exclamation mark <code>!</code>, giving those students who don’t have their gender set to <code>NA</code>. The filtered data is then piped to the next line</span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="8" data-code-cell="annotated-cell-17" data-code-annotation="6">line 8, finally we <code>arrange</code>/sort the results in <code>desc</code>ending order by the <code>mean_maths</code> column. The default for arrange is <em>ascending</em> order, leave out the <code>desc(  )</code> for the numbers to be ordered in the opposite way.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 74 × 5
# Groups:   CNT [37]
   CNT            ST004D01T mean_maths sd_maths students
   &lt;fct&gt;          &lt;fct&gt;          &lt;dbl&gt;    &lt;dbl&gt;    &lt;int&gt;
 1 Japan          Male            540.     99.0     2856
 2 Korea          Male            534.    112.      3325
 3 Japan          Female          531.     88.1     2904
 4 Korea          Female          528.     99.1     3129
 5 Estonia        Male            515.     87.4     3272
 6 Switzerland    Male            511.     99.3     3540
 7 Estonia        Female          510.     81.5     3120
 8 Czech Republic Male            502.    100.      4232
 9 Switzerland    Female          501.     90.9     3289
10 Austria        Male            500.     94.5     3110
# ℹ 64 more rows</code></pre>
</div>
</div>
<p>Across the top few countries, Males get a slightly better maths score <code>PV1MATH</code> than Females, other scores are available, please read <strong>?@sec-PV</strong> to find out more about the limitations of using a “PV” value.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>we met the assignment command earlier <code>&lt;-</code>. Within the tidyverse commands we use the equals sign instead <code>=</code>.</p>
</div>
</div>
<p>The commands we have just used come from a package within the <code>tidyverse</code> called <code>dplyr</code>, let’s take a look at what they do:</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 46%">
<col style="width: 32%">
</colgroup>
<thead>
<tr class="header">
<th>command</th>
<th>purpose</th>
<th>example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>select</td>
<td>reduce the dataframe to the fields that you specify</td>
<td><code>select(&lt;field&gt;, &lt;field&gt;, &lt;field&gt;)</code></td>
</tr>
<tr class="even">
<td>filter</td>
<td>get rid of rows that don’t meet one or more criteria</td>
<td><code>filter(&lt;field&gt; &lt;comparison&gt;)</code></td>
</tr>
<tr class="odd">
<td>group</td>
<td>group fields together to perform calculations</td>
<td><code>group_by(&lt;field&gt;, &lt;field&gt;))</code></td>
</tr>
<tr class="even">
<td>mutate</td>
<td>add new fields or change values in current fields</td>
<td><code>mutate(&lt;new_field&gt; = &lt;field&gt; / 2)</code></td>
</tr>
<tr class="odd">
<td>summarise</td>
<td>create summary data optionally using a grouping command</td>
<td><code>summarise(&lt;new_field&gt; = max(&lt;field&gt;))</code></td>
</tr>
<tr class="even">
<td>arrange</td>
<td>order the results by one or more fields</td>
<td><code>arrange(desc(&lt;field&gt;))</code></td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to explore more of the functions of <code>dplyr</code>, take a look at the <a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">helpsheet</a></p>
</div>
</div>
<div class="question">
<p>Adjust the code above to find out the lowest performing countries for reading <code>PV1READ</code> by gender that are not in the OECD</p>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="fu">filter</span>(OECD <span class="sc">==</span> <span class="st">"No"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T) <span class="sc">%&gt;%</span> </span>
<span id="cb42-4"><a href="#cb42-4"></a>  <span class="fu">summarise</span>(<span class="at">mean_read =</span> <span class="fu">mean</span>(PV1READ, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb42-5"><a href="#cb42-5"></a>            <span class="at">sd_read =</span> <span class="fu">sd</span>(PV1READ, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb42-6"><a href="#cb42-6"></a>            <span class="at">students =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb42-7"><a href="#cb42-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="#cb42-8"></a>  <span class="fu">arrange</span>(mean_read)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
</section>
<section id="select" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> select</h1>
<p>The <code>PISA_2022</code> dataset has far too many fields, to reduce the number of fields to focus on just a few of them we can use <code>select</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">select</span>(CNT,ESCS, ST004D01T, ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 4
   CNT       ESCS ST004D01T ST003D02T
   &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;    
 1 Albania  1.11  Female    May      
 2 Albania -3.05  Male      February 
 3 Albania -0.187 Male      August   
 4 Albania -3.22  Female    July     
 5 Albania -1.05  Female    January  
 6 Albania  1.09  Male      May      
 7 Albania -0.762 Male      May      
 8 Albania -1.02  Female    December 
 9 Albania -1.17  Female    August   
10 Albania  0.286 Female    September
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>You might also be in the situation where you want to select everything but one or two fields, you can do this with the negative signal <code>-</code>, the below code returns all the fields <em>except</em> <code>CNT</code> and <code>OECD</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>CNT, <span class="sc">-</span>OECD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 80
   CNTSCHID CNTSTUID REGION  LANGTEST_QQQ ST003D02T ST003D03T ST004D01T
      &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt;        &lt;fct&gt;     &lt;fct&gt;     &lt;fct&gt;    
 1   800282   800001 Albania Albanian     May       2006      Female   
 2   800115   800002 Albania Albanian     February  2006      Male     
 3   800242   800003 Albania Albanian     August    2006      Male     
 4   800245   800005 Albania Albanian     July      2006      Female   
 5   800285   800006 Albania Albanian     January   2006      Female   
 6   800172   800007 Albania Albanian     May       2006      Male     
 7   800082   800008 Albania Albanian     May       2006      Male     
 8   800274   800009 Albania Albanian     December  2006      Female   
 9   800057   800010 Albania Albanian     August    2006      Female   
10   800132   800012 Albania Albanian     September 2006      Female   
# ℹ 613,734 more rows
# ℹ 73 more variables: ST250Q01JA &lt;fct&gt;, ST250Q02JA &lt;fct&gt;, ST250Q03JA &lt;fct&gt;,
#   ST250Q05JA &lt;fct&gt;, ST251Q01JA &lt;fct&gt;, ST251Q06JA &lt;fct&gt;, ST251Q07JA &lt;fct&gt;,
#   ST253Q01JA &lt;fct&gt;, ST254Q01JA &lt;fct&gt;, ST254Q02JA &lt;fct&gt;, ST254Q03JA &lt;fct&gt;,
#   ST254Q04JA &lt;fct&gt;, ST254Q05JA &lt;fct&gt;, ST254Q06JA &lt;fct&gt;, ST255Q01JA &lt;fct&gt;,
#   ST256Q02JA &lt;fct&gt;, ST005Q01JA &lt;fct&gt;, ST007Q01JA &lt;fct&gt;, ST019AQ01T &lt;fct&gt;,
#   ST019BQ01T &lt;fct&gt;, ST019CQ01T &lt;fct&gt;, ST125Q01NA &lt;fct&gt;, ST261Q01JA &lt;fct&gt;, …</code></pre>
</div>
</div>
<p>You might find that you have a vector of column names that you want to select, to do this, we can use the <code>any_of</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>my_fields <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CNT"</span>, <span class="st">"CNTSCHID"</span>, <span class="st">"ST004D01T"</span>)</span>
<span id="cb47-2"><a href="#cb47-2"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">any_of</span>(my_fields))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 3
   CNT     CNTSCHID ST004D01T
   &lt;fct&gt;      &lt;dbl&gt; &lt;fct&gt;    
 1 Albania   800282 Female   
 2 Albania   800115 Male     
 3 Albania   800242 Male     
 4 Albania   800245 Female   
 5 Albania   800285 Female   
 6 Albania   800172 Male     
 7 Albania   800082 Male     
 8 Albania   800274 Female   
 9 Albania   800057 Female   
10 Albania   800132 Female   
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>With hundreds of fields available, you might want to focus on fields whose names match a certain pattern, to do this you can use <code>starts_with</code>, <code>ends_with</code>, <code>contains</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># country of birth of student, and father and mother are recorded in ST019___</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"ST019"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 3
   ST019AQ01T      ST019BQ01T      ST019CQ01T     
   &lt;fct&gt;           &lt;fct&gt;           &lt;fct&gt;          
 1 Country of test Country of test Country of test
 2 Country of test Country of test Country of test
 3 Other country   Country of test Country of test
 4 Country of test Country of test Country of test
 5 Country of test Country of test Country of test
 6 Country of test Country of test Country of test
 7 Country of test Country of test Country of test
 8 Country of test Country of test Country of test
 9 Country of test Country of test Country of test
10 Country of test Country of test Country of test
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>When you come to building your statistical models you often need to use <em>numeric</em> data, you can find the columns that have only numbers in them by the following. Be warned though, sometimes there are numeric fields which have a few words in them, so R treats them as characters. Use the PISA <a href="https://webfs.oecd.org/pisa2022/CY08MSP_CODEBOOK_5thDecember23.xlsx">codebook</a> to help work out where those numbers are.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">where</span>(is.numeric)) <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "CNTSCHID"   "CNTSTUID"   "ST016Q01NA" "WB151Q01HA" "WB152Q01HA"
 [6] "WB156Q01HA" "BELONG"     "DISCLIM"    "HOMEPOS"    "ESCS"      
[11] "ATTCONFM"   "ICTEFFIC"   "STUBMI"     "PQMIMP"     "PARINVOL"  
[16] "PV1MATH"    "PV1READ"    "PV1SCIE"   </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you do want to change the type of a column to numeric you are going to need to:</p>
<ul>
<li><code>filter</code> out any offending rows, and</li>
<li><code>mutate</code> the column to be numeric: <code>col = as.numeric(col)</code></li>
</ul>
</div>
</div>
<section id="questions-1" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="questions-1"><span class="header-section-number">2.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the three errors with the following <code>select</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>PISA_2022 </span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">select</span>(CNT BELONG) <span class="sc">%&gt;%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>PISA_2022 <span class="sc">%&gt;%</span>  <span class="co">#1 missing pipe</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>  <span class="fu">select</span>(CNT, BELONG) <span class="co">#2 no comma between column names, #3 stray pipe on end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Write a <code>select</code> statement to display the month <code>ST003D02T</code> and year of birth <code>ST003D03T</code> and the gender <code>ST004D01T</code> of each student.</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb55-2"><a href="#cb55-2"></a>  <span class="fu">select</span>(ST003D02T, ST003D03T, ST004D01T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Write a <code>select</code> statement to show all the fields that are to do with well being and health, e.g.&nbsp;<code>WB150Q01HA</code> “How is your health?”</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb56-2"><a href="#cb56-2"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"WB15"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>[EXTENSION] Adjust your answer to Q3 so that you select the gender <code>ST004D01T</code> and the ID <code>CNTSTUID</code> of each student in addition to the <code>ST254____</code> fields looking at digital devices in the home:</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="#cb57-2"></a>  <span class="fu">select</span>(CNTSTUID, ST004D01T, <span class="fu">starts_with</span>(<span class="st">"ST254"</span>)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
</section>
<section id="filter" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> filter</h1>
<p>Not only does the <code>PISA_2022</code> dataset have a huge number of columns, it has hundred of thousands of rows. We want to <code>filter</code> this down to the students that we are interested in, i.e.&nbsp;filter out data that isn’t useful for our analysis. If we only wanted the results that were <code>Male</code>, we could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb58-2"><a href="#cb58-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb58-3"><a href="#cb58-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 307,906 × 5
   CNT       ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Albania -3.05  Male      February     308.
 2 Albania -0.187 Male      August       268.
 3 Albania  1.09  Male      May          534.
 4 Albania -0.762 Male      May          382.
 5 Albania -1.98  Male      October      425.
 6 Albania  0.063 Male      April        463.
 7 Albania -0.170 Male      May          236.
 8 Albania -2.58  Male      August       327.
 9 Albania -1.09  Male      March        326.
10 Albania -0.334 Male      October      428.
# ℹ 307,896 more rows</code></pre>
</div>
</div>
<p>We can combine <code>filter</code> commands to look for <code>Males</code> born in <code>September</code> and where the <code>PV1MATH</code> figure is greater than <code>750</code>. We can list multiple criteria in the filter by separating the criteria with commas, using commas mean that all of these criteria need to be <code>TRUE</code> for a row to be returned. A comma in a filter is the equivalent of an <code>AND</code>, :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb60-2"><a href="#cb60-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb60-3"><a href="#cb60-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb60-4"><a href="#cb60-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span>,</span>
<span id="cb60-5"><a href="#cb60-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 52 × 5
   CNT             ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;          &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Australia      0.994 Male      September    770.
 2 Australia      0.837 Male      September    758.
 3 Australia      1.22  Male      September    807.
 4 Canada         1.06  Male      September    752.
 5 Canada         1.04  Male      September    788.
 6 Canada         1.21  Male      September    781.
 7 Canada         0.804 Male      September    750.
 8 Chinese Taipei 0.842 Male      September    753.
 9 Chinese Taipei 0.488 Male      September    794.
10 Chinese Taipei 1.23  Male      September    794.
# ℹ 42 more rows</code></pre>
</div>
</div>
<p>You can also write it as an ampersand <code>&amp;</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb62-2"><a href="#cb62-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb62-3"><a href="#cb62-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span> <span class="sc">&amp;</span></span>
<span id="cb62-4"><a href="#cb62-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span> <span class="sc">&amp;</span></span>
<span id="cb62-5"><a href="#cb62-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember to include the <code>==</code> sign when looking to filter on equality; additionally, you can use <code>!=</code> (not equals), <code>&gt;=</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&lt;</code>.</p>
<p>Remember matching is case sensitive, “september” <code>!=</code> “September”</p>
</div>
</div>
<p>Rather than just looking at September born students, we want to find all the students born in the Autumn term. But if we add a couple more criteria on <code>ST003D02T</code> nothing is returned! Why?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="#cb63-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb63-4"><a href="#cb63-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span>,</span>
<span id="cb63-5"><a href="#cb63-5"></a>         ST003D02T <span class="sc">==</span> <span class="st">"October"</span>,</span>
<span id="cb63-6"><a href="#cb63-6"></a>         ST003D02T <span class="sc">==</span> <span class="st">"November"</span>,</span>
<span id="cb63-7"><a href="#cb63-7"></a>         ST003D02T <span class="sc">==</span> <span class="st">"December"</span>,</span>
<span id="cb63-8"><a href="#cb63-8"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 5
# ℹ 5 variables: CNT &lt;fct&gt;, ESCS &lt;dbl&gt;, ST004D01T &lt;fct&gt;, ST003D02T &lt;fct&gt;,
#   PV1MATH &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The reason is R is looking for individual students born in September <code>AND</code> October <code>AND</code> November <code>AND</code> December. As a student can only have one birth month there are no students that meet this criteria. We need to use <code>OR</code> :</p>
<p>To create an <code>OR</code> in a filter we use the bar <code>|</code> character, the below looks for all students who are “Male” <code>AND</code> were born in “September” <code>OR</code> “October” <code>OR</code> “November” <code>OR</code> “December”, <code>AND</code> have a <code>PV1MATH</code> &gt; 750.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb65-2"><a href="#cb65-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb65-4"><a href="#cb65-4"></a>         (ST003D02T <span class="sc">==</span> <span class="st">"September"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"October"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"November"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"December"</span>),</span>
<span id="cb65-5"><a href="#cb65-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 194 × 5
   CNT        ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;     &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Australia 0.994 Male      September    770.
 2 Australia 1.03  Male      October      808.
 3 Australia 1.30  Male      October      762.
 4 Australia 1.21  Male      November     764.
 5 Australia 0.837 Male      September    758.
 6 Australia 1.22  Male      September    807.
 7 Belgium   0.746 Male      December     770.
 8 Belgium   0.939 Male      December     779.
 9 Belgium   1.25  Male      November     832.
10 Belgium   1.11  Male      October      776.
# ℹ 184 more rows</code></pre>
</div>
</div>
<p>It’s neater, maybe, to use the <code>%in%</code> command, which checks to see if the value in a column is present in a vector, this can mimic the <code>OR</code>/<code>|</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb67-2"><a href="#cb67-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb67-4"><a href="#cb67-4"></a>         ST003D02T <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"September"</span>, <span class="st">"October"</span>, <span class="st">"November"</span>, <span class="st">"December"</span>),</span>
<span id="cb67-5"><a href="#cb67-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>When building filters you need to know the range of values that a column can take, we can do this in several ways:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="co"># show the possible levels</span></span>
<span id="cb68-2"><a href="#cb68-2"></a><span class="fu">levels</span>(PISA_2022<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "January"        "February"       "March"          "April"         
 [5] "May"            "June"           "July"           "August"        
 [9] "September"      "October"        "November"       "December"      
[13] "Valid Skip"     "Not Applicable" "Invalid"        "No Response"   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="co"># show the actual unique values in a field</span></span>
<span id="cb70-2"><a href="#cb70-2"></a><span class="co"># this might be a slightly smaller set of values</span></span>
<span id="cb70-3"><a href="#cb70-3"></a><span class="fu">unique</span>(PISA_2022<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] May       February  August    July      January   December  September
 [8] October   April     March     June      November  &lt;NA&gt;     
16 Levels: January February March April May June July August ... No Response</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># You might also want to read the label of a field</span></span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="fu">attr</span>(PISA_2022<span class="sc">$</span>ST003D02T, <span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Student (Standardized) Birth - Month"</code></pre>
</div>
</div>
</div>
</div>
<section id="questions-2" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="questions-2"><span class="header-section-number">3.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the <strong>two</strong> errors with the following <code>select</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a>PISA_2022</span>
<span id="cb74-2"><a href="#cb74-2"></a>  <span class="fu">select</span>(CNT, PV1READ) <span class="sc">%&gt;%</span></span>
<span id="cb74-3"><a href="#cb74-3"></a>  <span class="fu">filter</span>(<span class="at">CNT =</span> <span class="st">"Finland"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a>PISA_2022 <span class="sc">%&gt;%</span>  <span class="co">#1 missing pipe command</span></span>
<span id="cb75-2"><a href="#cb75-2"></a>  <span class="fu">select</span>(CNT, PV1READ) <span class="sc">%&gt;%</span></span>
<span id="cb75-3"><a href="#cb75-3"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Finland"</span>) <span class="co">#2 you need a double equals</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Use <code>filter</code> to find all the students with <code>PV1READ</code> grade equal to 333.</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2"></a>  <span class="fu">filter</span>(PV1READ <span class="sc">==</span> <span class="dv">333</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Use <code>filter</code> to find all the students with <code>PV1READ</code>, <code>PV1SCIE</code>, and <code>PV1MATH</code> grades over 800.</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb77-2"><a href="#cb77-2"></a>  <span class="fu">filter</span>(PV1READ <span class="sc">&gt;</span> <span class="dv">800</span>,</span>
<span id="cb77-3"><a href="#cb77-3"></a>         PV1SCIE <span class="sc">&gt;</span> <span class="dv">800</span>,</span>
<span id="cb77-4"><a href="#cb77-4"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">800</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Spot the <strong>three</strong> errors with the following <code>select</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb78-2"><a href="#cb78-2"></a>  <span class="fu">select</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3"></a>  <span class="fu">filter</span>(CNT <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"belgium"</span>)</span>
<span id="cb78-4"><a href="#cb78-4"></a>         ESCS <span class="sc">&lt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb79-2"><a href="#cb79-2"></a>  <span class="fu">select</span>(CNT, ESCS) <span class="sc">%&gt;%</span> <span class="co">#1 you have ESCS in the filter, it needs to be in the select as well</span></span>
<span id="cb79-3"><a href="#cb79-3"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"Belgium"</span>), <span class="co">#2 Belgium needs a capital letter</span></span>
<span id="cb79-4"><a href="#cb79-4"></a>                                          <span class="co">#3 the %in% command needs percentages</span></span>
<span id="cb79-5"><a href="#cb79-5"></a>                                          <span class="co">#4 you need a comma (or &amp;) at the end of the line</span></span>
<span id="cb79-6"><a href="#cb79-6"></a>         ESCS <span class="sc">&lt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>Use <code>filter</code> to find all the students with <code>Three or more</code> cars in their home <code>ST251Q01JA</code>. How does this compare to those with no <code>None</code> cars?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a><span class="co"># cars 3+ </span></span>
<span id="cb80-2"><a href="#cb80-2"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb80-3"><a href="#cb80-3"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb80-4"><a href="#cb80-4"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"Three or more"</span>)</span>
<span id="cb80-5"><a href="#cb80-5"></a></span>
<span id="cb80-6"><a href="#cb80-6"></a><span class="co"># cars 0</span></span>
<span id="cb80-7"><a href="#cb80-7"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb80-8"><a href="#cb80-8"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb80-9"><a href="#cb80-9"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"None"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="6" type="1">
<li>Adjust your code in Q2. to find the number of students with <code>Three or more</code> cars in their home <code>ST251Q01JA</code> in <code>Italy</code>, how does this compare with <code>Spain</code>?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb81-2"><a href="#cb81-2"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb81-3"><a href="#cb81-3"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"Three or more"</span>,</span>
<span id="cb81-4"><a href="#cb81-4"></a>         CNT <span class="sc">==</span> <span class="st">"Italy"</span>)</span>
<span id="cb81-5"><a href="#cb81-5"></a></span>
<span id="cb81-6"><a href="#cb81-6"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb81-7"><a href="#cb81-7"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb81-8"><a href="#cb81-8"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"Three or more"</span>,</span>
<span id="cb81-9"><a href="#cb81-9"></a>         CNT <span class="sc">==</span> <span class="st">"Spain"</span>)</span>
<span id="cb81-10"><a href="#cb81-10"></a></span>
<span id="cb81-11"><a href="#cb81-11"></a><span class="co"># EXTENSION:</span></span>
<span id="cb81-12"><a href="#cb81-12"></a><span class="co"># Note we would need to know the percentage of students </span></span>
<span id="cb81-13"><a href="#cb81-13"></a><span class="co"># in each country with that number of cars to make a proper</span></span>
<span id="cb81-14"><a href="#cb81-14"></a><span class="co"># comparison. Spain might have more students taking the PISA</span></span>
<span id="cb81-15"><a href="#cb81-15"></a><span class="co"># test than Italy, or vice-versa</span></span>
<span id="cb81-16"><a href="#cb81-16"></a></span>
<span id="cb81-17"><a href="#cb81-17"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb81-18"><a href="#cb81-18"></a>  <span class="fu">select</span>(CNT, ST251Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb81-19"><a href="#cb81-19"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Italy"</span>, <span class="st">"Spain"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb81-20"><a href="#cb81-20"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb81-21"><a href="#cb81-21"></a>  <span class="fu">mutate</span>(<span class="at">total_stus =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb81-22"><a href="#cb81-22"></a>  <span class="fu">filter</span>(ST251Q01JA <span class="sc">==</span> <span class="st">"Three or more"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb81-23"><a href="#cb81-23"></a>  <span class="fu">summarise</span>(<span class="at">three_more =</span> <span class="fu">n</span>(),</span>
<span id="cb81-24"><a href="#cb81-24"></a>            <span class="at">per_three_more =</span> three_more<span class="sc">/</span><span class="fu">unique</span>(total_stus))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="7" type="1">
<li>Write a <code>filter</code> to create a table for the number of <code>Female</code> students with reading <code>PV1READ</code> scores lower than 400 in the <code>United Kingdom</code>, store the result as <code>read_low_female</code>, repeat but for <code>Male</code> students and store as <code>read_low_male</code>. Use <code>nrow()</code> to work out if there are more males or females with a low reading score in the UK</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a>read_low_female <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb82-2"><a href="#cb82-2"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb82-3"><a href="#cb82-3"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb82-4"><a href="#cb82-4"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Female"</span>)</span>
<span id="cb82-5"><a href="#cb82-5"></a></span>
<span id="cb82-6"><a href="#cb82-6"></a>read_low_male <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb82-7"><a href="#cb82-7"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb82-8"><a href="#cb82-8"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb82-9"><a href="#cb82-9"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>)</span>
<span id="cb82-10"><a href="#cb82-10"></a></span>
<span id="cb82-11"><a href="#cb82-11"></a><span class="fu">nrow</span>(read_low_female)</span>
<span id="cb82-12"><a href="#cb82-12"></a><span class="fu">nrow</span>(read_low_male)</span>
<span id="cb82-13"><a href="#cb82-13"></a></span>
<span id="cb82-14"><a href="#cb82-14"></a><span class="co"># You could also pipe the whole dataframe into nrow()</span></span>
<span id="cb82-15"><a href="#cb82-15"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb82-16"><a href="#cb82-16"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb82-17"><a href="#cb82-17"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb82-18"><a href="#cb82-18"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Female"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb82-19"><a href="#cb82-19"></a>  <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="8" type="1">
<li>How many students in the United Kingdom had no television <code>ST254Q01JA</code> <em>OR</em> no connection to the internet <code>ST250Q05JA</code>. <strong>HINT</strong>: use <code>levels(PISA_2022$ST254Q01JA)</code> to look at the levels available for each column.</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>, </span>
<span id="cb83-2"><a href="#cb83-2"></a>                     ST254Q01JA <span class="sc">==</span> <span class="st">"None"</span> <span class="sc">|</span></span>
<span id="cb83-3"><a href="#cb83-3"></a>                     ST250Q05JA <span class="sc">==</span> <span class="st">"None"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="9" type="1">
<li>Which countr[y|ies] had students with <code>NA</code> for Gender, remember to check for <code>NA</code> using <code>is.na()</code>?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb84-2"><a href="#cb84-2"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<span id="cb84-3"><a href="#cb84-3"></a>  <span class="fu">select</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb84-4"><a href="#cb84-4"></a>  <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
</section>
<section id="sec-renaming" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> renaming columns</h1>
<p>Very often when dealing with datasets such as PISA or TIMSS, the column names can be very confusing without a reference key, e.g.&nbsp;<code>ST004D01T</code>, <code>OCOD3</code> and <code>ST261Q04JA</code>. To rename columns in the tidyverse we use the <code>rename(&lt;new_name&gt; = &lt;old_name&gt;)</code> command. For example, if you wanted to rename the rather confusingly named student column for <em>gender</em>, also known as <code>ST004D01T</code>, and the column for having a <em>having enough digital resources</em> in school, also known as <code>IC172Q01JA</code>, you could use:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb85-2"><a href="#cb85-2"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T,</span>
<span id="cb85-3"><a href="#cb85-3"></a>         <span class="at">dig_resources =</span> IC172Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb85-4"><a href="#cb85-4"></a>  <span class="fu">select</span>(CNT, gender, dig_resources) <span class="sc">%&gt;%</span> </span>
<span id="cb85-5"><a href="#cb85-5"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   CNT                    gender      
 Spain               : 30800   Female        :305759  
 United Arab Emirates: 24600   Male          :307906  
 Canada              : 23073   Valid Skip    :     0  
 Kazakhstan          : 19769   Not Applicable:     0  
 Indonesia           : 13439   Invalid       :     0  
 Australia           : 13437   No Response   :     0  
 (Other)             :488626   NA's          :    79  
           dig_resources   
 Agree            :183233  
 Disagree         : 70595  
 Strongly agree   : 49276  
 Strongly disagree: 35223  
 Valid Skip       :     0  
 (Other)          :     0  
 NA's             :275417  </code></pre>
</div>
</div>
<p>If you want to change the name of the column so that it stays when you need to perform another calculation, remember to <em>assign</em> the renamed dataframe back to the original dataframe. But be warned, you’ll need to reload the full dataset to restore the original names:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>PISA_2022 <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb87-2"><a href="#cb87-2"></a>    <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T,</span>
<span id="cb87-3"><a href="#cb87-3"></a>           <span class="at">dig_resources =</span> IC172Q01JA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="group_by-and-summarise" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> group_by and summarise</h1>
<p>So far we have looked at ways to return rows that meet certain criteria. Using <code>group_by</code> and <code>summarise</code> we can start to analyse data for different groups of students. For example, let’s look at the number of students who don’t have internet connections at home besides a mobile phone <code>ST250Q05JA</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-31"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-31" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-31-1" class="code-annotation-target"><a href="#annotated-cell-31-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-31" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-31-2" class="code-annotation-target"><a href="#annotated-cell-31-2"></a>  <span class="fu">group_by</span>(ST250Q05JA) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-31" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-31-3" class="code-annotation-target"><a href="#annotated-cell-31-3"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>())</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-31" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-cell="annotated-cell-31" data-code-annotation="1">Line 1 passes the full <code>PISA_2022</code> to the pipe</span>
</dd>
<dt data-target-cell="annotated-cell-31" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-cell="annotated-cell-31" data-code-annotation="2">Line 2 makes groups within <code>PISA_2022</code> using the unique values of <code>ST250Q05JA</code></span>
</dd>
<dt data-target-cell="annotated-cell-31" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-31" data-code-annotation="3">Line 3, these groups are then passed to <code>summarise</code>, which creates a new column called <code>student_n</code> and stores the number of rows in each <code>ST250Q05JA</code> group using the <code>n()</code> command. <code>summarise</code> only returns the columns it creates, or are in the <code>group_by</code>, everything else is discarded.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  ST250Q05JA student_n
  &lt;fct&gt;          &lt;int&gt;
1 Yes           525842
2 No             56968
3 &lt;NA&gt;           30934</code></pre>
</div>
</div>
<p>What we might want to do is look at this data from a country by country perspective, by adding another field to the <code>group_by()</code> command, we then group by the unique combination of countries <code>CNT</code> and internet access <code>ST250Q05JA</code>, e.g.&nbsp;Albania + Yes; Albania + No; Albania + NA; United Arab Emirates + Yes; etc</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a>int_by_cnt <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb89-2"><a href="#cb89-2"></a>  <span class="fu">group_by</span>(CNT, ST250Q05JA) <span class="sc">%&gt;%</span></span>
<span id="cb89-3"><a href="#cb89-3"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>())</span>
<span id="cb89-4"><a href="#cb89-4"></a></span>
<span id="cb89-5"><a href="#cb89-5"></a><span class="fu">print</span>(int_by_cnt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 238 × 3
# Groups:   CNT [80]
   CNT                  ST250Q05JA student_n
   &lt;fct&gt;                &lt;fct&gt;          &lt;int&gt;
 1 Albania              Yes             4693
 2 Albania              No               535
 3 Albania              &lt;NA&gt;             901
 4 United Arab Emirates Yes            22206
 5 United Arab Emirates No              1116
 6 United Arab Emirates &lt;NA&gt;            1278
 7 Argentina            Yes            10484
 8 Argentina            No               938
 9 Argentina            &lt;NA&gt;             689
10 Australia            Yes            12808
# ℹ 228 more rows</code></pre>
</div>
</div>
<p><code>summarise</code> can also be used to work out statistics by grouping. For example, if you wanted to find out the <code>max</code>, <code>mean</code> and <code>min</code> science grade <code>PV1SCIE</code> by country <code>CNT</code>, you could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb91-2"><a href="#cb91-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb91-3"><a href="#cb91-3"></a>  <span class="fu">summarise</span>(<span class="at">sci_max  =</span> <span class="fu">max</span>(PV1SCIE,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb91-4"><a href="#cb91-4"></a>            <span class="at">sci_mean =</span> <span class="fu">mean</span>(PV1SCIE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb91-5"><a href="#cb91-5"></a>            <span class="at">sci_min  =</span> <span class="fu">min</span>(PV1SCIE,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 4
   CNT                  sci_max sci_mean sci_min
   &lt;fct&gt;                  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1 Albania                 724.     376.    74.6
 2 United Arab Emirates    842.     436.     0  
 3 Argentina               751.     415.   128. 
 4 Australia               875.     508.   108. 
 5 Austria                 804.     494.   170. 
 6 Belgium                 792.     495.   169. 
 7 Bulgaria                728.     422.   130. 
 8 Brazil                  784.     406.   106. 
 9 Brunei Darussalam       762.     445.   135. 
10 Canada                  893.     499.   107. 
# ℹ 70 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>group_by()</code> can have unintended consequences in your code if you are saving your pipes to new dataframes. To be safe your can clear any grouping by adding: <code>my_data %&gt;% ungroup()</code></p>
</div>
</div>
<section id="questions-3" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="questions-3"><span class="header-section-number">5.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the <strong>three</strong> errors with the following <code>summarise</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb93-2"><a href="#cb93-2"></a>  <span class="fu">group</span>(CNT)</span>
<span id="cb93-3"><a href="#cb93-3"></a>  <span class="fu">summarise</span>(<span class="at">num_stus =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb94-2"><a href="#cb94-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span> <span class="co">#1 group_by NOT group #2 missing pipe %&gt;%</span></span>
<span id="cb94-3"><a href="#cb94-3"></a>  <span class="fu">summarise</span>(<span class="at">num_stus =</span> <span class="fu">n</span>()) <span class="co">#3 = n() not = n</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Write a <code>group_by</code> and <code>summarise</code> statement to work out the <code>mean</code> and <code>median</code> cultural capital value <code>ESCS</code> for each student by country <code>CNT</code></li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb95-2"><a href="#cb95-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb95-3"><a href="#cb95-3"></a>  <span class="fu">summarise</span>(<span class="at">escs_mean =</span> <span class="fu">mean</span>(ESCS, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb95-4"><a href="#cb95-4"></a>            <span class="at">escs_median =</span> <span class="fu">median</span>(ESCS, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Using <code>summarise</code> work out, <code>Yes</code> or <code>No</code>, by country <code>CNT</code> and gender <code>ST004D01T</code>, whether students “Agree/disagree: There are enough [digital resources] for every student at my school” <code>IC172Q01JA</code>. Filter out any <code>NA</code> values on <code>IC172Q01JA</code>:</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb96-2"><a href="#cb96-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(IC172Q01JA)) <span class="sc">%&gt;%</span></span>
<span id="cb96-3"><a href="#cb96-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T, IC172Q01JA) <span class="sc">%&gt;%</span> </span>
<span id="cb96-4"><a href="#cb96-4"></a>  <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
</section>
<section id="sec-mutate" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> mutate</h1>
<p>Sometimes you will want to adjust the values stored in a field, e.g.&nbsp;converting a distance in miles into kilometres; or compute a new fields based on other fields, e.g.&nbsp;working out a total grade given the parts of a test. To do this we can use <code>mutate</code>. Unlike <code>summarise</code>, <code>mutate</code> retains all the other columns either adding a new column or changing an existing one</p>
<blockquote class="blockquote">
<p><code>mutate(&lt;field&gt; = &lt;field_calculation&gt;)</code></p>
</blockquote>
<p>The <code>PISA_2022</code> dataset has results for maths <code>PV1MATH</code>, science <code>PV1SCIE</code> and reading <code>PV1READ</code>. We could combine these to create an overall <code>PISA_grade</code>, and <code>PISA_mean</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-34"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-34-1"><a href="#annotated-cell-34-1"></a>PISA_2022 <span class="sc">%&gt;%</span>                                       </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-34-2" class="code-annotation-target"><a href="#annotated-cell-34-2"></a>  <span class="fu">mutate</span>(<span class="at">PV1_total =</span> PV1MATH <span class="sc">+</span> PV1SCIE <span class="sc">+</span> PV1READ,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-34-3" class="code-annotation-target"><a href="#annotated-cell-34-3"></a>         <span class="at">PV1_mean =</span> PV1_total<span class="sc">/</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-34-4" class="code-annotation-target"><a href="#annotated-cell-34-4"></a>  <span class="fu">select</span>(CNT, ST004D01T, ESCS, PV1_total, PV1_mean)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-34" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="2" data-code-cell="annotated-cell-34" data-code-annotation="1"><code>mutate</code> creates a new field called <code>PV1_total</code> made up by adding together the columns for maths, science and reading. Each column acts like a vector and adding them together is the equivalent of adding each students individual grades together, row by row. See <strong>?@sec-vectors</strong> for more details on vector addition.</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-34" data-code-annotation="2">inside the same <code>mutate</code> statement, we take the <code>PV1_total</code> calculated on line two and divide it by 3, to give us a mean value, this is then assigned to a new column, <code>PV1_mean</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4" data-code-cell="annotated-cell-34" data-code-annotation="3">this line <code>select</code>s only the fields that we are interested in, dropping the others</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 5
   CNT     ST004D01T   ESCS PV1_total PV1_mean
   &lt;fct&gt;   &lt;fct&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 Albania Female     1.11       763.     254.
 2 Albania Male      -3.05       882.     294.
 3 Albania Male      -0.187      911.     304.
 4 Albania Female    -3.22       809.     270.
 5 Albania Female    -1.05      1335.     445.
 6 Albania Male       1.09      1464.     488.
 7 Albania Male      -0.762     1115.     372.
 8 Albania Female    -1.02       904.     301.
 9 Albania Female    -1.17      1145.     382.
10 Albania Female     0.286     1235.     412.
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>We can use <code>mutate</code> to create subsets of data in fields. For example, if we wanted to see how many students in each country were high performing readers, specified by getting a reading grade of greater than <code>550</code>, we could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-35"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-35-1"><a href="#annotated-cell-35-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-35" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-35-2" class="code-annotation-target"><a href="#annotated-cell-35-2"></a>  <span class="fu">mutate</span>(<span class="at">PV1READ_high =</span> PV1READ <span class="sc">&gt;</span> <span class="dv">550</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-35" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-35-3" class="code-annotation-target"><a href="#annotated-cell-35-3"></a>  <span class="fu">group_by</span>(CNT, PV1READ_high) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-35" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-35-4" class="code-annotation-target"><a href="#annotated-cell-35-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-35" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-cell="annotated-cell-35" data-code-annotation="2">this line creates a new column called <code>PV1READ_high</code> for every students, storing a boolean value, <code>TRUE</code> or <code>FALSE</code> depending on whether their reading grates <code>PV1READ</code> &gt; 550.</span>
</dd>
<dt data-target-cell="annotated-cell-35" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-35" data-code-annotation="3">a grouping is made on the country and the new field <code>PV1READ_high</code>, e.g.&nbsp;Albania + TRUE, Albania + FALSE, etc.</span>
</dd>
<dt data-target-cell="annotated-cell-35" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="4" data-code-cell="annotated-cell-35" data-code-annotation="4">using summarise we can find the number of student rows in each grouping using <code>n()</code>, and drop all the other fields</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 159 × 3
# Groups:   CNT [80]
   CNT                  PV1READ_high     n
   &lt;fct&gt;                &lt;lgl&gt;        &lt;int&gt;
 1 Albania              FALSE         6055
 2 Albania              TRUE            74
 3 United Arab Emirates FALSE        20711
 4 United Arab Emirates TRUE          3889
 5 Argentina            FALSE        11197
 6 Argentina            TRUE           914
 7 Australia            FALSE         9005
 8 Australia            TRUE          4432
 9 Austria              FALSE         4461
10 Austria              TRUE          1690
# ℹ 149 more rows</code></pre>
</div>
</div>
<p>Comparisons can also be made between different columns, if we wanted to find out the percentage of Males and Females that got a better grade in their maths test <code>PV1MATH</code> than in their reading test <code>PV1READ</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-36"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-36-1"><a href="#annotated-cell-36-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-36-2" class="code-annotation-target"><a href="#annotated-cell-36-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> PV1MATH <span class="sc">&gt;</span> PV1READ) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-36-3" class="code-annotation-target"><a href="#annotated-cell-36-3"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-36-4" class="code-annotation-target"><a href="#annotated-cell-36-4"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-36-5" class="code-annotation-target"><a href="#annotated-cell-36-5"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-36-6" class="code-annotation-target"><a href="#annotated-cell-36-6"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-36-7" class="code-annotation-target"><a href="#annotated-cell-36-7"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-36-8" class="code-annotation-target"><a href="#annotated-cell-36-8"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-36-9" class="code-annotation-target"><a href="#annotated-cell-36-9"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-36" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-cell="annotated-cell-36" data-code-annotation="2"><code>mutate</code> creates a new field called <code>maths_better</code> made up by comparing the <code>PV1MATH</code> grade with <code>PV1READ</code> and creating a boolean/logical vector for the column.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-36" data-code-annotation="3"><code>select</code>s a subset of the columns</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="4" data-code-cell="annotated-cell-36" data-code-annotation="4"><code>filter</code>s out any students that don’t have gender data <code>ST004D01T</code> <em>and</em> where the calculation on line 2 failed, i.e.&nbsp;<code>PV1MATH</code> or <code>PV1READ</code> was <code>NA</code></span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="5" data-code-cell="annotated-cell-36" data-code-annotation="5"><code>group</code> on the gender of the student</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="6" data-code-cell="annotated-cell-36" data-code-annotation="6">using the <code>group</code> on line 5, use <code>mutate</code> to calculate the total number of Males and Females by looking for the number of rows in each group <code>n()</code>, store this as <code>students_n</code></span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="7">7</dt>
<dd>
<span data-code-lines="7" data-code-cell="annotated-cell-36" data-code-annotation="7">re-<code>group</code> the data on gender <code>ST004D01T</code> and whether the student is better at maths than reading <code>maths_better</code></span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="8">8</dt>
<dd>
<span data-code-lines="8" data-code-cell="annotated-cell-36" data-code-annotation="8">count the number of students, <code>n</code> in each group specified by line 7.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="9">9</dt>
<dd>
<span data-code-lines="9" data-code-cell="annotated-cell-36" data-code-annotation="9">create a percentage figure for the number of students in each grouping given by line 7. Use the <code>n</code> value from line 8 and the <code>students_n</code> value from line 6. <strong>NOTE:</strong> we need to use <code>unique(students_n)</code> to return just one value for each grouping rather than a value for every row of the line 7 grouping</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   ST004D01T [2]
  ST004D01T maths_better      n   per
  &lt;fct&gt;     &lt;lgl&gt;         &lt;int&gt; &lt;dbl&gt;
1 Female    FALSE        180350 0.590
2 Female    TRUE         125409 0.410
3 Male      FALSE        118341 0.384
4 Male      TRUE         189565 0.616</code></pre>
</div>
</div>
<p>For more information on how to <code>mutate</code> fields using <code>ifelse</code>, see <a href="#sec-ifelse">Section&nbsp;9.1</a></p>
</section>
<section id="arrange" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> arrange</h1>
<p>The results returned by pipes can be huge, so it’s a good idea to store them in objects and explore them in the Environment window where you can sort and search within the output. There might also be times when you want to order/<code>arrange</code> the outputs in a particular way. We can do this quite easily in the tidyverse by using the <code>arrange(&lt;column_name&gt;, &lt;column_name&gt;)</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb100-2"><a href="#cb100-2"></a>  <span class="fu">select</span>(CNT, ST004D01T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb100-3"><a href="#cb100-3"></a>  <span class="fu">arrange</span>(PV1MATH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 3
   CNT       ST004D01T PV1MATH
   &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Cambodia  Male          0  
 2 Guatemala Female       57.8
 3 Cambodia  Female       84.7
 4 Cambodia  Male         87.9
 5 Cambodia  Male         88.6
 6 Paraguay  Male         90.4
 7 Cambodia  Male         94.4
 8 Cambodia  Female       98.0
 9 Albania   Male         99.7
10 Cambodia  Female      100. 
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>If we’re interested in the highest achieving students we can add the <code>desc()</code> function to <code>arrange</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb102-2"><a href="#cb102-2"></a>  <span class="fu">select</span>(CNT, LANGN, ST004D01T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb102-3"><a href="#cb102-3"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(PV1MATH))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 4
   CNT               LANGN     ST004D01T PV1MATH
   &lt;fct&gt;             &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Singapore         Invalid   Male         943.
 2 Chinese Taipei    Mandarin  Male         917.
 3 Singapore         Invalid   Male         897.
 4 Korea             Korean    Male         893.
 5 Korea             Korean    Female       889.
 6 Chinese Taipei    Mandarin  Male         887.
 7 Singapore         Invalid   Male         883.
 8 Hong Kong (China) Cantonese Male         880.
 9 Korea             Korean    Male         868.
10 Singapore         Invalid   Male         867.
# ℹ 613,734 more rows</code></pre>
</div>
</div>
</section>
<section id="bring-everyting-together" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Bring everyting together</h1>
<p>We know that the <a href="https://educationendowmentfoundation.org.uk/education-evidence/teaching-learning-toolkit/repeating-a-year">evidence</a> strongly indicates that repeating a year is not good for student progress, but how do countries around the world differ in terms of the percentage of their students who repeat a year?</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-39"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-39-1" class="code-annotation-target"><a href="#annotated-cell-39-1"></a>data_repeat <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-39-2" class="code-annotation-target"><a href="#annotated-cell-39-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(REPEAT)) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-39-3" class="code-annotation-target"><a href="#annotated-cell-39-3"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-39-4" class="code-annotation-target"><a href="#annotated-cell-39-4"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-39-5" class="code-annotation-target"><a href="#annotated-cell-39-5"></a>  <span class="fu">select</span>(CNT, REPEAT, total) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-39-6" class="code-annotation-target"><a href="#annotated-cell-39-6"></a>  <span class="fu">group_by</span>(CNT, REPEAT) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-39-7" class="code-annotation-target"><a href="#annotated-cell-39-7"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>(),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-39-8" class="code-annotation-target"><a href="#annotated-cell-39-8"></a>            <span class="at">total =</span> <span class="fu">unique</span>(total),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-39-9" class="code-annotation-target"><a href="#annotated-cell-39-9"></a>            <span class="at">per =</span> student_n <span class="sc">/</span> <span class="fu">unique</span>(total)) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="10" onclick="event.preventDefault();">10</a><span id="annotated-cell-39-10" class="code-annotation-target"><a href="#annotated-cell-39-10"></a>  <span class="fu">filter</span>(REPEAT <span class="sc">==</span> <span class="st">"Repeated at lease once"</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="11" onclick="event.preventDefault();">11</a><span id="annotated-cell-39-11" class="code-annotation-target"><a href="#annotated-cell-39-11"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(per))</span>
<span id="annotated-cell-39-12"><a href="#annotated-cell-39-12"></a></span>
<span id="annotated-cell-39-13"><a href="#annotated-cell-39-13"></a><span class="fu">print</span>(data_repeat)                                  </span>
<span id="annotated-cell-39-14"><a href="#annotated-cell-39-14"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="12" onclick="event.preventDefault();">12</a><span id="annotated-cell-39-15" class="code-annotation-target"><a href="#annotated-cell-39-15"></a><span class="fu">write_csv</span>(data_repeat, <span class="st">"&lt;folder_location&gt;/repeat_a_year.csv"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-39" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-cell="annotated-cell-39" data-code-annotation="1">uses the <code>PISA_2022</code> dataframe, note that this line includes <code>&lt;-</code> to store the result opf the piping into a new object called <code>data_repeat</code></span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-cell="annotated-cell-39" data-code-annotation="2"><code>filter</code> out any <code>NA</code> values in the <code>REPEAT</code> field</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-39" data-code-annotation="3">group on the country of student <code>CNT</code></span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="4" data-code-cell="annotated-cell-39" data-code-annotation="4">create a new column <code>total</code> for total number of rows <code>n()</code> in each country <code>CNT</code> grouping</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="5" data-code-cell="annotated-cell-39" data-code-annotation="5">select on the <code>CNT</code>, <code>REPEAT</code> and <code>total</code> columns</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="6" data-code-cell="annotated-cell-39" data-code-annotation="6">regroup the data on country <code>CNT</code> and whether a student has repeated a year <code>REPEAT</code>, i.e.&nbsp;Albania+Did not repeat a grade; Albania+Repeated a grade; etc.</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="7">7</dt>
<dd>
<span data-code-lines="7" data-code-cell="annotated-cell-39" data-code-annotation="7">using the above grouping, count the number of rows in each group <code>n()</code> and assign this to <code>student_n</code></span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="8">8</dt>
<dd>
<span data-code-lines="8" data-code-cell="annotated-cell-39" data-code-annotation="8">for each grouping keep the <code>total</code> number of students in each country, as calculated on line 4. Note: <code>unique(total)</code> is needed here to return a single value of <code>total</code>, rather than a value for each student in each country</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="9">9</dt>
<dd>
<span data-code-lines="9" data-code-cell="annotated-cell-39" data-code-annotation="9">using <code>student_n</code> from line 7 and the number of students per country <code>total</code>, from line 4, create a percentage <code>per</code> for each grouping</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="10">10</dt>
<dd>
<span data-code-lines="10" data-code-cell="annotated-cell-39" data-code-annotation="10">as we have percentages for both <code>Repeated at lease once</code> and <code>Never repeated</code>, we only need to display one of these.</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="11">11</dt>
<dd>
<span data-code-lines="11" data-code-cell="annotated-cell-39" data-code-annotation="11">finally, we sort the data on the per/percentage column, to show the countries with the highest level of repeating a grade. This data is self-recorded by students, so might not be totally reliable!</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="12">12</dt>
<dd>
<span data-code-lines="15" data-code-cell="annotated-cell-39" data-code-annotation="12">save the data to your own folder as a csv</span>
</dd>
</dl>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 78 × 5
# Groups:   CNT [78]
   CNT                REPEAT                 student_n total   per
   &lt;fct&gt;              &lt;fct&gt;                      &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
 1 Morocco            Repeated at lease once      3156  6796 0.464
 2 Colombia           Repeated at lease once      2783  7401 0.376
 3 Cambodia           Repeated at lease once      1697  5156 0.329
 4 Guatemala          Repeated at lease once      1382  5110 0.270
 5 Panama             Repeated at lease once      1050  4080 0.257
 6 Philippines        Repeated at lease once      1793  7071 0.254
 7 Dominican Republic Repeated at lease once      1603  6566 0.244
 8 Belgium            Repeated at lease once      1941  8055 0.241
 9 Jamaica            Repeated at lease once       851  3600 0.236
10 Netherlands        Repeated at lease once      1118  4858 0.230
# ℹ 68 more rows</code></pre>
</div>
</div>
</section>
<section id="advanced-topics" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Advanced topics</h1>
<section id="sec-ifelse" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="sec-ifelse"><span class="header-section-number">9.1</span> Recoding data (ifelse)</h2>
<p>Often we want to plot values in groupings that don’t yet exist, for example might want to give all schools over a certain size a different <em>colour</em> from others schools, or flag up students who have a different home language to the language that is being taught in school. To do this we need to look at how we can <em>recode</em> values. A common way to recode values is through an <code>ifelse</code> statement:</p>
<blockquote class="blockquote">
<p><code>ifelse(&lt;statement(s)&gt;, &lt;value_if_true&gt;, &lt;value_if_false&gt;)</code></p>
</blockquote>
<p><code>ifelse</code> allows us to <em>recode</em> the data. In the example below, we are going to add a new column to the <code>PISA_2022</code> dataset (using <code>mutate</code>) noting whether a student got a higher grade in their Maths <code>PV1MATH</code> or Reading <code>PV1READ</code> tests. <strong>if</strong> <code>PV1MATH</code> is bigger then <code>PV1READ</code>, the <code>maths_better</code> is <code>TRUE</code>, <strong>else</strong> <code>maths_better</code> is <code>FALSE</code>, or in <code>dplyr</code> format:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1"></a>maths_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb105-2"><a href="#cb105-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> </span>
<span id="cb105-3"><a href="#cb105-3"></a>           <span class="fu">ifelse</span>(PV1MATH <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb105-4"><a href="#cb105-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb105-5"><a href="#cb105-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb105-6"><a href="#cb105-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ)</span>
<span id="cb105-7"><a href="#cb105-7"></a></span>
<span id="cb105-8"><a href="#cb105-8"></a><span class="fu">print</span>(maths_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 5
   CNT     ST004D01T maths_better PV1MATH PV1READ
   &lt;fct&gt;   &lt;fct&gt;     &lt;lgl&gt;          &lt;dbl&gt;   &lt;dbl&gt;
 1 Albania Female    FALSE           180.    248.
 2 Albania Male      TRUE            308.    258.
 3 Albania Male      FALSE           268.    285.
 4 Albania Female    FALSE           273.    322.
 5 Albania Female    FALSE           435.    464.
 6 Albania Male      TRUE            534.    451.
 7 Albania Male      FALSE           382.    391.
 8 Albania Female    FALSE           273.    308.
 9 Albania Female    FALSE           355.    429.
10 Albania Female    TRUE            430.    420.
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>We now take this new dataset <code>maths_data</code> and look at whether the difference between relative performance in maths and reading is the same for girls and boys:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a>maths_data <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="#cb107-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<span id="cb107-3"><a href="#cb107-3"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<span id="cb107-4"><a href="#cb107-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   ST004D01T [2]
  ST004D01T maths_better      n
  &lt;fct&gt;     &lt;lgl&gt;         &lt;int&gt;
1 Female    FALSE        180350
2 Female    TRUE         125409
3 Male      FALSE        118341
4 Male      TRUE         189565</code></pre>
</div>
</div>
<div class="question">
<p>Adjust the code above to work out the percentages of Males and Females <code>ST004D01T</code> in each group. Check to see if the pattern also exists between science <code>PV1SCIE</code> and reading <code>PV1READ</code>:</p>
<div class="cell">
<details>
<summary>adding percentage column</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb109-2"><a href="#cb109-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> </span>
<span id="cb109-3"><a href="#cb109-3"></a>           <span class="fu">ifelse</span>(PV1MATH <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb109-4"><a href="#cb109-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb109-5"><a href="#cb109-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb109-6"><a href="#cb109-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ) <span class="sc">%&gt;%</span> </span>
<span id="cb109-7"><a href="#cb109-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<span id="cb109-8"><a href="#cb109-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb109-9"><a href="#cb109-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb109-10"><a href="#cb109-10"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<span id="cb109-11"><a href="#cb109-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb109-12"><a href="#cb109-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>comparing science and reading</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb110-2"><a href="#cb110-2"></a>  <span class="fu">mutate</span>(<span class="at">sci_better =</span> </span>
<span id="cb110-3"><a href="#cb110-3"></a>           <span class="fu">ifelse</span>(PV1SCIE <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb110-4"><a href="#cb110-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb110-5"><a href="#cb110-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb110-6"><a href="#cb110-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, sci_better, PV1SCIE, PV1READ) <span class="sc">%&gt;%</span> </span>
<span id="cb110-7"><a href="#cb110-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(sci_better)) <span class="sc">%&gt;%</span></span>
<span id="cb110-8"><a href="#cb110-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb110-9"><a href="#cb110-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb110-10"><a href="#cb110-10"></a>  <span class="fu">group_by</span>(ST004D01T, sci_better) <span class="sc">%&gt;%</span></span>
<span id="cb110-11"><a href="#cb110-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb110-12"><a href="#cb110-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>comparing science and maths</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1"></a>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb111-2"><a href="#cb111-2"></a>  <span class="fu">mutate</span>(<span class="at">sci_better =</span> </span>
<span id="cb111-3"><a href="#cb111-3"></a>           <span class="fu">ifelse</span>(PV1SCIE <span class="sc">&gt;</span> PV1MATH,</span>
<span id="cb111-4"><a href="#cb111-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb111-5"><a href="#cb111-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb111-6"><a href="#cb111-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, sci_better, PV1SCIE, PV1MATH) <span class="sc">%&gt;%</span> </span>
<span id="cb111-7"><a href="#cb111-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(sci_better)) <span class="sc">%&gt;%</span></span>
<span id="cb111-8"><a href="#cb111-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb111-9"><a href="#cb111-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb111-10"><a href="#cb111-10"></a>  <span class="fu">group_by</span>(ST004D01T, sci_better) <span class="sc">%&gt;%</span></span>
<span id="cb111-11"><a href="#cb111-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb111-12"><a href="#cb111-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<p><code>ifelse</code> statements can get a little complicated when using factors (see: <a href="#sec-factors">Section&nbsp;9.2</a>). Take this example. Let’s flag students who have a different home language <code>LANGN</code> to the language that is being used in the PISA assessment tool <code>LANGTEST_QQQ</code>. We make an assumption here that the assessment tool will be the language used at school, so these students will be learning in a different language to their mother tongue. <strong>if</strong> <code>LANGN</code> equals <code>LANGTEST_QQQ</code>, the <code>lang_diff</code> is <code>FALSE</code>, <strong>else</strong> <code>lang_diff</code> is <code>TRUE</code>, this raises an error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1"></a>lang_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb112-2"><a href="#cb112-2"></a>  <span class="fu">mutate</span>(<span class="at">lang_diff =</span> </span>
<span id="cb112-3"><a href="#cb112-3"></a>           <span class="fu">ifelse</span>(LANGN <span class="sc">==</span> LANGTEST_QQQ,</span>
<span id="cb112-4"><a href="#cb112-4"></a>                  <span class="cn">FALSE</span>, </span>
<span id="cb112-5"><a href="#cb112-5"></a>                  <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb112-6"><a href="#cb112-6"></a>  <span class="fu">select</span>(CNT, lang_diff, LANGTEST_QQQ, LANGN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
ℹ In argument: `lang_diff = ifelse(LANGN == LANGTEST_QQQ, FALSE, TRUE)`.
Caused by error in `Ops.factor()`:
! level sets of factors are different</code></pre>
</div>
</div>
<p>The levels in each field are different, i.e.&nbsp;the range of home languages is larger than the range of test languages. To fix this, all we need to do is change the datatype of the factors <code>LANGN</code> and <code>LANGTEST_QQQ</code> to characters using <code>as.character(&lt;field&gt;)</code>. This will then allow the comparison of the text stored in each row:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1"></a>lang_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb114-2"><a href="#cb114-2"></a>  <span class="fu">mutate</span>(<span class="at">lang_diff =</span> </span>
<span id="cb114-3"><a href="#cb114-3"></a>           <span class="fu">ifelse</span>(<span class="fu">as.character</span>(LANGN) <span class="sc">==</span> <span class="fu">as.character</span>(LANGTEST_QQQ),</span>
<span id="cb114-4"><a href="#cb114-4"></a>                  <span class="cn">FALSE</span>, </span>
<span id="cb114-5"><a href="#cb114-5"></a>                  <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb114-6"><a href="#cb114-6"></a>  <span class="fu">select</span>(CNT, lang_diff, LANGTEST_QQQ, LANGN)</span>
<span id="cb114-7"><a href="#cb114-7"></a></span>
<span id="cb114-8"><a href="#cb114-8"></a><span class="fu">print</span>(lang_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 613,744 × 4
   CNT     lang_diff LANGTEST_QQQ LANGN   
   &lt;fct&gt;   &lt;lgl&gt;     &lt;fct&gt;        &lt;fct&gt;   
 1 Albania FALSE     Albanian     Albanian
 2 Albania FALSE     Albanian     Albanian
 3 Albania FALSE     Albanian     Albanian
 4 Albania FALSE     Albanian     Albanian
 5 Albania FALSE     Albanian     Albanian
 6 Albania FALSE     Albanian     Albanian
 7 Albania FALSE     Albanian     Albanian
 8 Albania FALSE     Albanian     Albanian
 9 Albania FALSE     Albanian     Albanian
10 Albania FALSE     Albanian     Albanian
# ℹ 613,734 more rows</code></pre>
</div>
</div>
<p>We can now look at this dataset to get an idea of which countries have the largest percentage of students learning in a language other than their mother tongue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1"></a>lang_data_diff <span class="ot">&lt;-</span> lang_data <span class="sc">%&gt;%</span> </span>
<span id="cb116-2"><a href="#cb116-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb116-3"><a href="#cb116-3"></a>  <span class="fu">mutate</span>(<span class="at">student_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb116-4"><a href="#cb116-4"></a>  <span class="fu">group_by</span>(CNT, lang_diff) <span class="sc">%&gt;%</span></span>
<span id="cb116-5"><a href="#cb116-5"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb116-6"><a href="#cb116-6"></a>            <span class="at">percentage =</span> <span class="dv">100</span><span class="sc">*</span>(n <span class="sc">/</span> <span class="fu">max</span>(student_n))) <span class="sc">%&gt;%</span></span>
<span id="cb116-7"><a href="#cb116-7"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lang_diff),</span>
<span id="cb116-8"><a href="#cb116-8"></a>         lang_diff <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb116-9"><a href="#cb116-9"></a></span>
<span id="cb116-10"><a href="#cb116-10"></a><span class="fu">print</span>(lang_data_diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 4
# Groups:   CNT [80]
   CNT                  lang_diff     n percentage
   &lt;fct&gt;                &lt;lgl&gt;     &lt;int&gt;      &lt;dbl&gt;
 1 Albania              TRUE        720      11.7 
 2 United Arab Emirates TRUE      13933      56.6 
 3 Argentina            TRUE        788       6.51
 4 Australia            TRUE       1827      13.6 
 5 Austria              TRUE       1455      23.7 
 6 Belgium              TRUE       2445      29.5 
 7 Bulgaria             TRUE        961      15.7 
 8 Brazil               TRUE        559       5.18
 9 Brunei Darussalam    TRUE       4831      86.6 
10 Canada               TRUE       5971      25.9 
# ℹ 70 more rows</code></pre>
</div>
</div>
<p>This looks like a promising dataset, but there are some strange results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1"></a>lang_data_diff <span class="sc">%&gt;%</span> <span class="fu">filter</span>(percentage <span class="sc">&gt;</span> <span class="dv">92</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
# Groups:   CNT [8]
  CNT                          lang_diff     n percentage
  &lt;fct&gt;                        &lt;lgl&gt;     &lt;int&gt;      &lt;dbl&gt;
1 Hong Kong (China)            TRUE       5626       95.2
2 Macao (China)                TRUE       4384      100  
3 Montenegro                   TRUE       5596       96.6
4 Norway                       TRUE       6611      100  
5 Philippines                  TRUE       6693       93.0
6 Ukrainian regions (18 of 27) TRUE       3747       96.7
7 Singapore                    TRUE       6567       99.4
8 Chinese Taipei               TRUE       5821       99.4</code></pre>
</div>
</div>
<p>Exploring data for Ukraine, we can see that a different spelling has been used in each field, <em>Ukra</em><u>i</u>nian and <em>Ukranain</em>, an incorrect spelling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1"></a>lang_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Ukrainian regions (18 of 27)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,876 × 4
   CNT                          lang_diff LANGTEST_QQQ LANGN    
   &lt;fct&gt;                        &lt;lgl&gt;     &lt;fct&gt;        &lt;fct&gt;    
 1 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 2 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 3 Ukrainian regions (18 of 27) TRUE      Ukranian     Russian  
 4 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 5 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 6 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 7 Ukrainian regions (18 of 27) TRUE      Ukranian     Russian  
 8 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
 9 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
10 Ukrainian regions (18 of 27) TRUE      Ukranian     Ukrainian
# ℹ 3,866 more rows</code></pre>
</div>
</div>
<p><code>ifelse</code> can help here too. If we pick the spelling we want to stick to, we can <em>recode</em> fields to match:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1"></a>lang_data <span class="sc">%&gt;%</span> </span>
<span id="cb122-2"><a href="#cb122-2"></a>  <span class="fu">mutate</span>(<span class="at">LANGTEST_QQQ =</span> </span>
<span id="cb122-3"><a href="#cb122-3"></a>           <span class="fu">ifelse</span>(<span class="fu">as.character</span>(LANGTEST_QQQ) <span class="sc">==</span> <span class="st">"Ukranian"</span>,</span>
<span id="cb122-4"><a href="#cb122-4"></a>                 <span class="st">"Ukrainian"</span>,</span>
<span id="cb122-5"><a href="#cb122-5"></a>                 <span class="fu">as.character</span>(LANGTEST_QQQ))) <span class="sc">%&gt;%</span></span>
<span id="cb122-6"><a href="#cb122-6"></a>  <span class="fu">mutate</span>(<span class="at">lang_diff =</span> </span>
<span id="cb122-7"><a href="#cb122-7"></a>           <span class="fu">ifelse</span>(<span class="fu">as.character</span>(LANGN) <span class="sc">==</span> <span class="fu">as.character</span>(LANGTEST_QQQ),</span>
<span id="cb122-8"><a href="#cb122-8"></a>                  <span class="cn">FALSE</span>, </span>
<span id="cb122-9"><a href="#cb122-9"></a>                  <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb122-10"><a href="#cb122-10"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Ukrainian regions (18 of 27)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,876 × 4
   CNT                          lang_diff LANGTEST_QQQ LANGN    
   &lt;fct&gt;                        &lt;lgl&gt;     &lt;chr&gt;        &lt;fct&gt;    
 1 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 2 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 3 Ukrainian regions (18 of 27) TRUE      Ukrainian    Russian  
 4 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 5 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 6 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 7 Ukrainian regions (18 of 27) TRUE      Ukrainian    Russian  
 8 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
 9 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
10 Ukrainian regions (18 of 27) FALSE     Ukrainian    Ukrainian
# ℹ 3,866 more rows</code></pre>
</div>
</div>
<p>Unfortunately, if you explore this dataset a little further, the language fields don’t conform well with each other and a lot more work with <code>ifelse</code> will be needed before you could put together any full analysis around students who speak different languages at home and at school.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s possible to nest our <code>ifelse</code> statements, by writing another <code>ifelse</code> where you would have the <code>&lt;value_if_false&gt;</code>, for example we might want to give describe the type of school in England:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: use PISA for this</span></span>
<span id="cb124-2"><a href="#cb124-2"></a>plot_data <span class="ot">&lt;-</span> schools <span class="sc">%&gt;%</span> </span>
<span id="cb124-3"><a href="#cb124-3"></a>  <span class="fu">mutate</span>(<span class="at">sch_type =</span> </span>
<span id="cb124-4"><a href="#cb124-4"></a>           <span class="fu">ifelse</span>(EstablishmentGroup <span class="sc">==</span> <span class="st">"Special schools"</span>, <span class="st">"Special"</span>,</span>
<span id="cb124-5"><a href="#cb124-5"></a>                  <span class="fu">ifelse</span>(EstablishmentGroup <span class="sc">==</span> <span class="st">"Independent schools"</span>, <span class="st">"Independent"</span>,</span>
<span id="cb124-6"><a href="#cb124-6"></a>                         <span class="fu">ifelse</span>(AdmissionsPolicy<span class="sc">==</span><span class="st">"Selective"</span>, </span>
<span id="cb124-7"><a href="#cb124-7"></a>                                <span class="st">"Grammar"</span>, <span class="st">"Comprehensive"</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="sec-factors" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="sec-factors"><span class="header-section-number">9.2</span> Factors and statistical data types</h2>
<p>The types of variable will heavily influence what statistical analysis you can perform, e.g.&nbsp;you’ll need numeric values for a t-test. R is there to help by assigning datatypes to each field. We have different sorts of data that can be stored:</p>
<!-- https://www150.statcan.gc.ca/n1/edu/power-pouvoir/ch8/5214817-eng.htm -->
<ul>
<li><strong>Categorical</strong> - data that can be divided into groups or categories
<ul>
<li><strong>Nominal</strong> - categorical data where the order isn’t important, e.g.&nbsp;gender, or colours</li>
<li><strong>Ordinal</strong> - categorical data that may have order or ranking, e.g.&nbsp;exam grades (A, B, C, D) or lickert scales (strongly agree, agree, disgaree, strongly disagree)</li>
</ul></li>
<li><strong>Numeric</strong> - data that consists of numbers
<ul>
<li><strong>Continuous</strong> - numeric data that can take any value within a given range, e.g.&nbsp;height (178cm, 134.54cm)</li>
<li><strong>Discrete</strong> - numeric data that can take only certain values within a range, e.g.&nbsp;number of children in a family (0,1,2,3,4,5)</li>
</ul></li>
</ul>
<p>But here we are going to look at how R handles <code>factors</code>. Factors have two parts, <code>levels</code> and <code>codes</code>. levels are what you see when you view a table column, codes are an underlying order to the data. Factors allow you to store data that has a known set of values that you might want to display in an order other than alphabetical. For example, if we look at the month field <code>ST003D02T</code> using the <code>levels(&lt;field&gt;)</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1"></a><span class="fu">levels</span>(PISA_2022<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "January"        "February"       "March"          "April"         
 [5] "May"            "June"           "July"           "August"        
 [9] "September"      "October"        "November"       "December"      
[13] "Valid Skip"     "Not Applicable" "Invalid"        "No Response"   </code></pre>
</div>
</div>
<p>We can see that the months of the year are there along with other possible <code>levels</code>. With this particular column there are levels for missing or wrong responses (“Valid Skip”, “Not Applicable” “Invalid”, “No Response”), though PISA rarely uses them. You are more likely to find that missing/wrong data items are coded as <code>NA</code>, as you can see below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1"></a>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">count</span>(ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 2
   ST003D02T     n
   &lt;fct&gt;     &lt;int&gt;
 1 January   48760
 2 February  43030
 3 March     48671
 4 April     47014
 5 May       49235
 6 June      48890
 7 July      51262
 8 August    51681
 9 September 51755
10 October   51703
11 November  48179
12 December  48156
13 &lt;NA&gt;      25408</code></pre>
</div>
</div>
<p><code>Codes</code> are the underlying numbers/order for each level, in this case <code>1 = January</code>, <code>2 = February</code>, etc. R stores factors as codes, then uses the <code>levels</code> to display the data. You can see the <em>codes</em> by using the <code>as.numeric</code> command on a factor:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1"></a><span class="fu">as.numeric</span>(PISA_2022<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  5  2  8  7  1  5  5 12  8  9 10  4  5  8  7  2  3  6  3  8 10  1 10  2  5
[26]  6  8  1  3  2  5  7 12  4  1 10 10  3  3  9
 [ reached getOption("max.print") -- omitted 613704 entries ]</code></pre>
</div>
</div>
<p>How can this be useful? Firstly it’s more efficient for R to store data this way, numbers (codes) are smaller and easier to sort/search than text (levels). But it also helps when we come to presenting data. A good example is how plots are made, they will use the <code>codes</code> to give an order to the display of columns, in the plot below, <code>February</code> (<code>2</code>) comes before <code>August</code> (<code>8</code>), even though there were more students born in <code>August</code> and <em>A</em> is before <em>F</em> in the alphabet:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1"></a>grph_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb131-2"><a href="#cb131-2"></a>         <span class="fu">group_by</span>(ST003D02T) <span class="sc">%&gt;%</span> </span>
<span id="cb131-3"><a href="#cb131-3"></a>         <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>())</span>
<span id="cb131-4"><a href="#cb131-4"></a></span>
<span id="cb131-5"><a href="#cb131-5"></a>grph_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] September October   August    July      May       June      January  
 [8] March     November  December  April     February  &lt;NA&gt;     
attr(,"label")
[1] Student (Standardized) Birth - Month
16 Levels: January February March April May June July August ... No Response</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb133-2"><a href="#cb133-2"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb133-3"><a href="#cb133-3"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>To re-order the columns to match the number of students in each month, we can either try to do this manually, which is rather cumbersome:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1"></a>my_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"September"</span>, <span class="st">"October"</span>, <span class="st">"August"</span>, <span class="st">"July"</span>, <span class="st">"May"</span>, <span class="st">"June"</span>, </span>
<span id="cb134-2"><a href="#cb134-2"></a>               <span class="st">"January"</span>, <span class="st">"March"</span>, <span class="st">"November"</span>, <span class="st">"December"</span>, <span class="st">"April"</span>, <span class="st">"February"</span>,</span>
<span id="cb134-3"><a href="#cb134-3"></a>               <span class="st">"Valid Skip"</span>, <span class="st">"Not Applicable"</span>, <span class="st">"Invalid"</span>, <span class="st">"No Response"</span>)</span>
<span id="cb134-4"><a href="#cb134-4"></a></span>
<span id="cb134-5"><a href="#cb134-5"></a>grph_data<span class="sc">$</span>ST003D02T <span class="ot">&lt;-</span> <span class="fu">factor</span>(grph_data<span class="sc">$</span>ST003D02T, <span class="at">levels=</span>my_levels)</span>
<span id="cb134-6"><a href="#cb134-6"></a></span>
<span id="cb134-7"><a href="#cb134-7"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb134-8"><a href="#cb134-8"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb134-9"><a href="#cb134-9"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-87-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>Or we can get R to do this for us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1"></a><span class="co"># get the levels in order and pull/create a vector of them</span></span>
<span id="cb135-2"><a href="#cb135-2"></a>my_levels <span class="ot">&lt;-</span> grph_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ST003D02T)</span>
<span id="cb135-3"><a href="#cb135-3"></a></span>
<span id="cb135-4"><a href="#cb135-4"></a><span class="co"># reassign the re-ordered levels to the dataframe column</span></span>
<span id="cb135-5"><a href="#cb135-5"></a>grph_data<span class="sc">$</span>ST003D02T <span class="ot">&lt;-</span> <span class="fu">factor</span>(grph_data<span class="sc">$</span>ST003D02T, <span class="at">levels=</span>my_levels)</span>
<span id="cb135-6"><a href="#cb135-6"></a></span>
<span id="cb135-7"><a href="#cb135-7"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb135-8"><a href="#cb135-8"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-88-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>To learn a lot more about factors, see <a href="https://r4ds.had.co.nz/factors.html">Hadley’s chapter</a></p>
</section>
</section>
<section id="seminar-tasks" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Seminar tasks</h1>
<section id="student-dataset" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="student-dataset"><span class="header-section-number">10.1</span> Student dataset</h2>
<div class="question">
<ol type="1">
<li>How many unique values are there in the <code>OCOD3</code> field for student intended future occupation? How does the most desired career vary by gender?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1"></a>PISA_2022<span class="sc">$</span>OCOD3 <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb136-2"><a href="#cb136-2"></a></span>
<span id="cb136-3"><a href="#cb136-3"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb136-4"><a href="#cb136-4"></a>  <span class="fu">group_by</span>(ST004D01T, OCOD3) <span class="sc">%&gt;%</span></span>
<span id="cb136-5"><a href="#cb136-5"></a>  <span class="fu">summarise</span>(<span class="at">n =</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb136-6"><a href="#cb136-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>write code to work out the <code>mean</code> and <code>median</code> <code>PV1MATH</code> score for each country <code>CNT</code>.</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb137-2"><a href="#cb137-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb137-3"><a href="#cb137-3"></a>  <span class="fu">summarise</span>(<span class="at">mean_PV1MATH =</span> <span class="fu">mean</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb137-4"><a href="#cb137-4"></a>            <span class="at">median_PV1MATH =</span> <span class="fu">median</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb137-5"><a href="#cb137-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(median_PV1MATH))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>what is the fourth most popular language at home <code>LANGN</code> spoken by students in schools in the <code>Ireland</code>, how does this compare to <code>Germany</code>?</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1"></a>PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb138-2"><a href="#cb138-2"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Germany"</span>, <span class="st">"Ireland"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb138-3"><a href="#cb138-3"></a>  <span class="fu">group_by</span>(CNT, LANGN) <span class="sc">%&gt;%</span></span>
<span id="cb138-4"><a href="#cb138-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb138-5"><a href="#cb138-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Spot the <strong>five</strong> errors with the following code. Can you make it work? What does it do?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1"></a><span class="co"># Work out when science scores are better than maths</span></span>
<span id="cb139-2"><a href="#cb139-2"></a>PISA_2022_scimath <span class="sc">&lt;</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb139-3"><a href="#cb139-3"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb139-4"><a href="#cb139-4"></a>  <span class="fu">mutate</span>(sci <span class="at">better =</span> PV1SCIE <span class="sc">-</span> PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb139-5"><a href="#cb139-5"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(scibetter) <span class="sc">%&gt;%</span></span>
<span id="cb139-6"><a href="#cb139-6"></a>  <span class="fu">group_by</span>(CNT gender) <span class="sc">%&gt;%</span></span>
<span id="cb139-7"><a href="#cb139-7"></a>  <span class="fu">summarise</span>(<span class="at">students =</span> n,</span>
<span id="cb139-8"><a href="#cb139-8"></a>            <span class="at">sci_win =</span> <span class="fu">sum</span>(scibetter <span class="sc">&gt;=</span> <span class="dv">0</span>),</span>
<span id="cb139-9"><a href="#cb139-9"></a>            <span class="at">per_scibetter =</span> <span class="dv">100</span><span class="sc">*</span>(sci_win<span class="sc">/</span>students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1"></a><span class="co"># Work out when more time spent in language lessons than maths lessons</span></span>
<span id="cb140-2"><a href="#cb140-2"></a>PISA_2022_scimath <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span>  <span class="co">#1 make sure you have the assignment arrow &lt;-</span></span>
<span id="cb140-3"><a href="#cb140-3"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb140-4"><a href="#cb140-4"></a>  <span class="fu">mutate</span>(<span class="at">sci_better =</span> PV1MATH <span class="sc">-</span> PV1SCIE) <span class="sc">%&gt;%</span> <span class="co">#2 _ not space in name of field</span></span>
<span id="cb140-5"><a href="#cb140-5"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(sci_better)) <span class="sc">%&gt;%</span>  <span class="co">#3 this needs to be !is.na, otherwise it'll return nothing</span></span>
<span id="cb140-6"><a href="#cb140-6"></a>  <span class="fu">group_by</span>(CNT, gender) <span class="sc">%&gt;%</span> <span class="co">#4 missing comma</span></span>
<span id="cb140-7"><a href="#cb140-7"></a>  <span class="fu">summarise</span>(<span class="at">students =</span> <span class="fu">n</span>(),   <span class="co">#5 missing brackets on the n() command</span></span>
<span id="cb140-8"><a href="#cb140-8"></a>            <span class="at">sci_win =</span> <span class="fu">sum</span>(sci_better <span class="sc">&gt;=</span> <span class="dv">0</span>),</span>
<span id="cb140-9"><a href="#cb140-9"></a>            <span class="at">per_sci_win =</span> <span class="dv">100</span><span class="sc">*</span>(sci_win<span class="sc">/</span>students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>By country and gender work out the mean, median and standard deviations of <code>STUBMI</code>, order by the descending <code>mean</code>.</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1"></a>pisa_bmi <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb141-2"><a href="#cb141-2"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb141-3"><a href="#cb141-3"></a>  <span class="fu">group_by</span>(CNT, gender) <span class="sc">%&gt;%</span></span>
<span id="cb141-4"><a href="#cb141-4"></a>  <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>(),</span>
<span id="cb141-5"><a href="#cb141-5"></a>            <span class="at">bmi_mean =</span> <span class="fu">mean</span>(STUBMI, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb141-6"><a href="#cb141-6"></a>            <span class="at">bmi_median =</span> <span class="fu">median</span>(STUBMI, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb141-7"><a href="#cb141-7"></a>            <span class="at">bmi_sd =</span> <span class="fu">sd</span>(STUBMI, <span class="at">na.rm=</span><span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb141-8"><a href="#cb141-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(bmi_mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
<section id="teacher-dataset" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="teacher-dataset"><span class="header-section-number">10.2</span> Teacher dataset</h2>
<p>To further check your understanding of this section you will be attempting to analyse the 2022 teacher dataset. This dataset includes records for 68054 teachers from 18 countries, including 544 columns, covering attitudinal, demographic and workplace data. You can find the dataset <a href="https://emckclac-my.sharepoint.com/:u:/g/personal/k1926273_kcl_ac_uk/EbFmgVVbQD9DlIIgOKHDhLcB8bA8lfQMDVSEkcjtByM2cQ?e=zYG4Is">here</a> in the <code>.parquet</code> format.</p>
<div class="cell">
<details>
<summary>example loading code</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1"></a><span class="co"># download the file then</span></span>
<span id="cb142-2"><a href="#cb142-2"></a><span class="co"># Work out when more time spent in language lessons than maths lessons</span></span>
<span id="cb142-3"><a href="#cb142-3"></a>PISA_2022_teacher <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="st">"C:/Users/Peter/Downloads/PISA_2012_teacher.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="question">
<ol type="1">
<li>Work out how many teachers are in the dataset for <code>Portugal</code></li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1"></a>PISA_2022_teacher <span class="sc">%&gt;%</span> </span>
<span id="cb143-2"><a href="#cb143-2"></a>  <span class="fu">group_by</span>(CNTRYID) <span class="sc">%&gt;%</span></span>
<span id="cb143-3"><a href="#cb143-3"></a>  <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb143-4"><a href="#cb143-4"></a>  <span class="fu">filter</span>(CNTRYID <span class="sc">==</span> <span class="st">"Portugal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>For each country <code>CNTRYID</code> by gender <code>TC001Q01NA</code>, what is the <code>mean</code> time that a teacher has been in the teaching profession <code>TC007Q02NA</code>? Include the number of teachers in each group. Order this to show the country with the longest serving workforce:</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1"></a>PISA_2022_teacher <span class="sc">%&gt;%</span></span>
<span id="cb144-2"><a href="#cb144-2"></a>  <span class="fu">group_by</span>(CNTRYID, TC001Q01NA) <span class="sc">%&gt;%</span></span>
<span id="cb144-3"><a href="#cb144-3"></a>  <span class="fu">summarise</span>(<span class="at">avg_years =</span> <span class="fu">mean</span>(TC007Q02NA, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb144-4"><a href="#cb144-4"></a>            <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb144-5"><a href="#cb144-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_years))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>For each country <code>CNT</code> find out which teachers report that they ‘Help students think critically’ <code>TC199Q07HA</code>. Hin: you’ll need to look at the levels of this question to find the correct filter:</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1"></a>crit_thinking <span class="ot">&lt;-</span> PISA_2022_teacher <span class="sc">%&gt;%</span> </span>
<span id="cb145-2"><a href="#cb145-2"></a>  <span class="fu">rename</span>(<span class="at">crit_think =</span> TC199Q07HA) <span class="sc">%&gt;%</span></span>
<span id="cb145-3"><a href="#cb145-3"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb145-4"><a href="#cb145-4"></a>  <span class="fu">mutate</span>(<span class="at">teachers=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb145-5"><a href="#cb145-5"></a>  <span class="fu">group_by</span>(CNT, crit_think) <span class="sc">%&gt;%</span></span>
<span id="cb145-6"><a href="#cb145-6"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb145-7"><a href="#cb145-7"></a>            <span class="at">per =</span> <span class="fu">n</span>()<span class="sc">/</span><span class="fu">unique</span>(teachers)) <span class="sc">%&gt;%</span></span>
<span id="cb145-8"><a href="#cb145-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(per)) <span class="sc">%&gt;%</span></span>
<span id="cb145-9"><a href="#cb145-9"></a>  <span class="fu">filter</span>(crit_think <span class="sc">==</span> <span class="st">"A lot"</span>)</span>
<span id="cb145-10"><a href="#cb145-10"></a></span>
<span id="cb145-11"><a href="#cb145-11"></a><span class="co"># interestingly the highest performing countries also </span></span>
<span id="cb145-12"><a href="#cb145-12"></a><span class="co"># have some of the lowest scores in helping children </span></span>
<span id="cb145-13"><a href="#cb145-13"></a><span class="co"># think critically. To plot this:</span></span>
<span id="cb145-14"><a href="#cb145-14"></a></span>
<span id="cb145-15"><a href="#cb145-15"></a><span class="fu">left_join</span>(crit_thinking,</span>
<span id="cb145-16"><a href="#cb145-16"></a>          PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">maths =</span> <span class="fu">mean</span>(PV1MATH))) <span class="sc">%&gt;%</span></span>
<span id="cb145-17"><a href="#cb145-17"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>per, <span class="at">y=</span>maths)) <span class="sc">+</span> </span>
<span id="cb145-18"><a href="#cb145-18"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb145-19"><a href="#cb145-19"></a>  <span class="fu">geom_smooth</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Explore the data on use of technology in the classroom <code>TC169____</code></li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1"></a>PISA_2022_teacher <span class="sc">%&gt;%</span> <span class="fu">select</span>(CNT, TC001Q01NA, <span class="fu">starts_with</span>(<span class="st">"TC169"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li><p>Save the results of one of the above questions using <code>write_csv()</code>.</p></li>
<li><p>[EXTENSION] explore the dataset and find out some more interesting facts to share with your group</p></li>
</ol>
</div>
</section>
<section id="graphing" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="graphing"><span class="header-section-number">10.3</span> Graphing</h2>
<p>The tidyverse includes the incredibly powerful <code>ggplot2</code> package. This package is pretty much the industry standard for making graphs for publication. <code>ggplot2</code> is built on the <em>grammar of graphics</em> where you build graphs by specifying underlying attributes and layering geometric objects on top of each other. In the diagram below you can see how a graph is built from <em>geometric objects</em> (the things that are plotted such as points and bars) a <em>scale</em>, and <em>plot annotations</em> (e.g.&nbsp;a key, title etc). You can then apply <em>faceting</em> to the graph to automatically split one graph into multiple plots, allowing you to easily compare different groupings. Publications, such as the Financial Times, make daily use of <code>ggplot2</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="http://vita.had.co.nz/papers/layered-grammar.pdf"><img src="images/grammarofgraphics.svg" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">Adapted from A Layered Grammar of Graphics, Wickham, 2010</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-graphing" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> ggplot</h1>
<p>The basic structure of <code>ggplot</code> code is to combine different graphing elements through the use of the <code>+</code> operator. To demonstrate this, let’s look at the relationship between a poverty indicator <code>ESCS</code> and the performance in Maths <code>PV1MATH</code>, by gender <code>ST004D01T</code> and country <code>CNT</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-56"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-56-1"><a href="#annotated-cell-56-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="annotated-cell-56-2"><a href="#annotated-cell-56-2"></a><span class="co"># wrangle our data</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-56" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-56-3" class="code-annotation-target"><a href="#annotated-cell-56-3"></a>graph_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-56-4"><a href="#annotated-cell-56-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"United Kingdom"</span>))            </span>
<span id="annotated-cell-56-5"><a href="#annotated-cell-56-5"></a></span>
<span id="annotated-cell-56-6"><a href="#annotated-cell-56-6"></a><span class="co"># display a graph of the results</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-56" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-56-7" class="code-annotation-target"><a href="#annotated-cell-56-7"></a><span class="fu">ggplot</span>(<span class="at">data =</span> graph_data,</span>
<span id="annotated-cell-56-8"><a href="#annotated-cell-56-8"></a>       <span class="fu">aes</span>(<span class="at">x =</span> ESCS, <span class="at">y =</span> PV1MATH, <span class="at">colour =</span> CNT)) <span class="sc">+</span>          </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-56" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-56-9" class="code-annotation-target"><a href="#annotated-cell-56-9"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-56" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-56-10" class="code-annotation-target"><a href="#annotated-cell-56-10"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-56" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-56-11" class="code-annotation-target"><a href="#annotated-cell-56-11"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> ST004D01T) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-56" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-56-12" class="code-annotation-target"><a href="#annotated-cell-56-12"></a>  <span class="fu">ggtitle</span>(<span class="st">"Comparison of poverty indicator and Maths result, by gender and country"</span>) <span class="sc">+</span></span>
<span id="annotated-cell-56-13"><a href="#annotated-cell-56-13"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-56" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-56" data-code-annotation="1">Hopefully you can work out what lines 1-3 do from the previous chapter, let’s focus on the <code>ggplot</code> commands</span>
</dd>
<dt data-target-cell="annotated-cell-56" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="7" data-code-cell="annotated-cell-56" data-code-annotation="2">line 7-8 set up the <code>ggplot</code> giving it the table object <code>graph_data</code> as its data input and setting up the aesthetics for the rest of the graph elements using columns from <code>graph_data</code>. The <code>aes(&lt;attribute&gt;, &lt;attribute&gt;, ...)</code> command allows us to specify aesthetic elements of the graph that will change dependent on the dataset we use. In the PISA_2022 data set, the variable <code>ESCS</code> refers to an index of economic status, and <code>PV1Math</code>, is the plausible value of the mathematics score. We set the x and y variables <code>x=ESCS</code> and <code>y=PV1MATH</code> , defining <code>aes()</code> inside <code>ggplot()</code> means we will pass down these values to subsequent geometric objects so we don’t have to define these <code>x</code> and <code>y</code> axis items again and again.</span>
</dd>
<dt data-target-cell="annotated-cell-56" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="9" data-code-cell="annotated-cell-56" data-code-annotation="3">line 9 using the data and <code>aes</code> values defined on lines 7-8, <code>geom_point</code> uses these <code>x</code> and <code>y</code> values to draw a point for each student in our dataset. There are lots of different parameters we could give <code>geom_point</code> e.g.&nbsp;specifying size and shape, but here we are content with just setting the <code>size</code> to be 0.1 and using the defaults.</span>
</dd>
<dt data-target-cell="annotated-cell-56" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="10" data-code-cell="annotated-cell-56" data-code-annotation="4">line 10 we add another geometric object on top of the points, this time we add a line of best fit <code>geom_smooth</code>, again this geometric object uses the values specified on lines 7-8, and we define the <code>method</code> as <code>lm</code>, to calculate a <em>linear model</em> line of best fit.</span>
</dd>
<dt data-target-cell="annotated-cell-56" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="11" data-code-cell="annotated-cell-56" data-code-annotation="5">line 11 uses <code>facet_wrap(. ~ CNT)</code> to create a graph for each group of <code>CNT</code> in the dataset, i.e.&nbsp;a graph for each country defined on line 3.</span>
</dd>
<dt data-target-cell="annotated-cell-56" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="12,13" data-code-cell="annotated-cell-56" data-code-annotation="6">lines 12 and 13, finally we customise the title of the graph, <code>ggtitle</code>, ready for display and place the legend underneath the graph</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-100-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Switching between the pipes and ggplot can get rather confusing. A very common mistake in using ggplot is to try and link together the <code>geom_</code> elements with a pipe command <code>%&gt;%</code> rather than the <code>+</code>.</p>
</div>
</div>
</section>
<section id="geoms" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> geoms</h1>
<p>There are about 40 different geometric objects in ggplot, allowing you to create almost any sort of graph. We will be exploring a few of them in detail, but if you want to explore others, please follow some of the links below:</p>
<ul>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a> for creating bar charts and histograms</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a> for plotting single points</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a> for connecting points together and showing trends</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a> for adding text labels to data points</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a> for representing the range of data</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html">geom_violin</a> an even better way for representing the range of data</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html">geom_hex</a> for creating heat maps</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_map.html">geom_map</a> for adding geographic maps</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a> for adding lines of best fit</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_hline.html">geom_hline</a> for adding static horizontal lines to a graph</li>
<li><a href="https://ggplot2.tidyverse.org/reference/geom_hline.html">geom_vline</a> for adding static vertical lines to a graph</li>
</ul>
<section id="sec-geom_point" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="sec-geom_point"><span class="header-section-number">12.1</span> geom_point</h2>
<p>Rather unsurprisingly, <code>geom_point</code> allows us to plot a layer of <em>points</em> using <code>x</code> and <code>y</code> coordinates. The below example shows how we can specify within the <code>ggplot</code> function <code>data=country_plot_data</code>. We then define the <code>aes</code>thetic attributes of the graph, passing the x <code>x=NumberOfBoys</code> and y <code>y=NumberOfGirls</code> values. Once these have been declared in the <code>ggplot(...)</code> function, their values are passed down to any subsequent <code>geom_</code>, in this case <code>geom_point</code> will use the <code>data</code> and <code>x</code> and <code>y</code> values that have been specified in <code>ggplot(...)</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-57"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-57-1"><a href="#annotated-cell-57-1"></a><span class="co"># create a new dataframe of maths and reading scores by country and OECD status</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-57-2" class="code-annotation-target"><a href="#annotated-cell-57-2"></a>country_plot_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-57-3" class="code-annotation-target"><a href="#annotated-cell-57-3"></a>  <span class="fu">group_by</span>(OECD, CNT) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-57-4" class="code-annotation-target"><a href="#annotated-cell-57-4"></a>  <span class="fu">summarise</span>(<span class="at">mean_maths =</span> <span class="fu">mean</span>(PV1MATH),</span>
<span id="annotated-cell-57-5"><a href="#annotated-cell-57-5"></a>            <span class="at">mean_read =</span> <span class="fu">mean</span>(PV1READ),   </span>
<span id="annotated-cell-57-6"><a href="#annotated-cell-57-6"></a>            <span class="at">sz =</span> <span class="fu">n</span>())</span>
<span id="annotated-cell-57-7"><a href="#annotated-cell-57-7"></a></span>
<span id="annotated-cell-57-8"><a href="#annotated-cell-57-8"></a><span class="co"># using this new dataframe, show the relationship between maths and reading score</span></span>
<span id="annotated-cell-57-9"><a href="#annotated-cell-57-9"></a><span class="co"># using geom_points</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-57-10" class="code-annotation-target"><a href="#annotated-cell-57-10"></a><span class="fu">ggplot</span>(<span class="at">data=</span>country_plot_data,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-57-11" class="code-annotation-target"><a href="#annotated-cell-57-11"></a>       <span class="fu">aes</span>(<span class="at">x=</span>mean_maths, <span class="at">y=</span>mean_read)) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-57-12" class="code-annotation-target"><a href="#annotated-cell-57-12"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size=</span>sz, <span class="at">colour=</span>OECD), <span class="at">alpha =</span> <span class="fl">0.6</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-57" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="2" data-code-cell="annotated-cell-57" data-code-annotation="1">pipe the large data.frame <code>PISA_2022</code> to apply a number of functions.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-57" data-code-annotation="2">groups by <code>OECD</code> (a <code>Yes</code> or <code>No</code> indicating membership) and <code>CNT</code> (the name of the country).</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4" data-code-cell="annotated-cell-57" data-code-annotation="3">calculate the <code>mean</code> mathematics and reading score, and create new variables (<code>mean_maths</code>, and <code>mean_read</code>) for their values. In addition, in line 6, the variables <code>sz</code> is created which counts the number of responses per country through the <code>n()</code> command. This whole pipe is then saved to the <code>country_plot_data</code> object, using the <code>&lt;-</code> on line 2</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="10" data-code-cell="annotated-cell-57" data-code-annotation="4">In <code>ggplot</code> we specifiy the data that should be plotted - the new dataframe <code>country_plot_data</code></span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="11" data-code-cell="annotated-cell-57" data-code-annotation="5">We pass the <code>x</code> and <code>y</code> variables, <code>mean_maths</code>, and <code>mean_read</code>, inside the <code>aes</code>thetic function. These values will be passed to any subsequent <code>geom_</code></span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="12" data-code-cell="annotated-cell-57" data-code-annotation="6">We make a number of tweaks to the points: first setting the <code>aes</code>thetics - the <code>size</code> of the points is linked to the <code>sz</code> variable we created, the number of responses per country, and the <code>colour</code> is linked to <code>OECD</code> membership. Finally (and note this is outside the <code>aes</code> brackets, we set an <code>alpha</code> value which makes the point slightly transparent, which is more visually appealing where points overlap.</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-101-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Defining things inside <code>aes</code> mean that they will change with the dataset you use, if you define them outside <code>aes</code> then they will be constant values. For example</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1"></a><span class="co"># plotting number of boys as x, number of girls as y and % disadvantaged as size,</span></span>
<span id="cb147-2"><a href="#cb147-2"></a><span class="co"># all inside aes, so each point is a table row</span></span>
<span id="cb147-3"><a href="#cb147-3"></a><span class="fu">ggplot</span>(<span class="at">data=</span>PISA_2022_school) <span class="sc">+</span></span>
<span id="cb147-4"><a href="#cb147-4"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> SC002Q01TA,</span>
<span id="cb147-5"><a href="#cb147-5"></a>                 <span class="at">y =</span> SC002Q02TA,</span>
<span id="cb147-6"><a href="#cb147-6"></a>                 <span class="at">size=</span>SC211Q03JA))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-102-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>However, there is an error if we put <code>size</code> outside the <code>aes()</code>, and set it a value from the dataset, it can’t find value:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>PISA_2022_school) <span class="sc">+</span></span>
<span id="cb148-2"><a href="#cb148-2"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> SC002Q01TA,</span>
<span id="cb148-3"><a href="#cb148-3"></a>                 <span class="at">y =</span> SC002Q02TA),</span>
<span id="cb148-4"><a href="#cb148-4"></a>             <span class="at">size=</span>SC211Q03JA)  <span class="co"># this is now outside the aes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'SC211Q03JA' not found</code></pre>
</div>
</div>
<p>but if we set the <code>size</code> explicitly to <code>3</code>, outside the <code>aes()</code>, then all points will be that size</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>PISA_2022_school) <span class="sc">+</span></span>
<span id="cb150-2"><a href="#cb150-2"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> SC002Q01TA,</span>
<span id="cb150-3"><a href="#cb150-3"></a>                 <span class="at">y =</span> SC002Q02TA),</span>
<span id="cb150-4"><a href="#cb150-4"></a>             <span class="at">size=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-104-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
</div>
</div>
<section id="questions-4" class="level3" data-number="12.1.1">
<h3 data-number="12.1.1" class="anchored" data-anchor-id="questions-4"><span class="header-section-number">12.1.1</span> Questions</h3>
<div class="question">
<ol type="1">
<li>Spot the <em>three</em> errors in this graph code</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode numberSource r none number-lines code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1"></a><span class="fu">ggplot</span>(<span class="at">adta=</span>diamonds, <span class="at">x=</span>depth, <span class="at">y=</span>price) <span class="sc">+</span></span>
<span id="cb151-2"><a href="#cb151-2"></a>  <span class="fu">geom_point</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb151-3"><a href="#cb151-3"></a>  <span class="fu">ggtitle</span>(<span class="st">"diamond graph"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1"></a><span class="co">#1 data not adta; #2 x and y need to be inside aes</span></span>
<span id="cb152-2"><a href="#cb152-2"></a><span class="fu">ggplot</span>(<span class="at">data=</span>diamonds, <span class="fu">aes</span>(<span class="at">x=</span>depth, <span class="at">y=</span>price)) <span class="sc">+</span></span>
<span id="cb152-3"><a href="#cb152-3"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="co">#3 %&gt;% instead of +</span></span>
<span id="cb152-4"><a href="#cb152-4"></a>  <span class="fu">ggtitle</span>(<span class="st">"diamond graph"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Using the <code>PISA_2022</code> dataset, plot a graph for students from <code>Norway</code> to look at the relationship between <em>Home Possessions (WLE)</em> <code>HOMEPOS</code> and <em>reading grade</em> <code>PV1READ</code>. Colour each point with the gender <code>ST004D01T</code> of the student. Give the graph sensible <code>x</code> and <code>y</code> labels by using <code>xlab("label")</code> and <code>ylab("label")</code></li>
</ol>
<div class="cell">
<details>
<summary>answer dataframe</summary>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1"></a>graph_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Norway"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>answer graph</summary>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1"></a><span class="fu">ggplot</span>(graph_data,</span>
<span id="cb154-2"><a href="#cb154-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>HOMEPOS,</span>
<span id="cb154-3"><a href="#cb154-3"></a>           <span class="at">y=</span>PV1READ)) <span class="sc">+</span></span>
<span id="cb154-4"><a href="#cb154-4"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour=</span>ST004D01T)) <span class="sc">+</span></span>
<span id="cb154-5"><a href="#cb154-5"></a>  <span class="fu">xlab</span>(<span class="st">"Home possessions"</span>) <span class="sc">+</span></span>
<span id="cb154-6"><a href="#cb154-6"></a>  <span class="fu">ylab</span>(<span class="st">"Reading grade"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Using the <code>PISA_2022</code> dataset for each country <code>CNT</code>, create a graph to explore how the <code>median</code> of the sense of school belonging <code>BELONG</code> relates to the <code>median</code> of the disciplinary climate in mathematics <code>DISCLIM</code>, adjust the colour of each point to reflect the <code>mean</code> of students in each country <code>ESCS</code>.</li>
</ol>
<p><strong>HINT:</strong> You’ll need create a new data frame with <code>summarise</code>d variables for <code>median_belong</code>, <code>median_discipline</code> and <code>mean_wealth</code>.</p>
<div class="cell">
<details>
<summary>answer dataframe</summary>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1"></a>graph_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb155-2"><a href="#cb155-2"></a>  <span class="fu">group_by</span>(OECD, CNT) <span class="sc">%&gt;%</span></span>
<span id="cb155-3"><a href="#cb155-3"></a>  <span class="fu">summarise</span>(<span class="at">median_belong =</span> <span class="fu">median</span>(BELONG, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb155-4"><a href="#cb155-4"></a>            <span class="at">median_discipline =</span> <span class="fu">median</span>(DISCLIM, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb155-5"><a href="#cb155-5"></a>            <span class="at">mean_wealth =</span> <span class="fu">mean</span>(ESCS, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>HINT:</strong> To make your colours stand out more, add <code>+ scale_color_gradientn(colours = rainbow(3))</code> to the end of your plot.</p>
<div class="cell">
<details>
<summary>answer graph</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1"></a><span class="co"># display a graph of the results</span></span>
<span id="cb156-2"><a href="#cb156-2"></a><span class="fu">ggplot</span>(<span class="at">data =</span> graph_data, </span>
<span id="cb156-3"><a href="#cb156-3"></a>       <span class="fu">aes</span>(<span class="at">x =</span> median_belong, </span>
<span id="cb156-4"><a href="#cb156-4"></a>           <span class="at">y =</span> median_discipline)) <span class="sc">+</span></span>
<span id="cb156-5"><a href="#cb156-5"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> mean_wealth)) <span class="sc">+</span> </span>
<span id="cb156-6"><a href="#cb156-6"></a>  <span class="fu">scale_color_gradientn</span>(<span class="at">colours =</span> <span class="fu">rainbow</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
</section>
<section id="sec-geom_bar" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="sec-geom_bar"><span class="header-section-number">12.2</span> geom_bar</h2>
<p>The <code>geom_bar</code> function is versatile, allowing the creation of bar, multiple bar, stacked bar charts and histograms. This first example shows how we can use bar charts to represent the number of cars in a household <code>ST251Q01JA</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-58"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-58" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-58-1" class="code-annotation-target"><a href="#annotated-cell-58-1"></a>plot_cars <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST251Q01JA))</span>
<span id="annotated-cell-58-2"><a href="#annotated-cell-58-2"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-58" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-58-3" class="code-annotation-target"><a href="#annotated-cell-58-3"></a><span class="fu">ggplot</span>(<span class="at">data =</span> plot_cars,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-58" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-58-4" class="code-annotation-target"><a href="#annotated-cell-58-4"></a>       <span class="fu">aes</span>(<span class="at">x=</span>ST251Q01JA)) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-58" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-58-5" class="code-annotation-target"><a href="#annotated-cell-58-5"></a>  <span class="fu">geom_bar</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-58" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-cell="annotated-cell-58" data-code-annotation="1">get the <code>PISA_2022</code> dataset and remove all rows where <code>ST251Q01JA</code> is <code>NA</code>, storing this new dataset as <code>plot_cars</code></span>
</dd>
<dt data-target-cell="annotated-cell-58" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="3" data-code-cell="annotated-cell-58" data-code-annotation="2">pass the <code>plot_cars</code> to <code>ggplot</code>, as the dataset we are going to plot</span>
</dd>
<dt data-target-cell="annotated-cell-58" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4" data-code-cell="annotated-cell-58" data-code-annotation="3">specify the <code>x</code> values to be the values stored in <code>ST251Q01JA</code>, i.e.&nbsp;we will have a bar for each response given in <code>ST251Q01JA</code>: <code>None</code>, <code>One</code>, <code>Two</code>, <code>Three or more</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-58" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="5" data-code-cell="annotated-cell-58" data-code-annotation="4"><code>geom_bar</code> tell ggplot to make bars, it uses the <code>aes</code>thetic from line 5, to plot the <code>x</code> axis, note we haven’t given it a <code>y</code> value, this is auto-calculated from the number of students in each <code>x</code> group.</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-111-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>We can choose to let ggplot split the results into different groups for us by setting a <code>fill</code> option, in this case on the <code>OECD</code> status of the country, i.e.&nbsp;do students in OECD countries have more cars than those not in OECD countries, to do this, we add <code>fill=OECD</code> to the <code>aes</code> on line 2 below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> plot_cars, </span>
<span id="cb157-2"><a href="#cb157-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>ST251Q01JA, <span class="at">fill=</span>OECD)) <span class="sc">+</span> </span>
<span id="cb157-3"><a href="#cb157-3"></a>  <span class="fu">geom_bar</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-112-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>The bars are now coloured with a key, but, annoyingly, the bars are on top of each other which makes it hard to make direct comparisons. To compare different groups we need the bars to not be <code>stacked</code>, we want them next to each other, or in <code>ggplot</code> language, we want the bars to <code>dodge</code> each other, to do this we add the <code>position=position_dodge()</code> command to line 3 below:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-113-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<section id="raising-the-bars-yourself" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="raising-the-bars-yourself"><span class="header-section-number">12.2.1</span> Raising the bars yourself</h3>
<p><code>ggplot</code> can do a lot of the hard work when putting together bar charts, e.g.&nbsp;counting the number of students in each group, but there might also be times when you want to use pipes to calculate summary values that you then want plot. That is, you want to specify the heights of the bars yourself. To do this we <em>will</em> specify the <code>y</code> axis in the <code>aes</code> and use <code>stat="indentity"</code> to tell ggplot that’s what we’re doing. Take the example where you want to find the overall percentage of students for a range of countries getting over <code>500</code> in <code>PV1SCIE</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-60"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-60" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-60-1" class="code-annotation-target"><a href="#annotated-cell-60-1"></a>plot_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-60-2"><a href="#annotated-cell-60-2"></a>  <span class="fu">group_by</span>(OECD, CNT) <span class="sc">%&gt;%</span>                                                          </span>
<span id="annotated-cell-60-3"><a href="#annotated-cell-60-3"></a>  <span class="fu">summarise</span>(<span class="at">all_students =</span> <span class="fu">n</span>(),                         </span>
<span id="annotated-cell-60-4"><a href="#annotated-cell-60-4"></a>            <span class="at">upper_sci_per =</span> <span class="fu">sum</span>(PV1SCIE <span class="sc">&gt;</span> <span class="dv">500</span>) <span class="sc">/</span> <span class="fu">n</span>())   </span>
<span id="annotated-cell-60-5"><a href="#annotated-cell-60-5"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-60" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-60-6" class="code-annotation-target"><a href="#annotated-cell-60-6"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_data,</span>
<span id="annotated-cell-60-7"><a href="#annotated-cell-60-7"></a>       <span class="fu">aes</span>(<span class="at">x=</span>CNT, <span class="at">y=</span>upper_sci_per)) <span class="sc">+</span>                   </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-60" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-60-8" class="code-annotation-target"><a href="#annotated-cell-60-8"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">fill=</span>OECD),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-60" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-60-9" class="code-annotation-target"><a href="#annotated-cell-60-9"></a>           <span class="at">position=</span><span class="fu">position_dodge</span>(),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-60" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-60-10" class="code-annotation-target"><a href="#annotated-cell-60-10"></a>           <span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-60" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-60-11" class="code-annotation-target"><a href="#annotated-cell-60-11"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-60" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-cell="annotated-cell-60" data-code-annotation="1">creates a dataframe <code>plot_data</code> that calculates the percentage of students in each country <code>CNT</code>, that have a science grade <code>PV1SCIE</code> over <code>500</code></span>
</dd>
<dt data-target-cell="annotated-cell-60" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="6" data-code-cell="annotated-cell-60" data-code-annotation="2">as we are setting the heights of the bars ourselves, we need to give the ggplot <code>aes</code> command a <code>y</code> value, in this case <code>y=upper_sci_per</code></span>
</dd>
<dt data-target-cell="annotated-cell-60" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="8" data-code-cell="annotated-cell-60" data-code-annotation="3">the <code>geom_bar</code> is given a <code>fill</code> value of <code>OECD</code>, this will allow us to see how countries in and out of the OECD compare</span>
</dd>
<dt data-target-cell="annotated-cell-60" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="9" data-code-cell="annotated-cell-60" data-code-annotation="4">we use <code>position=position_dodge()</code> as we want the percentage grades of each country to be next to each other so we can look for differences in heights</span>
</dd>
<dt data-target-cell="annotated-cell-60" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="10" data-code-cell="annotated-cell-60" data-code-annotation="5"><code>stat="identity"</code> tells <code>geom_bar</code> that you have defined your own bar heights in the <code>y</code> attribute and not to count the number of rows.</span>
</dd>
<dt data-target-cell="annotated-cell-60" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="11" data-code-cell="annotated-cell-60" data-code-annotation="6">the <code>theme</code> command helps rotate the x-axis labels 90 degrees, so they don’t overlap.</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-114-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>Alternatively, you can use the <code>geom_col()</code> function that can handle you setting the <code>y</code> values and not specifying <code>stat="identity"</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_data, </span>
<span id="cb158-2"><a href="#cb158-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>CNT, <span class="at">y=</span>upper_sci_per)) <span class="sc">+</span></span>
<span id="cb158-3"><a href="#cb158-3"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">fill=</span>OECD), </span>
<span id="cb158-4"><a href="#cb158-4"></a>           <span class="at">position=</span><span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="cb158-5"><a href="#cb158-5"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="questions-5" class="level3" data-number="12.2.2">
<h3 data-number="12.2.2" class="anchored" data-anchor-id="questions-5"><span class="header-section-number">12.2.2</span> Questions</h3>
<div class="question">
<ol type="1">
<li>Can you spot the 4 errors in this code.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode numberSource r none number-lines code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>schools <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Phase <span class="sc">==</span> <span class="st">"Secondary"</span>), </span>
<span id="cb159-2"><a href="#cb159-2"></a>       <span class="at">x=</span>Region <span class="sc">+</span></span>
<span id="cb159-3"><a href="#cb159-3"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">fill=</span>Gender) <span class="at">position=</span><span class="st">"full"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>schools <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Phase <span class="sc">==</span> <span class="st">"Secondary"</span>), </span>
<span id="cb160-2"><a href="#cb160-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>Region)) <span class="sc">+</span> <span class="co"># 1 no aes() around the x value # 2 missing close brackets</span></span>
<span id="cb160-3"><a href="#cb160-3"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">fill=</span>Gender), <span class="at">position=</span><span class="st">"fill"</span>) <span class="co"># 3 missing comma # 4 position="full" rather than fill </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Create a bar chart showing the total number of students for each grouping of “How satisfied are you with each of the following: The way that you look” <code>WB155Q02HA</code>. Adjust this graph to see if there is a difference for this among females and males:</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>PISA_2022,</span>
<span id="cb161-2"><a href="#cb161-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>WB155Q02HA)) <span class="sc">+</span></span>
<span id="cb161-3"><a href="#cb161-3"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb161-4"><a href="#cb161-4"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>answer with gender added</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(WB155Q02HA)),</span>
<span id="cb162-2"><a href="#cb162-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>WB155Q02HA, <span class="at">fill=</span>ST004D01T)) <span class="sc">+</span></span>
<span id="cb162-3"><a href="#cb162-3"></a>  <span class="fu">geom_bar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="cb162-4"><a href="#cb162-4"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Plot bars for the number of Females and Males <code>ST004D01T</code> who answer each grouping for: “Confident can do in future: : Finding learning resources online on my own” <code>ST355Q03JA</code>. Make sure that the bars <code>position_dodge()</code> each other so we can compare the heights.</li>
</ol>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1"></a>graph_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST355Q03JA))</span>
<span id="cb163-2"><a href="#cb163-2"></a></span>
<span id="cb163-3"><a href="#cb163-3"></a>  <span class="fu">ggplot</span>(<span class="at">data=</span>graph_data,</span>
<span id="cb163-4"><a href="#cb163-4"></a>       <span class="fu">aes</span>(<span class="at">x=</span>ST355Q03JA, <span class="at">fill=</span>ST004D01T)) <span class="sc">+</span></span>
<span id="cb163-5"><a href="#cb163-5"></a>  <span class="fu">geom_bar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="cb163-6"><a href="#cb163-6"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>For France and the United Kingdom, plot the total number of students who gave each answer for <code>ST324Q11JA</code> “Agree/disagree: School has been a waste of time.”. Filter out all the <code>NA</code> values first <code>!is.na(...)</code></li>
</ol>
<div class="cell">
<details>
<summary>answer dataframe</summary>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1"></a>plot_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb164-2"><a href="#cb164-2"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"United Kingdom"</span>),</span>
<span id="cb164-3"><a href="#cb164-3"></a>         <span class="sc">!</span><span class="fu">is.na</span>(ST324Q11JA))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>answer</summary>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1"></a><span class="fu">ggplot</span>(plot_data,</span>
<span id="cb165-2"><a href="#cb165-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>ST324Q11JA, <span class="at">fill=</span>CNT)) <span class="sc">+</span></span>
<span id="cb165-3"><a href="#cb165-3"></a>  <span class="fu">geom_bar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="cb165-4"><a href="#cb165-4"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>Using the <code>PISA_2022_school</code> dataset (available <a href="../Users/k1765032/Library/CloudStorage/GoogleDrive-richardandrewbrock@gmail.com/.shortcut-targets-by-id/1c3CkaEBOICzepArDfjQUP34W2BYhFjM4/PISR/Data/PISA/2022/PISA_school_2022.parquet">here</a> create a table that stores for each country <code>CNT</code></li>
</ol>
<ul>
<li>the total number of full-time teacher, <code>SC018Q01TA01</code></li>
<li>the total number of full-time teachers with a bachelors qualification <code>SC018Q08JA01</code></li>
<li>the total number of full-time teachers with a master’s qualification <code>SC018Q01TA01</code></li>
<li>the total number of full-time teachers with a doctoral qualification <code>SC018Q10JA01</code></li>
</ul>
<p>Add an additional column working out the % of teachers with master’s in each country, call this <code>per_MA</code></p>
<div class="cell">
<details>
<summary>creating the dataframe</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1"></a>plot_workforce <span class="ot">&lt;-</span> PISA_2022_school <span class="sc">%&gt;%</span> </span>
<span id="cb166-2"><a href="#cb166-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span> </span>
<span id="cb166-3"><a href="#cb166-3"></a>  <span class="fu">summarise</span>(<span class="at">schools =</span> <span class="fu">n</span>(),</span>
<span id="cb166-4"><a href="#cb166-4"></a>            <span class="at">total =</span> <span class="fu">sum</span>(SC018Q01TA01, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb166-5"><a href="#cb166-5"></a>            <span class="at">BA =</span>    <span class="fu">sum</span>(SC018Q08JA01, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb166-6"><a href="#cb166-6"></a>            <span class="at">PHD =</span>   SC018Q10JA01 <span class="sc">%&gt;%</span> <span class="fu">sum</span>(<span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb166-7"><a href="#cb166-7"></a>            <span class="at">MA =</span>    SC018Q09JA01 <span class="sc">%&gt;%</span> <span class="fu">sum</span>(<span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb166-8"><a href="#cb166-8"></a>            <span class="at">per_MA =</span> MA <span class="sc">*</span><span class="dv">100</span> <span class="sc">/</span> total)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Using this dataframe plot a bar graph for each country of the <code>per_MA</code>, use the number of schools as a <code>fill</code>:</p>
<div class="cell">
<details>
<summary>creating the graph</summary>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_workforce,</span>
<span id="cb167-2"><a href="#cb167-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>CNT, <span class="at">y=</span>per_MA, <span class="at">fill=</span>schools)) <span class="sc">+</span></span>
<span id="cb167-3"><a href="#cb167-3"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb167-4"><a href="#cb167-4"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb167-5"><a href="#cb167-5"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="6" type="1">
<li>[Extension] Explore other patterns in the school and student Pisa datasets.</li>
</ol>
</div>
</section>
</section>
<section id="geom_text" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="geom_text"><span class="header-section-number">12.3</span> geom_text</h2>
<p>Our bar charts look great, but finding the actual value of each bar can be a little clumsy if we have to get a ruler out and read off the y-axis. Better would be for us to have numbers listed at the top of each bar by adding a <code>geom_text</code> element:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-62"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-62-1"><a href="#annotated-cell-62-1"></a>plot_cars <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST251Q01JA))</span>
<span id="annotated-cell-62-2"><a href="#annotated-cell-62-2"></a></span>
<span id="annotated-cell-62-3"><a href="#annotated-cell-62-3"></a><span class="fu">ggplot</span>(<span class="at">data =</span> plot_cars, </span>
<span id="annotated-cell-62-4"><a href="#annotated-cell-62-4"></a>       <span class="fu">aes</span>(<span class="at">x=</span>ST251Q01JA, <span class="at">fill=</span>OECD)) <span class="sc">+</span> </span>
<span id="annotated-cell-62-5"><a href="#annotated-cell-62-5"></a>  <span class="fu">geom_bar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>()) <span class="sc">+</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-62" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-62-6" class="code-annotation-target"><a href="#annotated-cell-62-6"></a>  <span class="fu">geom_text</span>(<span class="at">stat=</span><span class="st">'count'</span>,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-62" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-62-7" class="code-annotation-target"><a href="#annotated-cell-62-7"></a>            <span class="fu">aes</span>(<span class="at">label=</span><span class="fu">after_stat</span>(count)),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-62" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-62-8" class="code-annotation-target"><a href="#annotated-cell-62-8"></a>            <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.9</span>),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-62" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-62-9" class="code-annotation-target"><a href="#annotated-cell-62-9"></a>            <span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.5</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-62" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="6" data-code-cell="annotated-cell-62" data-code-annotation="1">line 6 starts the <code>geom_text</code> command, telling the geom to use the <code>count</code> <code>stat</code>istic from ggplot, this means it will be able to fetch the number of rows in each grouping.</span>
</dd>
<dt data-target-cell="annotated-cell-62" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="7" data-code-cell="annotated-cell-62" data-code-annotation="2">as we want the label to change for each bar element, we put <code>label=after_stat(count)</code> inside <code>aes</code>. The <code>x</code> location of the labels is inherited from line 4 and the <code>y</code> location will be calculated from the height of each bar</span>
</dd>
<dt data-target-cell="annotated-cell-62" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="8" data-code-cell="annotated-cell-62" data-code-annotation="3">we want the labels to align to the bars, so we tell the <code>geom_text</code> to also <code>position_dodge</code>, passing a <code>width=0.9</code> to the dodge function, so the labels line up above the columns,</span>
</dd>
<dt data-target-cell="annotated-cell-62" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="9" data-code-cell="annotated-cell-62" data-code-annotation="4">finally, on line 9, we vertically adjust the labels <code>vjust</code>, so they sit on top of the columns.</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-125-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>Rather than adding the count, you might want to add the percentage that each bar represents, we can do this by changing the value given to label on line 5, below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> plot_cars, </span>
<span id="cb168-2"><a href="#cb168-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>ST251Q01JA, <span class="at">fill=</span>OECD)) <span class="sc">+</span> </span>
<span id="cb168-3"><a href="#cb168-3"></a>  <span class="fu">geom_bar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="cb168-4"><a href="#cb168-4"></a>  <span class="fu">geom_text</span>(<span class="at">stat=</span><span class="st">'count'</span>, </span>
<span id="cb168-5"><a href="#cb168-5"></a>            <span class="fu">aes</span>(<span class="at">label=</span><span class="dv">100</span><span class="sc">*</span>(<span class="fu">after_stat</span>(count)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">after_stat</span>(count))) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>), </span>
<span id="cb168-6"><a href="#cb168-6"></a>            <span class="at">group =</span> OECD), </span>
<span id="cb168-7"><a href="#cb168-7"></a>            <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.9</span>),</span>
<span id="cb168-8"><a href="#cb168-8"></a>            <span class="at">vjust=</span><span class="sc">-</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-126-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>Additionally, when we make graphs we often want to label the dataset, for example if we were to plot all the countries and their <code>PV1MATH</code> and <code>PV1READ</code> scores, we would get:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1"></a>plot_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb169-2"><a href="#cb169-2"></a>  <span class="fu">group_by</span>(OECD, CNT) <span class="sc">%&gt;%</span></span>
<span id="cb169-3"><a href="#cb169-3"></a>  <span class="fu">summarise</span>(<span class="at">m_read  =</span> <span class="fu">mean</span>(PV1READ, <span class="at">na.rm=</span><span class="st">"TRUE"</span>),</span>
<span id="cb169-4"><a href="#cb169-4"></a>            <span class="at">m_maths =</span> <span class="fu">mean</span>(PV1MATH, <span class="at">na.rm=</span><span class="st">"TRUE"</span>))</span>
<span id="cb169-5"><a href="#cb169-5"></a></span>
<span id="cb169-6"><a href="#cb169-6"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_data, </span>
<span id="cb169-7"><a href="#cb169-7"></a>       <span class="fu">aes</span>(<span class="at">x=</span>m_read, <span class="at">y=</span>m_maths, <span class="at">colour=</span>OECD)) <span class="sc">+</span></span>
<span id="cb169-8"><a href="#cb169-8"></a>  <span class="fu">geom_point</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-127-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>This looks great, but we don’t actually know which countries are which. To get this data we need to add text to the graph, using <code>geom_text</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_data, </span>
<span id="cb170-2"><a href="#cb170-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>m_read, <span class="at">y=</span>m_maths, <span class="at">colour=</span>OECD)) <span class="sc">+</span></span>
<span id="cb170-3"><a href="#cb170-3"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb170-4"><a href="#cb170-4"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>CNT), </span>
<span id="cb170-5"><a href="#cb170-5"></a>            <span class="at">colour=</span><span class="st">"black"</span>, </span>
<span id="cb170-6"><a href="#cb170-6"></a>            <span class="at">check_overlap =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-128-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>Here we have used <code>colour="black"</code> outside the <code>aes</code> to define the colour for all the labels, and <code>check_overlap = TRUE</code> which removes any labels that are on top of each other. It’s still a little bit hard to understand, and maybe we want to focus on just a few of the labels for countries we are interested in. For example</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1"></a><span class="co"># make a vector of countries you want to have labels for</span></span>
<span id="cb171-2"><a href="#cb171-2"></a>focus_cnt <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"United Kingdom"</span>, <span class="st">"France"</span>, <span class="st">"Argentina"</span>)</span>
<span id="cb171-3"><a href="#cb171-3"></a></span>
<span id="cb171-4"><a href="#cb171-4"></a><span class="co"># add a new column to the plot_data where these countries are</span></span>
<span id="cb171-5"><a href="#cb171-5"></a>plot_data <span class="ot">&lt;-</span> plot_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">focus =</span> CNT <span class="sc">%in%</span> focus_cnt)</span>
<span id="cb171-6"><a href="#cb171-6"></a></span>
<span id="cb171-7"><a href="#cb171-7"></a>plot_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 5
# Groups:   OECD [2]
   OECD  CNT                  m_read m_maths focus
   &lt;fct&gt; &lt;fct&gt;                 &lt;dbl&gt;   &lt;dbl&gt; &lt;lgl&gt;
 1 No    Albania                359.    368. FALSE
 2 No    United Arab Emirates   420.    434. FALSE
 3 No    Argentina              413.    389. TRUE 
 4 No    Bulgaria               405.    418. FALSE
 5 No    Brazil                 415.    380. FALSE
 6 No    Brunei Darussalam      428.    440. FALSE
 7 No    Dominican Republic     354.    340. FALSE
 8 No    Georgia                374.    390. FALSE
 9 No    Guatemala              377.    346. FALSE
10 No    Hong Kong (China)      504.    545. FALSE
# ℹ 70 more rows</code></pre>
</div>
</div>
<p>Now we can adjust out <code>geom_text</code> to only show those countries that we want to focus on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-67"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-67-1"><a href="#annotated-cell-67-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_data, </span>
<span id="annotated-cell-67-2"><a href="#annotated-cell-67-2"></a>       <span class="fu">aes</span>(<span class="at">x=</span>m_read, <span class="at">y=</span>m_maths, <span class="at">colour=</span>OECD)) <span class="sc">+</span></span>
<span id="annotated-cell-67-3"><a href="#annotated-cell-67-3"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-67-4" class="code-annotation-target"><a href="#annotated-cell-67-4"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>plot_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(focus <span class="sc">==</span> <span class="cn">TRUE</span>),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-67-5" class="code-annotation-target"><a href="#annotated-cell-67-5"></a>            <span class="fu">aes</span>(<span class="at">label=</span>CNT),</span>
<span id="annotated-cell-67-6"><a href="#annotated-cell-67-6"></a>            <span class="at">colour=</span><span class="st">"black"</span>, </span>
<span id="annotated-cell-67-7"><a href="#annotated-cell-67-7"></a>            <span class="at">check_overlap =</span> <span class="cn">TRUE</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-67" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="4" data-code-cell="annotated-cell-67" data-code-annotation="1">changes the data that is being passed to the <code>geom_text</code>, it no longer uses the data defined in the <code>ggplot</code> command, but has a new dataset, that is filtered on <code>focus == TRUE</code>, i.e.&nbsp;only containing the countries that we want.</span>
</dd>
<dt data-target-cell="annotated-cell-67" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="5" data-code-cell="annotated-cell-67" data-code-annotation="2">Note that the <code>x</code> and <code>y</code> mappings from line 2 are inherited by line 6, it’s only the data that we have redefined</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-130-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>geom_text</code> is great, but you might find that <code>ggrepel</code> package useful as it’ll add lines connecting the text the data points. Using the <code>plot_data</code> from above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb173-2"><a href="#cb173-2"></a></span>
<span id="cb173-3"><a href="#cb173-3"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_data, </span>
<span id="cb173-4"><a href="#cb173-4"></a>       <span class="fu">aes</span>(<span class="at">x=</span>m_read, <span class="at">y=</span>m_maths, <span class="at">colour=</span>OECD)) <span class="sc">+</span></span>
<span id="cb173-5"><a href="#cb173-5"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb173-6"><a href="#cb173-6"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data=</span>plot_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(focus <span class="sc">==</span> <span class="cn">TRUE</span>),</span>
<span id="cb173-7"><a href="#cb173-7"></a>            <span class="fu">aes</span>(<span class="at">label=</span>CNT),</span>
<span id="cb173-8"><a href="#cb173-8"></a>            <span class="at">box.padding =</span> <span class="fl">0.5</span>,</span>
<span id="cb173-9"><a href="#cb173-9"></a>            <span class="at">max.overlaps =</span> <span class="cn">Inf</span>,</span>
<span id="cb173-10"><a href="#cb173-10"></a>            <span class="at">colour=</span><span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-131-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="faceting" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> faceting</h1>
<p>Faceting allows you to easily create multiple graphs from one dataset and one ggplot definition by splitting the data on different factors, by defining:</p>
<p><code>facet_grid(&lt;column_to_split&gt; ~ .)</code></p>
<p>or</p>
<p><code>facet_grid(. ~ &lt;column_to_split&gt;)</code></p>
<p>Looking at the <code>PISA_2022</code> dataset, we can plot the <code>HOMEPOS</code> and reading test outcome <code>PV1READ</code> variables against each other:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1"></a><span class="co"># create a subset of the data for plotting</span></span>
<span id="cb174-2"><a href="#cb174-2"></a>plot_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span> </span>
<span id="cb174-3"><a href="#cb174-3"></a>  <span class="fu">select</span>(OECD, CNT, HOMEPOS, PV1READ) <span class="sc">%&gt;%</span></span>
<span id="cb174-4"><a href="#cb174-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Germany"</span>, </span>
<span id="cb174-5"><a href="#cb174-5"></a>                    <span class="st">"United Kingdom"</span>))</span>
<span id="cb174-6"><a href="#cb174-6"></a></span>
<span id="cb174-7"><a href="#cb174-7"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_data, <span class="fu">aes</span>(<span class="at">x=</span>HOMEPOS, <span class="at">y=</span>PV1READ)) <span class="sc">+</span> </span>
<span id="cb174-8"><a href="#cb174-8"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb174-9"><a href="#cb174-9"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb174-10"><a href="#cb174-10"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-132-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>But it isn’t clear how this graph varies between countries. We could try plotting separate graphs for each country, but there is a faster way, using:</p>
<p><code>+ facet_grid(CNT ~ .)</code></p>
<p>ggplot will automatically create graphs for subsets of <code>plot_data</code>, split on each different country in <code>CNT</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>plot_data, <span class="fu">aes</span>(<span class="at">x=</span>HOMEPOS, <span class="at">y=</span>PV1READ)) <span class="sc">+</span> </span>
<span id="cb175-2"><a href="#cb175-2"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb175-3"><a href="#cb175-3"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb175-4"><a href="#cb175-4"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb175-5"><a href="#cb175-5"></a>  <span class="fu">facet_grid</span>(CNT <span class="sc">~</span> .)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="01-2-Intro_tidyverse_files/figure-html/unnamed-chunk-133-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
<p>If the column you want to split on it on the left hand side of <code>facet_grid(CNT ~ .)</code>, then the graphs will be piled on top of each other, if it’s on the right hand side <code>facet_grid(. ~ CNT)</code>, then they’ll be side by side.</p>
<div class="question">
<p>Take a subset of the overall dataset, by filtering on a few countries, take another one of your plots and use <code>facet_grid(CNT ~ .)</code> to explore the graphs for different countries.</p>
</div>
<section id="exporting-plots" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="exporting-plots"><span class="header-section-number">13.1</span> Exporting plots</h2>
<p>ggplot can export data in a variety of formats suitable for printing, publication and the web. Once you have created a graph and stored it in an object <code>my_graph &lt;- ggplot(...</code>, the command to save the graph to your hard drive is:</p>
<p><code>ggsave(&lt;file_location_name_and_extension&gt;, &lt;object_name&gt;, width = 5, height = 4, device=&lt;file_ext&gt;)</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1"></a><span class="fu">ggsave</span>(<span class="st">"my_graph.pdf"</span>, my_graph, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">4</span>, <span class="at">device=</span><span class="st">"pdf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want to change the output format, just change the extension of the file you are saving:</p>
<ul>
<li>“poverty_size.pdf” perfect for publication and printing, potentially large file size</li>
<li>“poverty_size.svg” the same as pdf, also suitable for putting on webpages</li>
<li>“poverty_size.png” smaller file size, suitable for websites and presentations</li>
<li>“poverty_size.jpg” similar output to png</li>
</ul>
</section>
</section>
<section id="additional-support-on-graphing" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> Additional support on graphing</h1>
<section id="using-r-to-do-descriptive-statistics-and-plot-graphs" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="using-r-to-do-descriptive-statistics-and-plot-graphs"><span class="header-section-number">14.1</span> Using R to do descriptive statistics and plot graphs</h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/J6yN0y1sm5g?start=2" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
</iframe>
<p>You can find the code used in the video below:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1"></a><span class="co"># Introduction to plotting graphs</span></span>
<span id="cb177-2"><a href="#cb177-2"></a><span class="co">#</span></span>
<span id="cb177-3"><a href="#cb177-3"></a><span class="co"># Download data from /Users/k1765032/Library/CloudStorage/GoogleDrive-richardandrewbrock@gmail.com/.shortcut-targets-by-id/1c3CkaEBOICzepArDfjQUP34W2BYhFjM4/PISR/Data/PISA/subset/Students_2022_RBDP_none_levels.rds</span></span>
<span id="cb177-4"><a href="#cb177-4"></a><span class="co"># You want the file: Students_2022_RBDP_none_levels.rds</span></span>
<span id="cb177-5"><a href="#cb177-5"></a><span class="co"># and place in your own file system</span></span>
<span id="cb177-6"><a href="#cb177-6"></a><span class="co"># change loc to load the data directly. Loading into R might take a few minutes</span></span>
<span id="cb177-7"><a href="#cb177-7"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb177-8"><a href="#cb177-8"></a>loc <span class="ot">&lt;-</span> <span class="st">"/Users/k1765032/Library/CloudStorage/GoogleDrive-richardandrewbrock@gmail.com/.shortcut-targets-by-id/1c3CkaEBOICzepArDfjQUP34W2BYhFjM4/PISR/Data/PISA/subset/Students_2022_RBDP_none_levels.rds"</span></span>
<span id="cb177-9"><a href="#cb177-9"></a>PISA_2022 <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(loc)</span>
<span id="cb177-10"><a href="#cb177-10"></a></span>
<span id="cb177-11"><a href="#cb177-11"></a><span class="co"># Calculating means of groups</span></span>
<span id="cb177-12"><a href="#cb177-12"></a><span class="co"># The PISA_2022 dataframe is piped to a new dataframe MeanPISA</span></span>
<span id="cb177-13"><a href="#cb177-13"></a><span class="co"># The data are grouped by the country variable (CNT)</span></span>
<span id="cb177-14"><a href="#cb177-14"></a><span class="co"># The countries of interest are chosen (UK, France, Germany and the US)</span></span>
<span id="cb177-15"><a href="#cb177-15"></a><span class="co"># The summarise function is used to output the mean and standard deviation score for each country</span></span>
<span id="cb177-16"><a href="#cb177-16"></a><span class="co"># on the Science Plausible Value (PV1SCIE) and NAs are ignored na.rm=TRUE</span></span>
<span id="cb177-17"><a href="#cb177-17"></a></span>
<span id="cb177-18"><a href="#cb177-18"></a>MeanPISA <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb177-19"><a href="#cb177-19"></a>  <span class="fu">group_by</span>(CNT)  <span class="sc">%&gt;%</span></span>
<span id="cb177-20"><a href="#cb177-20"></a>  <span class="fu">filter</span>(CNT<span class="sc">==</span><span class="st">"United Kingdom"</span> <span class="sc">|</span> CNT<span class="sc">==</span> <span class="st">"France"</span> <span class="sc">|</span> CNT<span class="sc">==</span> <span class="st">"Germany"</span> <span class="sc">|</span> CNT<span class="sc">==</span><span class="st">"United States"</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb177-21"><a href="#cb177-21"></a>  <span class="fu">summarise</span>(<span class="at">mean_sci =</span> <span class="fu">mean</span>(PV1SCIE, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">sd_sci=</span> <span class="fu">sd</span>(PV1SCIE, <span class="at">na.rm=</span><span class="cn">TRUE</span>)) </span>
<span id="cb177-22"><a href="#cb177-22"></a><span class="fu">print</span>(MeanPISA)</span>
<span id="cb177-23"><a href="#cb177-23"></a></span>
<span id="cb177-24"><a href="#cb177-24"></a></span>
<span id="cb177-25"><a href="#cb177-25"></a><span class="co"># To plot data we can use the ggplot function. </span></span>
<span id="cb177-26"><a href="#cb177-26"></a><span class="co"># We will start by plotting a column graph use geom_col</span></span>
<span id="cb177-27"><a href="#cb177-27"></a><span class="co"># We specify the data set for ggplot to use (MeanPisa) and then </span></span>
<span id="cb177-28"><a href="#cb177-28"></a><span class="co"># define the x and y variables:</span></span>
<span id="cb177-29"><a href="#cb177-29"></a><span class="co"># ggplot(MeanPISA,</span></span>
<span id="cb177-30"><a href="#cb177-30"></a><span class="co">#       aes(x=CNT, y=mean_sci))</span></span>
<span id="cb177-31"><a href="#cb177-31"></a><span class="co"># geom_col() (Note the plus is on the line before) plots the graph and the fill colour is set to red</span></span>
<span id="cb177-32"><a href="#cb177-32"></a><span class="co"># The next three lines set the formatting of the axis text and add x and y axis labels</span></span>
<span id="cb177-33"><a href="#cb177-33"></a></span>
<span id="cb177-34"><a href="#cb177-34"></a><span class="fu">ggplot</span>(MeanPISA,</span>
<span id="cb177-35"><a href="#cb177-35"></a>       <span class="fu">aes</span>(<span class="at">x=</span>CNT, <span class="at">y=</span>mean_sci))<span class="sc">+</span></span>
<span id="cb177-36"><a href="#cb177-36"></a><span class="fu">geom_col</span>(<span class="at">fill=</span><span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb177-37"><a href="#cb177-37"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust=</span><span class="fl">0.95</span>, <span class="at">vjust=</span><span class="fl">0.2</span>, <span class="at">size=</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb177-38"><a href="#cb177-38"></a>  <span class="fu">xlab</span>(<span class="st">"Country"</span>) <span class="sc">+</span></span>
<span id="cb177-39"><a href="#cb177-39"></a>  <span class="fu">ylab</span>(<span class="st">"Science Score"</span>)</span>
<span id="cb177-40"><a href="#cb177-40"></a></span>
<span id="cb177-41"><a href="#cb177-41"></a><span class="co"># For plotting a scatter plot or PISA reading scores against science scores</span></span>
<span id="cb177-42"><a href="#cb177-42"></a><span class="co">#, first we make a managable data set</span></span>
<span id="cb177-43"><a href="#cb177-43"></a><span class="co"># I will filter the data set to include only the UK data</span></span>
<span id="cb177-44"><a href="#cb177-44"></a><span class="co"># and remove any NAs</span></span>
<span id="cb177-45"><a href="#cb177-45"></a></span>
<span id="cb177-46"><a href="#cb177-46"></a>UKData <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb177-47"><a href="#cb177-47"></a>  <span class="fu">filter</span>(CNT<span class="sc">==</span><span class="st">"United Kingdom"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb177-48"><a href="#cb177-48"></a>  <span class="fu">drop_na</span>(PV1SCIE)</span>
<span id="cb177-49"><a href="#cb177-49"></a></span>
<span id="cb177-50"><a href="#cb177-50"></a><span class="co"># This time I will use ggplot to plot a scatter graph</span></span>
<span id="cb177-51"><a href="#cb177-51"></a><span class="co"># I feed UKDATA to ggplot, specify the x (PISA Reading score)</span></span>
<span id="cb177-52"><a href="#cb177-52"></a><span class="co"># And y (PISA science score). This time, I have linked the colour</span></span>
<span id="cb177-53"><a href="#cb177-53"></a><span class="co"># to a variable (ST004D01T) which is the gender value, giving</span></span>
<span id="cb177-54"><a href="#cb177-54"></a><span class="co"># plot points of different colours for boys and girls</span></span>
<span id="cb177-55"><a href="#cb177-55"></a><span class="co"># To produce a scatter plot, I use geom_point to plot points,</span></span>
<span id="cb177-56"><a href="#cb177-56"></a><span class="co"># Giving the size of point and the transparency (alpha=0.5) -</span></span>
<span id="cb177-57"><a href="#cb177-57"></a><span class="co"># some transparency of points is helpful when plots become dense</span></span>
<span id="cb177-58"><a href="#cb177-58"></a><span class="co"># The x and y lables are added</span></span>
<span id="cb177-59"><a href="#cb177-59"></a><span class="co"># Finally, a line is plotted - geom_smooth(method='lm')</span></span>
<span id="cb177-60"><a href="#cb177-60"></a><span class="co"># sets the line to a linear ('lm') line</span></span>
<span id="cb177-61"><a href="#cb177-61"></a></span>
<span id="cb177-62"><a href="#cb177-62"></a>  <span class="fu">ggplot</span>(UKData,</span>
<span id="cb177-63"><a href="#cb177-63"></a>       <span class="fu">aes</span>(<span class="at">x=</span>PV1READ, <span class="at">y=</span>PV1SCIE, <span class="at">colour=</span>ST004D01T)) <span class="sc">+</span></span>
<span id="cb177-64"><a href="#cb177-64"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">0.1</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb177-65"><a href="#cb177-65"></a>  <span class="fu">ylab</span>(<span class="st">"Science Score"</span>) <span class="sc">+</span></span>
<span id="cb177-66"><a href="#cb177-66"></a>  <span class="fu">xlab</span>(<span class="st">"Reading Score"</span>) <span class="sc">+</span></span>
<span id="cb177-67"><a href="#cb177-67"></a>  <span class="fu">geom_smooth</span>(<span class="at">method=</span><span class="st">'lm'</span>)</span>
<span id="cb177-68"><a href="#cb177-68"></a>  </span>
<span id="cb177-69"><a href="#cb177-69"></a><span class="co"># Where R becomes very powerful is being able to produce multiple charts rapidly</span></span>
<span id="cb177-70"><a href="#cb177-70"></a><span class="co"># In the code below, I plot reading against science scores as above, but this time</span></span>
<span id="cb177-71"><a href="#cb177-71"></a><span class="co"># Use the entire data set - for the whole world!</span></span>
<span id="cb177-72"><a href="#cb177-72"></a><span class="co"># All the steps are the same, except, I use the facet_wrap, a way to create multiple</span></span>
<span id="cb177-73"><a href="#cb177-73"></a><span class="co"># graph panels - the instruction creates a set of graphs for each country  </span></span>
<span id="cb177-74"><a href="#cb177-74"></a>  </span>
<span id="cb177-75"><a href="#cb177-75"></a>  WorldData <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb177-76"><a href="#cb177-76"></a>    <span class="fu">drop_na</span>(PV1SCIE)</span>
<span id="cb177-77"><a href="#cb177-77"></a>  </span>
<span id="cb177-78"><a href="#cb177-78"></a>  <span class="fu">ggplot</span>(WorldData,</span>
<span id="cb177-79"><a href="#cb177-79"></a>         <span class="fu">aes</span>(<span class="at">x=</span>PV1READ, <span class="at">y=</span>PV1SCIE, <span class="at">colour=</span>ST004D01T)) <span class="sc">+</span></span>
<span id="cb177-80"><a href="#cb177-80"></a>    <span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">0.1</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb177-81"><a href="#cb177-81"></a>    <span class="fu">ylab</span>(<span class="st">"Science Score"</span>) <span class="sc">+</span></span>
<span id="cb177-82"><a href="#cb177-82"></a>    <span class="fu">xlab</span>(<span class="st">"Reading Score"</span>) <span class="sc">+</span></span>
<span id="cb177-83"><a href="#cb177-83"></a>    <span class="fu">geom_smooth</span>(<span class="at">method=</span><span class="st">'lm'</span>) <span class="sc">+</span></span>
<span id="cb177-84"><a href="#cb177-84"></a>    <span class="fu">facet_wrap</span>(CNT<span class="sc">~</span>.)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Even in this cut down format the PISA data might take a few minutes to load. You can find the full dataset <a href="https://drive.google.com/open?id=17AYuiKXxWFY6XkJZRCFXRYRRNNmata-f&amp;usp=drive_fs">here</a>, but be warned, it might crash you machine when trying to load it! Plug your laptop into a power supply, and having 16GB of RAM is highly recommended! You might also need to wrangle some of the fields to make them work for your purposes, you might enjoy the challenge!<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>