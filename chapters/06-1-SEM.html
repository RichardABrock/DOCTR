<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SEM – DOCTR</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-efa436e0f7c31c3db514b203e84dc250.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../css/mastemr.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="index.qmd" class="navbar-brand navbar-brand-logo">
    <img src="../images/KCL_logo.png" alt="" class="navbar-logo light-content">
    <img src="../images/KCL_logo.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="index.qmd">
    <span class="navbar-title">DOCTR</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/05-Correlation_and_regression.html">Intermediate R</a></li><li class="breadcrumb-item"><a href="../chapters/06-1-SEM.html">SEM</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Introduction to R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-1-Loading_R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-2-Intro_tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Loading packages and exploring data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-1-Descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Descriptive Statistics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-2-ChisqPISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hypothesis testing and Chi-square tests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-3-T-testsPISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">T-tests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-Intro_to_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Making graphs</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Self-test for Intermediate R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-self_assessment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self assessment questions</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Intermediate R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-Correlation_and_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Correlation and regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-1-SEM.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">SEM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-Rpublications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Publishing using R and quarto</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendicies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-PISA_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PISA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-DfE_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DfE England</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A3-TIMSS_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TIMSS, PIRLS and ICILS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A4-Other_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A5-Self_Study_Tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self Study Tasks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A6-selecting_statistical_tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Selecting statistical tools</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A7-QandA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Questions and Answers</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#structural-equation-modelling" id="toc-structural-equation-modelling" class="nav-link active" data-scroll-target="#structural-equation-modelling"><span class="header-section-number">1</span> Structural Equation Modelling</a>
  <ul class="collapse">
  <li><a href="#assummptions-of-sem" id="toc-assummptions-of-sem" class="nav-link" data-scroll-target="#assummptions-of-sem"><span class="header-section-number">1.1</span> Assummptions of SEM</a></li>
  <li><a href="#checks-to-carry-out-before-fitting-an-sem" id="toc-checks-to-carry-out-before-fitting-an-sem" class="nav-link" data-scroll-target="#checks-to-carry-out-before-fitting-an-sem"><span class="header-section-number">1.2</span> Checks to carry out before fitting an SEM</a>
  <ul class="collapse">
  <li><a href="#the-steps-to-fitting-an-sem-model" id="toc-the-steps-to-fitting-an-sem-model" class="nav-link" data-scroll-target="#the-steps-to-fitting-an-sem-model"><span class="header-section-number">1.2.1</span> The steps to fitting an SEM model</a></li>
  <li><a href="#a-simple-structural-model" id="toc-a-simple-structural-model" class="nav-link" data-scroll-target="#a-simple-structural-model"><span class="header-section-number">1.2.2</span> A simple structural model</a></li>
  </ul></li>
  <li><a href="#model-syntax" id="toc-model-syntax" class="nav-link" data-scroll-target="#model-syntax"><span class="header-section-number">1.3</span> Model Syntax</a>
  <ul class="collapse">
  <li><a href="#modelling-a-latent-variable" id="toc-modelling-a-latent-variable" class="nav-link" data-scroll-target="#modelling-a-latent-variable"><span class="header-section-number">1.3.1</span> Modelling a latent variable</a></li>
  </ul></li>
  <li><a href="#models-with-categorical-variables" id="toc-models-with-categorical-variables" class="nav-link" data-scroll-target="#models-with-categorical-variables"><span class="header-section-number">1.4</span> Models with categorical variables</a></li>
  <li><a href="#labelling-paths-to-calculate-indirect-effects" id="toc-labelling-paths-to-calculate-indirect-effects" class="nav-link" data-scroll-target="#labelling-paths-to-calculate-indirect-effects"><span class="header-section-number">1.5</span> Labelling paths to calculate indirect effects</a></li>
  <li><a href="#formatting-path-diagrams" id="toc-formatting-path-diagrams" class="nav-link" data-scroll-target="#formatting-path-diagrams"><span class="header-section-number">1.6</span> Formatting path diagrams</a></li>
  <li><a href="#estimating-model-fit" id="toc-estimating-model-fit" class="nav-link" data-scroll-target="#estimating-model-fit"><span class="header-section-number">1.7</span> Estimating model fit</a>
  <ul class="collapse">
  <li><a href="#local-fit" id="toc-local-fit" class="nav-link" data-scroll-target="#local-fit"><span class="header-section-number">1.7.1</span> Local fit</a></li>
  </ul></li>
  <li><a href="#improving-model-fit" id="toc-improving-model-fit" class="nav-link" data-scroll-target="#improving-model-fit"><span class="header-section-number">1.8</span> Improving model fit</a>
  <ul class="collapse">
  <li><a href="#reporting-the-model" id="toc-reporting-the-model" class="nav-link" data-scroll-target="#reporting-the-model"><span class="header-section-number">1.8.1</span> Reporting the model</a></li>
  </ul></li>
  <li><a href="#seminar-activities" id="toc-seminar-activities" class="nav-link" data-scroll-target="#seminar-activities"><span class="header-section-number">1.9</span> Seminar activities</a>
  <ul class="collapse">
  <li><a href="#task-1---create-a-model-of-science-score" id="toc-task-1---create-a-model-of-science-score" class="nav-link" data-scroll-target="#task-1---create-a-model-of-science-score"><span class="header-section-number">1.9.1</span> Task 1 - create a model of science score</a></li>
  <li><a href="#task-2---simple-models-of-achievement" id="toc-task-2---simple-models-of-achievement" class="nav-link" data-scroll-target="#task-2---simple-models-of-achievement"><span class="header-section-number">1.9.2</span> Task 2 - simple models of achievement</a></li>
  <li><a href="#task-3---a-model-with-a-latent-variable" id="toc-task-3---a-model-with-a-latent-variable" class="nav-link" data-scroll-target="#task-3---a-model-with-a-latent-variable"><span class="header-section-number">1.9.3</span> Task 3 - a model with a latent variable</a></li>
  <li><a href="#task-4---a-more-complex-latent-variable" id="toc-task-4---a-more-complex-latent-variable" class="nav-link" data-scroll-target="#task-4---a-more-complex-latent-variable"><span class="header-section-number">1.9.4</span> Task 4 - a more complex latent variable</a></li>
  <li><a href="#task-5---models-with-categorical-variables" id="toc-task-5---models-with-categorical-variables" class="nav-link" data-scroll-target="#task-5---models-with-categorical-variables"><span class="header-section-number">1.9.5</span> Task 5 - models with categorical variables</a></li>
  <li><a href="#task-6---models-with-categorical-variables" id="toc-task-6---models-with-categorical-variables" class="nav-link" data-scroll-target="#task-6---models-with-categorical-variables"><span class="header-section-number">1.9.6</span> Task 6 - models with categorical variables</a></li>
  <li><a href="#task-7---model-checks-and-improvements" id="toc-task-7---model-checks-and-improvements" class="nav-link" data-scroll-target="#task-7---model-checks-and-improvements"><span class="header-section-number">1.9.7</span> Task 7 - model checks and improvements</a></li>
  <li><a href="#task-8---report-factor-loadings-and-r2-for-your-model" id="toc-task-8---report-factor-loadings-and-r2-for-your-model" class="nav-link" data-scroll-target="#task-8---report-factor-loadings-and-r2-for-your-model"><span class="header-section-number">1.9.8</span> Task 8 - report factor loadings and R<sup>2</sup> for your model</a></li>
  <li><a href="#task-9---create-your-own-model-of-overall-achievement-in-hong-kong-china" id="toc-task-9---create-your-own-model-of-overall-achievement-in-hong-kong-china" class="nav-link" data-scroll-target="#task-9---create-your-own-model-of-overall-achievement-in-hong-kong-china"><span class="header-section-number">1.9.9</span> Task 9 - create your own model of overall achievement in Hong Kong (China)</a></li>
  </ul></li>
  <li><a href="#further-information" id="toc-further-information" class="nav-link" data-scroll-target="#further-information"><span class="header-section-number">1.10</span> Further information</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/05-Correlation_and_regression.html">Intermediate R</a></li><li class="breadcrumb-item"><a href="../chapters/06-1-SEM.html">SEM</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">SEM</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="structural-equation-modelling" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Structural Equation Modelling</h1>
<p>Structural Equation Modelling (SEM) is an approach to representing the correlations between a number of variables linked to some phenomenon <span class="citation" data-cites="lomax2013introduction">(<a href="#ref-lomax2013introduction" role="doc-biblioref">Lomax 2013</a>)</span>. A dependent variable (for example, scores on some test) might be linked to a number of independent variables (for example, hours of study, teacher’s level of experience, etc.). A powerful aspect of SEM is that it can be used to construct latent variables - variables which have explanatory usefulness but can’t be measured directly - out of a number of independent variables. Variables researchers can measure are called manifest variables, for example, mathematics, science and reading scores are manifest variables. These three scores might be taken to indicate intelligence, a latent variable, which can’t be measured directly.</p>
<p>To take another case, a researcher might wish to investigate how home environment impacts students’ mathematics achievement. There is no single variable, no single score, that can be measured to represent a young person’s home environment as 7/10 or 3/10. We might then consider their home environment a latent variable. We imagine that the nature of the circumstances in their home impacts their learning, but we cannot directly report the level of the home environment as a variable.</p>
<p>SEM allows us to propose a latent variable, like home environment, and calculate the contribution of a number of variables we can measure (e.g.&nbsp;the number of books in the home, parents’ occupation and level of education, family wealth, etc.) to the latent variable.</p>
<section id="assummptions-of-sem" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="assummptions-of-sem"><span class="header-section-number">1.1</span> Assummptions of SEM</h2>
<p>SEM is based on a number of assumptions:</p>
<ol type="a">
<li>Independence - the Observations are assumed to be independent of each other</li>
<li>No Perfect Multicollinearity - the independent variables are not perfectly correlated</li>
<li>Homoscedasticity - the variance of the residuals is constant</li>
<li>No multicollinearity - the independent variables are not highly correlated <span class="citation" data-cites="hoyle2012handbook">(<a href="#ref-hoyle2012handbook" role="doc-biblioref">Hoyle 2012</a>)</span></li>
<li>Sample size - a large enough sample size to ensure the model is stable - assuming a common power level of 80% and significance levels of 0.05, and minimum path coefficient of 0.2, a sample size of 155 is required <span class="citation" data-cites="hair2021partial">(<a href="#ref-hair2021partial" role="doc-biblioref">Hair Jr et al. 2021</a>)</span></li>
</ol>
</section>
<section id="checks-to-carry-out-before-fitting-an-sem" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="checks-to-carry-out-before-fitting-an-sem"><span class="header-section-number">1.2</span> Checks to carry out before fitting an SEM</h2>
<p>Before fitting an SEM, it is important to check the data for a number of issues. These include:</p>
<ol type="a">
<li>Checking for multivariate normality - SEM assumes that the data is multivariate normally distributed. This can be checked using the <code>mvn</code> function in the <code>MVN</code> package.</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-1-1"><a href="#annotated-cell-1-1"></a><span class="co"># Create a subset of PISA data related to the UK containing the dependent variable of interest (PV1MATH) and the independent variables we are interested in</span></span>
<span id="annotated-cell-1-2"><a href="#annotated-cell-1-2"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-1-3" class="code-annotation-target"><a href="#annotated-cell-1-3"></a>UKdata <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-1-4" class="code-annotation-target"><a href="#annotated-cell-1-4"></a>  <span class="fu">select</span>(CNT, PV1SCIE, PV1MATH, PV1READ) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-1-5" class="code-annotation-target"><a href="#annotated-cell-1-5"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)</span>
<span id="annotated-cell-1-6"><a href="#annotated-cell-1-6"></a>                                                        </span>
<span id="annotated-cell-1-7"><a href="#annotated-cell-1-7"></a></span>
<span id="annotated-cell-1-8"><a href="#annotated-cell-1-8"></a><span class="co"># load the MVN package to check for multivariate normality</span></span>
<span id="annotated-cell-1-9"><a href="#annotated-cell-1-9"></a><span class="fu">library</span>(MVN)</span>
<span id="annotated-cell-1-10"><a href="#annotated-cell-1-10"></a></span>
<span id="annotated-cell-1-11"><a href="#annotated-cell-1-11"></a><span class="co"># Check for multivariate normality using the Mardia test</span></span>
<span id="annotated-cell-1-12"><a href="#annotated-cell-1-12"></a><span class="co"># note we drop the country and gender variable as they are not numeric and</span></span>
<span id="annotated-cell-1-13"><a href="#annotated-cell-1-13"></a><span class="co"># omitting nas</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-1-14" class="code-annotation-target"><a href="#annotated-cell-1-14"></a>mvn_result <span class="ot">&lt;-</span> <span class="fu">mvn</span>(<span class="at">data =</span> UKdata <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>CNT) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>())</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-1-15" class="code-annotation-target"><a href="#annotated-cell-1-15"></a>mvn_result<span class="sc">$</span>multivariate_normality</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="3" data-code-annotation="1">line 1 passes the whole <code>PISA_2022</code> dataset and pipes it into the next line using <code>%&gt;%</code></span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="4" data-code-annotation="2">line 2 selects the variables of interest</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="5" data-code-annotation="3">line 3 filters for the UK</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="14" data-code-annotation="4">line 4 runs the test of multivariate normality removing the CNT column and omitting missing data</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="15" data-code-annotation="5">line 5 outputs the necessary statistics</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>           Test Statistic p.value     Method          MVN
1 Henze-Zirkler     2.587  &lt;0.001 asymptotic ✗ Not normal</code></pre>
</div>
</div>
<p>To interpret the output, look at the p-value of the Henze-Zirkler’s multivariate normality test. If the p-value is greater than 0.05, the data is considered to be multivariate normally distributed. If the p-value is less than 0.05, the data is not multivariate normally distributed.</p>
<p>You can also use qq plots to visually inspect the data for multivariate normality.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Create QQ plots to visually inspect for multivariate normality</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">multivariate_diagnostic_plot</span>(<span class="at">data =</span> UKdata <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>CNT) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>(),</span>
<span id="cb2-3"><a href="#cb2-3"></a>                             <span class="at">type =</span> <span class="st">"qq"</span>)                             </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>The QQ plots show that the data does not follow a straight line, indicating that the data is not multivariate normally distributed.</p>
<p>In this case the assumption is not met. This might be due to the large sample size. If the sample size is large, the assumption of multivariate normality can be relaxed. However, if the sample size is small, it is important to check for multivariate normality. However, for a small sample, if the assumption is not met, a form of SEM estimation can be used which does not assume multivariate normality, such as the Weighted Least Squares Mean and Variance adjusted (WLSMV) estimator or the robust estimation method (MLR). These methods are discussed below.</p>
<ol start="2" type="a">
<li>Checking for linearity - SEM assumes that the relationships between the variables are linear. This can be checked using scatterplots or correlation matrices. If the relationships are not linear, the data may need to be transformed or a different model may need to be used.</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1"></a><span class="co"># Create a scatterplot matrix to check for linearity</span></span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2"></a><span class="fu">library</span>(GGally)</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-3-4" class="code-annotation-target"><a href="#annotated-cell-3-4"></a><span class="fu">ggpairs</span>(UKdata <span class="sc">%&gt;%</span> <span class="fu">select</span>(PV1SCIE, PV1MATH, PV1READ),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-3-5" class="code-annotation-target"><a href="#annotated-cell-3-5"></a>        <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">"points"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="4" data-code-annotation="1">line 1 passes the UK data frame to the <code>ggpairs</code> function, selecting the variables of interest</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="5" data-code-annotation="2">line 2 specifies that the lower triangle of the scatterplot matrix should be plotted as points with some transparency (alpha = 0.5) to make it easier to see the density of points</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>There appear to be linear relationships between the variables PV1MATH, PV1READ and PV1SCIE, but there are some outliers.</p>
<ol start="3" type="a">
<li>No multicollinearity - SEM assumes that the independent variables are not highly correlated. This can be checked using the Variance Inflation Factor (VIF). A VIF value greater than 10 indicates high multicollinearity.</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1"></a><span class="co"># Load the car package to check for multicollinearity</span></span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2"></a><span class="fu">library</span>(car)</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3"></a><span class="co"># Calculate the VIF for the independent variables</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-4-4" class="code-annotation-target"><a href="#annotated-cell-4-4"></a>vif_values <span class="ot">&lt;-</span> <span class="fu">vif</span>(<span class="fu">lm</span>(PV1MATH <span class="sc">~</span> PV1SCIE <span class="sc">+</span> PV1READ, <span class="at">data =</span> UKdata))</span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5"></a><span class="co"># Print the VIF values</span></span>
<span id="annotated-cell-4-6"><a href="#annotated-cell-4-6"></a>vif_values</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="4" data-code-annotation="1">line 1 fits a linear model to the data, using <code>lm</code>, with <code>PV1MATH</code> as the dependent variable and <code>PV1SCIE</code> and <code>PV1READ</code> as independent variables. This is like performing a test regression analysis to check for multicollinearity before performing the SEM.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> PV1SCIE  PV1READ 
2.615497 2.615497 </code></pre>
</div>
</div>
<p>A VIF value greater than 10 indicates high multicollinearity. In this case, the VIF values for <code>PV1SCIE</code> and <code>PV1READ</code> are both less than 10, indicating that there is no high multicollinearity between the independent variables.</p>
<ol start="4" type="a">
<li>Checking for outliers - SEM is sensitive to outliers, so it is important to check for outliers before fitting the model. This can be done using boxplots or scatterplots. If there are outliers, they may need to be removed or transformed.</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Create boxplots to check for outliers</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="fu">ggplot</span>(UKdata, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> PV1MATH)) <span class="sc">+</span> </span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of PV1MATH"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"PV1MATH"</span>) <span class="sc">+</span> </span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">ggplot</span>(UKdata, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> PV1SCIE)) <span class="sc">+</span> </span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of PV1SCIE"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"PV1SCIE"</span>) <span class="sc">+</span> </span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">ggplot</span>(UKdata, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> PV1READ)) <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of PV1READ"</span>, <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"PV1READ"</span>) <span class="sc">+</span> </span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-6-3.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>The boxplots show that there are some outliers in the data, particularly for <code>PV1MATH</code> and <code>PV1SCIE</code>. These outliers may need to be removed or transformed before fitting the SEM model.</p>
<p>One approach to dealing with outliers is to remove them from the data set. This can be done using the <code>dplyr</code> package in R. For example, to remove outliers from <code>PV1MATH</code>, we can use the <code>filter</code> function to keep only those values that are within 1.5 times the interquartile range (IQR) of the median.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1"></a><span class="co"># Remove outliers from PV1MATH and PV1SCIE</span></span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2"></a>UKdata <span class="ot">&lt;-</span> UKdata <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3"></a>  <span class="fu">filter</span>(PV1MATH <span class="sc">&gt;</span> (<span class="fu">quantile</span>(PV1MATH, <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> <span class="fu">IQR</span>(PV1MATH)) <span class="sc">&amp;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-8-4" class="code-annotation-target"><a href="#annotated-cell-8-4"></a>         PV1MATH <span class="sc">&lt;</span> (<span class="fu">quantile</span>(PV1MATH, <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> <span class="fu">IQR</span>(PV1MATH)))</span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5"></a></span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6"></a>UKdata <span class="ot">&lt;-</span> UKdata <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7"></a>  <span class="fu">filter</span>(PV1MATH <span class="sc">&gt;</span> (<span class="fu">quantile</span>(PV1SCIE, <span class="fl">0.25</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> <span class="fu">IQR</span>(PV1MATH)) <span class="sc">&amp;</span> </span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8"></a>         PV1MATH <span class="sc">&lt;</span> (<span class="fu">quantile</span>(PV1SCIE, <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> <span class="fu">IQR</span>(PV1MATH)))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="4,8" data-code-annotation="1">line 1 uses the <code>filter</code> function to keep only those values of <code>PV1MATH</code> that are within 1.5 times the interquartile range (IQR) of the median.</span>
</dd>
</dl>
</div>
</div>
<p>This removes the outliers from the <code>PV1MATH</code> variable. The same process is used to remove outliers from the <code>PV1SCIE</code> variable.</p>
<ol start="5" type="a">
<li>Checking for missing data - SEM requires complete data, so it is important to check for missing data before fitting the model. This can be done using the <code>mice</code> package. If there is missing data, it may need to be imputed or removed.</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Load the `mice` package to check for missing data</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">library</span>(mice)</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co"># Check for missing data using Little's MCAR test</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="fu">md.pattern</span>(UKdata)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> /\     /\
{  `---'  }
{  O   O  }
==&gt;  V &lt;==  No need for mice. This data set is completely observed.
 \  \|/  /
  `-----'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>      CNT PV1SCIE PV1MATH PV1READ  
12935   1       1       1       1 0
        0       0       0       0 0</code></pre>
</div>
</div>
<p>In this case there are no missing data. If data were missing, the <code>mice</code> package could be used to impute the missing data. Imputation is the process of replacing missing data with estimated values based on the observed data. The <code>mice</code> package provides a number of methods for imputing missing data, including predictive mean matching, Bayesian linear regression, and others. For example, the simplest approach to imputation is to replace all missing values with the mean of the variable.</p>
<p>An alternative to imputation using mice is to use Full Information Maximum Likelihood (FIML) estimation, which uses all available data to estimate the model parameters without imputing missing values. FIML is implemented in the <code>lavaan</code> package by setting the <code>missing</code> argument to <code>"FIML"</code> when fitting the model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># Applying FIML estimation in lavaan</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>model<span class="ot">&lt;-</span><span class="st">"PV1MATH ~ PV1SCIE + PV1READ + ESCS + HOMEPOS"</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>fit <span class="ot">&lt;-</span> <span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">missing =</span> <span class="st">"FIML"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="the-steps-to-fitting-an-sem-model" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="the-steps-to-fitting-an-sem-model"><span class="header-section-number">1.2.1</span> The steps to fitting an SEM model</h3>
<p>The typical steps taken when fitting an SEM model are shown below (see Figure 5.1 in <span class="citation" data-cites="kline2023principles">(<a href="#ref-kline2023principles" role="doc-biblioref">Kline 2023</a>)</span>):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="diagram.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
<p>Researchers typically begin by specifying a model, that is setting out the setting out the relationships theory suggest exists between variables. Specification is an important steps as the following stages assume the model is correct. model identification is the process of determining if a model can be estimated from available data. If the model is not identified, the researcher must go back to the model specification stage and make changes. If the model is identified, the researcher can move on to collecting data. Once data are collected, the model is estimated and the fit of the model is assessed (multiple approaches to assessing model fit are discussed below). If the model does not fit the data well, the researcher may need to respecify the model. If the model fits the data well, the researcher can interpret the estimates and consider equivalent models. For any model, there may be many (perhaps infintely many) other models that fit the data equally well.Finally, the researcher reports the results.</p>
</section>
<section id="a-simple-structural-model" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="a-simple-structural-model"><span class="header-section-number">1.2.2</span> A simple structural model</h3>
<p>Researchers use SEM to determine the correlations between a number of variable in a data set. It allows the relationship between multiple variables to be taken into account.</p>
<p>For example, in the PISA data set, in the context of data related to UK students achievement in mathematics, a researcher might be interested in building a model of mathematics (<code>PV1MATH</code>) score by a number of variables in the data set, for example, reading score (<code>PV1READ</code>), science score (<code>PV1SCIE</code>), family cultural capital (the index of economic, social and cultural status: <code>ESCS</code>), wealth (<code>WEALTH</code>) and gender (<code>ST004D01T</code>). SEM can be used to represent the relationship between these variables and students’ mathematics achievement.</p>
<p>To create the SEM we will use the <code>lavaan</code> package - <code>lavaan</code> is a contraction of Latent Variable Analysis and allows us to fit a number of different SEMs to data. We will also use the <code>semPlot</code> package to visualise the results. The relationships between variables in SEMs are often represented as path diagrams - representations in which variables are represented as squares or circles and arrows labelled with correlation coefficients join the variables to represent the relationships.<code>semPlot</code> allows us to draw path diagrams.</p>
</section>
</section>
<section id="model-syntax" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="model-syntax"><span class="header-section-number">1.3</span> Model Syntax</h2>
<p>Consider the SEM introduced above - a model of the variables that impact students’ mathematics scores.</p>
<p>To create the SEM of UK mathematics achievement we first create a subset <code>data.frame</code> of UK data, <code>UKdata</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1"></a><span class="co"># Load lavaan to create the SEM and semPlot to draw path diagrams</span></span>
<span id="annotated-cell-11-2"><a href="#annotated-cell-11-2"></a></span>
<span id="annotated-cell-11-3"><a href="#annotated-cell-11-3"></a><span class="fu">library</span>(lavaan)</span>
<span id="annotated-cell-11-4"><a href="#annotated-cell-11-4"></a><span class="fu">library</span>(semPlot)</span>
<span id="annotated-cell-11-5"><a href="#annotated-cell-11-5"></a></span>
<span id="annotated-cell-11-6"><a href="#annotated-cell-11-6"></a><span class="co"># Create a subset of PISA data related to the UK containing the dependent variable of interest (PV1MATH) and the independent variables we are interested in</span></span>
<span id="annotated-cell-11-7"><a href="#annotated-cell-11-7"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-11-8" class="code-annotation-target"><a href="#annotated-cell-11-8"></a>UKdata <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-11-9" class="code-annotation-target"><a href="#annotated-cell-11-9"></a>  <span class="fu">select</span>(CNT, PV1SCIE, PV1MATH, PV1READ, ESCS, HOMEPOS, ST004D01T) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-11-10" class="code-annotation-target"><a href="#annotated-cell-11-10"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="8" data-code-annotation="1">line 1 passes the whole <code>PISA_2022</code> dataset and pipes it into the next line using <code>%&gt;%</code></span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="9" data-code-annotation="2">line 2 selects the variables of interest</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="10" data-code-annotation="3">line 3 filters for the UK</span>
</dd>
</dl>
</div>
</div>
<p>The first step is to create the model. Models in <code>lavaan</code> are represented as a dependent variable <code>y</code>, linked to a number of independent variables <code>x1</code>, <code>x2</code>, <code>x3</code>, etc. The <code>~</code> symbol is the regression operator. A simple regression formula might then take the form of:</p>
<p>y ~ x1 + x2 + x3</p>
<p>To indicate a variable is a latent variable we use the <code>=~</code> operator. So to define a model in which the latent variable <code>f1</code> varies with three independent variables we would write:</p>
<p>f1 =~ x1 + x2 + x3</p>
<p>In some cases, the independent variables may correlate. For example, if we are investigating mathematics achievement (the dependent variable, <code>y</code>), by looking at the independent variables of reading (<code>x1</code>) and science score (<code>x2</code>), it may be the case that reading and science cores covary (that is changes to one impacts the other). In this case, we can specify covariance in our model by stating:</p>
<p>y ~ x1 + x2 The regression model x1 ~ x2 Indicating the covariance</p>
<p>In our case, considering UK mathematics achievement, we can set up a model that mathematics score <code>PV1MATH</code> varies with science score <code>PV1SCIE</code>, reading score <code>PV1READ</code>, cultural resources in the home <code>ESCS</code>, a wealth proxy measure, HOMEPOS: <code>model &lt;- "PV1MATH ~ PV1SCIE + PV1READ + ESCS + HOMEPOS"</code></p>
<p>We then pass the model, and the <code>data.frame</code> to the <code>sem</code> function: <code>fit&lt;-sem(model, data=UKdata, estimator = "MLR")</code>. This produces a model as the output <code>fit</code>. To see the results we call <code>summary(fit)</code></p>
<p>Note that, as the data violated the check of multivariate normality above, we need to set the estimator to <code>"MLR"</code> (Maximum Likelihood with Robust standard errors). This estimator does not assume multivariate normality and is robust to violations of this assumption.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-12-1" class="code-annotation-target"><a href="#annotated-cell-12-1"></a>model<span class="ot">&lt;-</span><span class="st">"PV1MATH ~ PV1SCIE + PV1READ + ESCS + HOMEPOS"</span></span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-12-3" class="code-annotation-target"><a href="#annotated-cell-12-3"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<span id="annotated-cell-12-4"><a href="#annotated-cell-12-4"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-12-5" class="code-annotation-target"><a href="#annotated-cell-12-5"></a><span class="fu">summary</span>(fit)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="1" data-code-annotation="1">line 1 specify the model - we want to model PV1MATH using PV1SCIE, PV1READ, ESCS (class proxy) and HOMEPOS (wealth proxy).</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="3" data-code-annotation="2">line 2 create the model using the fit function</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="5" data-code-annotation="3">line 3 print the model</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 1 iteration

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                         5

                                                  Used       Total
  Number of observations                         11083       12972

Model Test User Model:
                                              Standard      Scaled
  Test Statistic                                 0.000       0.000
  Degrees of freedom                                 0           0

Parameter Estimates:

  Standard errors                             Sandwich
  Information bread                           Observed
  Observed information based on                Hessian

Regressions:
                   Estimate   Std.Err  z-value  P(&gt;|z|)
  PV1MATH ~                                            
    PV1SCIE            0.565    0.007   82.056    0.000
    PV1READ            0.267    0.007   40.019    0.000
    ESCS               5.432    0.750    7.242    0.000
    HOMEPOS            1.027    0.715    1.436    0.151

Variances:
                   Estimate   Std.Err  z-value  P(&gt;|z|)
   .PV1MATH         2006.033   28.472   70.456    0.000</code></pre>
</div>
</div>
<p>In the regressions table, the function returns the value of the regression coefficients for each independent variable, and the P value (<code>P(&gt;|z|)</code>). Note in the model above all the independent variables are significant, but the largest loading comes from the <code>HOMEPOS</code> (wealth) variable, with the science (<code>PV1SCIE</code>) and reading (<code>PV1READ</code>) scores contributing comparatively little.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>In fitting a model, there are a number of approaches to estimating the model parameters. Different packages use different assumptions. To make your output match that of different SEM tools, you will need to choose the correct assumptions. For example, the default likelihood in <code>lavaan</code> is <code>likelihood = "normal"</code>, which assumes multivariate normality. However, to match the output of AMOS, you would need to set the estimator to the default <code>estimator = "ML"</code> but the <code>likelihood = "wishart"</code>. See the <code>lavaan</code> documentation for more details.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>model<span class="ot">&lt;-</span><span class="st">"PV1MATH ~ PV1SCIE + PV1READ + ESCS + HOMEPOS"</span>         </span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"ML"</span>, <span class="at">likelihood =</span> <span class="st">"wishart"</span>)     </span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="fu">summary</span>(fit)                                                </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
<p>Finally, to produce a visual representation of the model, we pass our model, <code>fit</code> to the <code>semPaths</code> function (from the <code>semPlot</code> package we loaded above). We can specify was we want displayed on the lines, in this case the estimate of the regression coefficients between the variables.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>In path diagrams, directly measured variables, manifest variables, are shown as squares. Latent variables are represented as circles. Single headed arrows represent the regression effects between variables. The curved arrows starting and ending on a square or circle indicate the variances of those variables. When curved arrows start and end on different variables, they represent covariance.</p>
<p>One issue to note here is the difference in the variance for the science and mathematics scores. <code>PV1SCIE</code>, <code>PV1READ</code> and <code>PV1MATH</code> are test scores and so have a large variance (the maximum and minimum science scores, for example, are 0 and 943). The variance of the two test variables is much greater that for <code>HOMEPOS</code> (Min=-10.0741 mean=-0.4447, Max=15.240) and <code>ESCS</code> (Min=-6.841 mean=-0.310, Max=7.380).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Continuous variables in data sets may have different ranges - that this the difference between the maximum and minimum variable can have larger magnitudes for some variables than others. This can be a problem because it can be hard to compare the effects of those variables. For example, in the PISA data, consider the difference between <code>PV1MATH</code> (mathematics scores) and <code>HOMEPOS</code> (a wealth proxy). The maximum and minimum mathematics scores are 155 and 893, while the maximum and minimum wealth scores are 8.2 and -6.8. The difference in the range of the variables can make it hard to compare the effects of the variables.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>UK_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="fu">select</span>(CNT, PV1MATH, HOMEPOS) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(PV1MATH, HOMEPOS), <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="fu">ggplot</span>(UK_data, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> variable)) <span class="sc">+</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="fu">geom_histogram</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">binwidth =</span> <span class="dv">5</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Density plot of mathematics scores and wealth"</span>,</span>
<span id="cb13-10"><a href="#cb13-10"></a>       <span class="at">x =</span> <span class="st">"Value"</span>,</span>
<span id="cb13-11"><a href="#cb13-11"></a>       <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"PV1MATH"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"HOMEPOS"</span> <span class="ot">=</span> <span class="st">"red"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>To compare the effects of the variables, we can normalise (also referred to as standardising, scaling or creating z scores) the variables. Normalising the variables sets the mean of the variable to 0 and the variance to 1. This makes the variables more comparable. The <code>scale</code> function in R can be used to normalise variables. The <code>scale</code> function is used with <code>mutate</code> to create a new column <code>PV1MATH_scaled</code> in the <code>UKdata</code> data frame, with the math scores normalised.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-53"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-53-1"><a href="#annotated-cell-53-1"></a>UK_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-53-2"><a href="#annotated-cell-53-2"></a>  <span class="fu">select</span>(CNT, PV1MATH, HOMEPOS) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-53-3"><a href="#annotated-cell-53-3"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-53" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-53-4" class="code-annotation-target"><a href="#annotated-cell-53-4"></a>  <span class="fu">mutate</span>(<span class="at">PV1MATH_scaled =</span> <span class="fu">scale</span>(PV1MATH)) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-53-5"><a href="#annotated-cell-53-5"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(PV1MATH_scaled, HOMEPOS), <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="annotated-cell-53-6"><a href="#annotated-cell-53-6"></a></span>
<span id="annotated-cell-53-7"><a href="#annotated-cell-53-7"></a><span class="fu">ggplot</span>(UK_data, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> variable)) <span class="sc">+</span></span>
<span id="annotated-cell-53-8"><a href="#annotated-cell-53-8"></a>  <span class="fu">geom_histogram</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">binwidth =</span> <span class="fl">0.1</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="annotated-cell-53-9"><a href="#annotated-cell-53-9"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="annotated-cell-53-10"><a href="#annotated-cell-53-10"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Density plot of mathematics scores and wealth"</span>,</span>
<span id="annotated-cell-53-11"><a href="#annotated-cell-53-11"></a>       <span class="at">x =</span> <span class="st">"Value"</span>,</span>
<span id="annotated-cell-53-12"><a href="#annotated-cell-53-12"></a>       <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="annotated-cell-53-13"><a href="#annotated-cell-53-13"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"PV1MATH_scaled"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"HOMEPOS"</span> <span class="ot">=</span> <span class="st">"red"</span>))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-53" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-53" data-code-lines="4" data-code-annotation="1">line 1 normalise the maths scores about a mean of 0 with a variance of 1</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>To resolve this difference, we can use the scale function to create a similar scale for <code>PV1SCIE</code>, <code>PV1MATH</code> and <code>PV1READ</code>. The <code>scale</code> function sets the mean of the variable to 0 and the variance to 1.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-13"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-13-1" class="code-annotation-target"><a href="#annotated-cell-13-1"></a>UKdata<span class="sc">$</span>PV1READ<span class="ot">&lt;-</span><span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1READ)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-13-2" class="code-annotation-target"><a href="#annotated-cell-13-2"></a>UKdata<span class="sc">$</span>PV1MATH<span class="ot">&lt;-</span><span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1MATH)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-13-3" class="code-annotation-target"><a href="#annotated-cell-13-3"></a>UKdata<span class="sc">$</span>PV1SCIE<span class="ot">&lt;-</span><span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1SCIE)</span>
<span id="annotated-cell-13-4"><a href="#annotated-cell-13-4"></a></span>
<span id="annotated-cell-13-5"><a href="#annotated-cell-13-5"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data=</span>UKdata)</span>
<span id="annotated-cell-13-6"><a href="#annotated-cell-13-6"></a><span class="fu">summary</span>(fit)</span>
<span id="annotated-cell-13-7"><a href="#annotated-cell-13-7"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="1" data-code-annotation="1">line 1 normalise the reading scores about a mean of 0 with a variance of 1</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="2" data-code-annotation="2">line 2 normalise maths scores</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="3" data-code-annotation="3">line 3 normalise science scores</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 1 iteration

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                         5

                                                  Used       Total
  Number of observations                         11083       12972

Model Test User Model:
                                                      
  Test statistic                                 0.000
  Degrees of freedom                                 0

Parameter Estimates:

  Standard errors                             Standard
  Information                                 Expected
  Information saturated (h1) model          Structured

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  PV1MATH ~                                           
    PV1SCIE           0.607    0.007   85.604    0.000
    PV1READ           0.295    0.007   41.953    0.000
    ESCS              0.057    0.008    7.404    0.000
    HOMEPOS           0.011    0.008    1.434    0.151

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .PV1MATH           0.222    0.003   74.441    0.000</code></pre>
</div>
</div>
<p>Scaling the test scores gives a more balanced model.</p>
<p>Notice the curved arrow joining the manifest variable PV1M (<code>PV1MATH</code>) to itself. This represents the residual variance for PV1MATH, meaning the amount of variation in PV1MATH that is not explained by the predictors PV1SCIE (science) and PV1READ (reading). The estimate of 0.219 suggests that even after accounting for science and reading scores, there is still significant unexplained variance in mathematics scores. The high z-value (69.581) and p-value (0.000) indicate that this residual variance is statistically significant.</p>
<p>We can make the model more complex, by adding that two of our independent variables, reading (<code>PV1READ</code>) and science (<code>PV1SCIE</code>) scores may co-vary, and vary with other independent variables. That is there is a relationship between science and reading scores. The covariance is indicated by the <code>~~</code> operator.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-14-1" class="code-annotation-target"><a href="#annotated-cell-14-1"></a>model<span class="ot">&lt;-</span><span class="st">"PV1MATH ~ PV1SCIE + PV1READ + ESCS + HOMEPOS</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-14-2" class="code-annotation-target"><a href="#annotated-cell-14-2"></a><span class="st">        PV1READ ~~ PV1SCIE</span></span>
<span id="annotated-cell-14-3"><a href="#annotated-cell-14-3"></a><span class="st">        PV1READ ~ PV1SCIE + PV1MATH + ESCS + HOMEPOS</span></span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4"></a><span class="st">        PV1SCIE ~ PV1READ + PV1MATH + ESCS + HOMEPOS"</span></span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-14-6" class="code-annotation-target"><a href="#annotated-cell-14-6"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<span id="annotated-cell-14-7"><a href="#annotated-cell-14-7"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-14-8" class="code-annotation-target"><a href="#annotated-cell-14-8"></a><span class="fu">summary</span>(fit)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-14-9" class="code-annotation-target"><a href="#annotated-cell-14-9"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="1" data-code-annotation="1">line 1 specify the model - recall <code>~</code> is the regression operator linking dependent and independent variable and <code>~~</code> indicates two variables covary.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="2" data-code-annotation="2">line 2 specify that reading and science scores covary using <code>~~</code></span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="6" data-code-annotation="3">line 5 create the model using the <code>fit</code> function</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="8" data-code-annotation="4">line 6 print the model</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="9" data-code-annotation="5">line 7 use <code>semPath</code> to visualise the model, specifuing that we want the coefficients printed on the lines <code>whatLabels = "Estimate"</code></span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 23 iterations

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                        16

                                                  Used       Total
  Number of observations                         11083       12972

Model Test User Model:
                                                      
  Test statistic                                    NA
  Degrees of freedom                                -4
  P-value (Unknown)                                 NA

Parameter Estimates:

  Standard errors                             Sandwich
  Information bread                           Observed
  Observed information based on                Hessian

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  PV1MATH ~                                           
    PV1SCIE           0.454    0.025   18.091    0.000
    PV1READ           0.171    0.040    4.296    0.000
    ESCS              0.113    0.009   12.375    0.000
    HOMEPOS           0.071    0.009    8.126    0.000
  PV1READ ~                                           
    PV1SCIE           0.242    0.033    7.253    0.000
    PV1MATH           0.386    0.049    7.907    0.000
 [ reached getOption("max.print") -- omitted 7 rows ]

Covariances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
 .PV1READ ~~                                          
   .PV1SCIE           0.065    0.014    4.786    0.000

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .PV1MATH           0.282    0.009   32.100    0.000
   .PV1READ           0.383    0.010   37.215    0.000
   .PV1SCIE           0.340    0.009   39.365    0.000</code></pre>
</div>
</div>
<section id="modelling-a-latent-variable" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="modelling-a-latent-variable"><span class="header-section-number">1.3.1</span> Modelling a latent variable</h3>
<p>As introduced above, we can use SEM to model a latent variable. For example, we might assume that students have some underlying variable linked to their general intelligence. However, in the PISA data set, we have no variable that directly measures students general intelligence. We do have data on their achievement in science (<code>PV1SCIE</code>), mathematics (<code>PV1MATH</code>) and reading (<code>PV1READ</code>) and we might assume that as the latent variable of general achievement increases so does achievement in science, mathematics and reading.</p>
<p>To perform the analysis, we use the <code>=~</code> operator in our model, which indicates a latent variable. This time, our model then sets out that we are interested in a <code>lv</code> (latent variable) which varies with science (<code>PV1SCIE</code>), mathematics (<code>PV1MATH</code>) and reading (<code>PV1READ</code>) scores:</p>
<p>model&lt;-“lv =~ PV1SCIE + PV1READ + PV1MATH”</p>
<p>Then we run the model using <code>sem</code> in the same way as above, and plot the model using <code>semPaths</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-15"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-15-1"><a href="#annotated-cell-15-1"></a><span class="co"># For a latent variable</span></span>
<span id="annotated-cell-15-2"><a href="#annotated-cell-15-2"></a><span class="co"># =~ means a latent variable</span></span>
<span id="annotated-cell-15-3"><a href="#annotated-cell-15-3"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-15-4" class="code-annotation-target"><a href="#annotated-cell-15-4"></a>model<span class="ot">&lt;-</span><span class="st">"lv =~ PV1SCIE + PV1READ + PV1MATH"</span></span>
<span id="annotated-cell-15-5"><a href="#annotated-cell-15-5"></a></span>
<span id="annotated-cell-15-6"><a href="#annotated-cell-15-6"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)               </span>
<span id="annotated-cell-15-7"><a href="#annotated-cell-15-7"></a><span class="fu">summary</span>(fit)</span>
<span id="annotated-cell-15-8"><a href="#annotated-cell-15-8"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="4" data-code-annotation="1">line 1 specify the latent variable using <code>=~</code></span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 18 iterations

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                         6

  Number of observations                         12972

Model Test User Model:
                                              Standard      Scaled
  Test Statistic                                 0.000       0.000
  Degrees of freedom                                 0           0

Parameter Estimates:

  Standard errors                             Sandwich
  Information bread                           Observed
  Observed information based on                Hessian

Latent Variables:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  lv =~                                               
    PV1SCIE           1.000                           
    PV1READ           0.919    0.007  139.663    0.000
    PV1MATH           1.015    0.006  169.985    0.000

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .PV1SCIE           0.145    0.004   38.754    0.000
   .PV1READ           0.278    0.005   61.174    0.000
   .PV1MATH           0.119    0.003   35.189    0.000
    lv                0.855    0.012   73.665    0.000</code></pre>
</div>
</div>
<p>We can develop a more complex latent variable model. Let us assume that UK students’ reading scores depend on two latent variables, home environment (<code>lvh</code>, e.g.&nbsp;number of books, parental level of education etc.) and cognitive ability (<code>lvc</code>, e.g.&nbsp;as reported by science and mathematics scores). Here are the variables we will use to create the home environment latent variable:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Item name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ESCS</td>
<td>Index of economic, social and cultural status (WLE)</td>
</tr>
<tr class="even">
<td>HOMEPOS</td>
<td>Family Wealth</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-16"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-16-1"><a href="#annotated-cell-16-1"></a><span class="co"># Create a UK data frame with plausible values</span></span>
<span id="annotated-cell-16-2"><a href="#annotated-cell-16-2"></a>UKdata<span class="ot">&lt;-</span>PISA_2022<span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-16-3" class="code-annotation-target"><a href="#annotated-cell-16-3"></a>  <span class="fu">select</span>(ESCS, HOMEPOS, PV1READ, PV1SCIE, PV1MATH, CNT) <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-16-4" class="code-annotation-target"><a href="#annotated-cell-16-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)</span>
<span id="annotated-cell-16-5"><a href="#annotated-cell-16-5"></a></span>
<span id="annotated-cell-16-6"><a href="#annotated-cell-16-6"></a><span class="co"># Scale the test scores</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-16-7" class="code-annotation-target"><a href="#annotated-cell-16-7"></a>UKdata<span class="sc">$</span>PV1READ <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1READ)</span>
<span id="annotated-cell-16-8"><a href="#annotated-cell-16-8"></a>UKdata<span class="sc">$</span>PV1MATH <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1MATH)</span>
<span id="annotated-cell-16-9"><a href="#annotated-cell-16-9"></a>UKdata<span class="sc">$</span>PV1SCIE <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1SCIE)</span>
<span id="annotated-cell-16-10"><a href="#annotated-cell-16-10"></a></span>
<span id="annotated-cell-16-11"><a href="#annotated-cell-16-11"></a><span class="co"># Propose a model with two latent variables - one related to home (lvh), the other cognitive ability (lvc)</span></span>
<span id="annotated-cell-16-12"><a href="#annotated-cell-16-12"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-16-13" class="code-annotation-target"><a href="#annotated-cell-16-13"></a>model<span class="ot">&lt;-</span><span class="st">"lvh =~ ESCS + HOMEPOS</span></span>
<span id="annotated-cell-16-14"><a href="#annotated-cell-16-14"></a><span class="st">        lvc =~ PV1MATH + PV1READ</span></span>
<span id="annotated-cell-16-15"><a href="#annotated-cell-16-15"></a><span class="st">        PV1SCIE ~ lvh + lvc"</span></span>
<span id="annotated-cell-16-16"><a href="#annotated-cell-16-16"></a><span class="co"># Fit the model</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-16-17" class="code-annotation-target"><a href="#annotated-cell-16-17"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-16-18" class="code-annotation-target"><a href="#annotated-cell-16-18"></a><span class="fu">summary</span>(fit)</span>
<span id="annotated-cell-16-19"><a href="#annotated-cell-16-19"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-16" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="3" data-code-annotation="1">line 1 create the data frame for modelling, select variables of interest</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="4" data-code-annotation="2">line 4 filter for the UK</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="7" data-code-annotation="3">line 5 scale the variables to normalise all around a mean of 0 and variance 1</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="13" data-code-annotation="5">line 12 create the model using the <code>fit</code> function</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="17" data-code-annotation="6">line 3 print the model</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="18" data-code-annotation="7">line 4 use <code>semPath</code> to visualise the model, specifying that we want the coefficients printed on the lines <code>whatLabels = "Estimate"</code></span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 29 iterations

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                        12

                                                  Used       Total
  Number of observations                         11083       12972

Model Test User Model:
                                              Standard      Scaled
  Test Statistic                                22.605      22.138
  Degrees of freedom                                 3           3
  P-value (Chi-square)                           0.000       0.000
  Scaling correction factor                                  1.021
    Yuan-Bentler correction (Mplus variant)                       

Parameter Estimates:

  Standard errors                             Sandwich
  Information bread                           Observed
  Observed information based on                Hessian

Latent Variables:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  lvh =~                                              
    ESCS              1.000                           
    HOMEPOS           1.023    0.019   54.796    0.000
  lvc =~                                              
    PV1MATH           1.000                           
    PV1READ           0.898    0.007  127.952    0.000

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  PV1SCIE ~                                           
    lvh               0.000    0.008    0.018    0.985
    lvc               0.990    0.007  134.766    0.000

Covariances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  lvh ~~                                              
    lvc               0.314    0.009   35.826    0.000

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .ESCS              0.194    0.011   17.623    0.000
   .HOMEPOS           0.208    0.012   16.955    0.000
   .PV1MATH           0.124    0.004   32.266    0.000
   .PV1READ           0.298    0.005   58.187    0.000
   .PV1SCIE           0.158    0.004   37.002    0.000
    lvh               0.597    0.015   40.414    0.000
    lvc               0.889    0.013   67.613    0.000</code></pre>
</div>
</div>
<p>Interesting features to note are a) the much higher loading of the cognitive latent variable (lvc has a loading of 0.99) than the home environment (<code>lvh</code>, loading 0.00); b) the roughly equal contribution of mathematics and reading scores to <code>lvb</code> (the cognitive ability latent variable).</p>
<p>Note the dotted line from the ESCS variable (truncated here to ESC) indicates that ESCS is acting as a marker variable, that is, it is fixed at 1.0, and the other variables determined relative to it. The same is true for <code>PV1MATH</code> for the ability latent variable.</p>
</section>
</section>
<section id="models-with-categorical-variables" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="models-with-categorical-variables"><span class="header-section-number">1.4</span> Models with categorical variables</h2>
<p>The models above used only numeric variables, but categorical variables can also be used in SEM. For example, in the PISA data set, the variable <code>ST255Q01JA</code> asks “How many books are there in your home?”. We can add this item to the latent variable for the home environment (<code>lvh</code>). This is an ordinal variable. However, we need to indicate this variable is ordinal in three ways. First, ensure the variable is categorised as an ordinal variable (<code>UKdata$ST255Q01JA &lt;- as.ordered(UKdata$ST255Q01JA)</code>). Second, in the <code>fit</code> function we need to label the ordinal functions. Third, we need to use a different process of estimating the model, WLSMV (Weighted Least Squares Mean and Variance-adjusted). This gives: <code>fit &lt;- sem(model, data = your_data, ordered = c("var2", "var3"), estimator = "WLSMV")</code></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-17"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-17-1"><a href="#annotated-cell-17-1"></a><span class="co"># Create a UK data frame with plausible values</span></span>
<span id="annotated-cell-17-2"><a href="#annotated-cell-17-2"></a>UKdata<span class="ot">&lt;-</span>PISA_2022<span class="sc">%&gt;%</span></span>
<span id="annotated-cell-17-3"><a href="#annotated-cell-17-3"></a>  <span class="fu">select</span>(ESCS, HOMEPOS, PV1READ, PV1SCIE, PV1MATH, CNT, </span>
<span id="annotated-cell-17-4"><a href="#annotated-cell-17-4"></a>         ST255Q01JA) <span class="sc">%&gt;%</span>                                              </span>
<span id="annotated-cell-17-5"><a href="#annotated-cell-17-5"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)                                     </span>
<span id="annotated-cell-17-6"><a href="#annotated-cell-17-6"></a></span>
<span id="annotated-cell-17-7"><a href="#annotated-cell-17-7"></a><span class="co"># Scale the test scores</span></span>
<span id="annotated-cell-17-8"><a href="#annotated-cell-17-8"></a>UKdata<span class="sc">$</span>PV1READ <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1READ)                               </span>
<span id="annotated-cell-17-9"><a href="#annotated-cell-17-9"></a>UKdata<span class="sc">$</span>PV1MATH <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1MATH)</span>
<span id="annotated-cell-17-10"><a href="#annotated-cell-17-10"></a>UKdata<span class="sc">$</span>PV1SCIE <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1SCIE)</span>
<span id="annotated-cell-17-11"><a href="#annotated-cell-17-11"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-17-12" class="code-annotation-target"><a href="#annotated-cell-17-12"></a>UKdata<span class="sc">$</span>ST255Q01JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(UKdata<span class="sc">$</span>ST255Q01JA)</span>
<span id="annotated-cell-17-13"><a href="#annotated-cell-17-13"></a></span>
<span id="annotated-cell-17-14"><a href="#annotated-cell-17-14"></a><span class="co"># Propose a model with two latent variables - one related to home (lvh), the other cognitive ability (lvc)</span></span>
<span id="annotated-cell-17-15"><a href="#annotated-cell-17-15"></a></span>
<span id="annotated-cell-17-16"><a href="#annotated-cell-17-16"></a>model<span class="ot">&lt;-</span><span class="st">"lvh =~ ESCS + HOMEPOS + ST255Q01JA                             </span></span>
<span id="annotated-cell-17-17"><a href="#annotated-cell-17-17"></a><span class="st">        lvc =~ PV1MATH + PV1READ</span></span>
<span id="annotated-cell-17-18"><a href="#annotated-cell-17-18"></a><span class="st">        PV1SCIE ~ lvh + lvc"</span></span>
<span id="annotated-cell-17-19"><a href="#annotated-cell-17-19"></a><span class="co"># Fit the model</span></span>
<span id="annotated-cell-17-20"><a href="#annotated-cell-17-20"></a>fit <span class="ot">&lt;-</span> <span class="fu">sem</span>(model, UKdata, <span class="at">ordered =</span> <span class="fu">c</span>(<span class="st">"ST255Q01JA"</span>), </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-17-21" class="code-annotation-target"><a href="#annotated-cell-17-21"></a>           <span class="at">estimator =</span> <span class="st">"WLSMV"</span>)</span>
<span id="annotated-cell-17-22"><a href="#annotated-cell-17-22"></a><span class="fu">summary</span>(fit)                                                          </span>
<span id="annotated-cell-17-23"><a href="#annotated-cell-17-23"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)                              </span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-17" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-17" data-code-lines="12" data-code-annotation="1">set the variable <code>ST255Q01JA</code> as an ordered variable</span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-17" data-code-lines="21" data-code-annotation="2">indicate that the variable <code>ST255Q01JA</code> is ordered and use the WLSMV estimator</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 32 iterations

  Estimator                                       DWLS
  Optimization method                           NLMINB
  Number of model parameters                        24

                                                  Used       Total
  Number of observations                         11038       12972

Model Test User Model:
                                              Standard      Scaled
  Test Statistic                               364.857    1524.165
  Degrees of freedom                                 7           7
  P-value (Chi-square)                           0.000       0.000
  Scaling correction factor                                  0.240
  Shift parameter                                            1.912
    simple second-order correction                                

Parameter Estimates:

  Parameterization                               Delta
  Standard errors                           Robust.sem
  Information                                 Expected
  Information saturated (h1) model        Unstructured

Latent Variables:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  lvh =~                                              
    ESCS              1.000                           
    HOMEPOS           1.107    0.012   94.632    0.000
    ST255Q01JA        1.192    0.018   66.202    0.000
  lvc =~                                              
    PV1MATH           1.000                           
    PV1READ           0.912    0.010   95.719    0.000

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  PV1SCIE ~                                           
    lvh               0.002    0.010    0.167    0.868
    lvc               0.998    0.009  110.955    0.000

Covariances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  lvh ~~                                              
    lvc               0.324    0.008   39.354    0.000

Intercepts:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .ESCS              0.119    0.009   13.608    0.000
   .HOMEPOS           0.134    0.009   15.494    0.000
   .PV1MATH           0.039    0.010    4.103    0.000
   .PV1READ           0.049    0.010    5.053    0.000
   .PV1SCIE           0.038    0.010    3.982    0.000

Thresholds:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
    ST255Q01JA|t1    -1.675    0.021  -81.593    0.000
    ST255Q01JA|t2    -0.835    0.014  -61.510    0.000
    ST255Q01JA|t3    -0.272    0.012  -22.530    0.000
    ST255Q01JA|t4     0.505    0.012   40.369    0.000
    ST255Q01JA|t5     1.022    0.014   70.526    0.000
    ST255Q01JA|t6     1.633    0.020   81.825    0.000

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .ESCS              0.340    0.007   51.922    0.000
   .HOMEPOS           0.275    0.006   42.753    0.000
   .ST255Q01JA        0.360                           
   .PV1MATH           0.139    0.006   22.027    0.000
   .PV1READ           0.286    0.006   46.410    0.000
   .PV1SCIE           0.157    0.004   42.365    0.000
    lvh               0.451    0.011   39.843    0.000
    lvc               0.872    0.016   54.996    0.000</code></pre>
</div>
</div>
<p>Triangles have appeared which represent the threshold for the ordinal variable. A threshold in SEM refers to the value that defines the boundary between categories of an ordinal variable - in this case the number of books in the home. The variable ST255Q01JA in your data represents a set of ordered categories about the number of books. For example: “There are no books” ; 1-10 books.” “11-25 books.” … (and so on).</p>
<p>The bars on the squares are visual markers that indicate which variables are being treated as ordinal variables in the model. In your case, you’ve specified <code>ST255Q01JA</code> as an ordinal variable by using the <code>as.ordered()</code> function. The bars are a way of indicating that <code>ST255Q01JA</code> is not a continuous variable but an ordinal one, which reflects a ranked or ordered scale.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If adding an ordinal variable, with the addition of triangles to the plot, makes your path diagram too crowded, you can turn off estimates for thresholds and residual variances as follows:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">residuals =</span> <span class="cn">FALSE</span>, <span class="at">thresholds =</span> <span class="cn">FALSE</span>)                              </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>If you want to link an ordinal variable directly to an outcome variable, for example, if you want to link books directly to reading, doing it through a latent variable allows lavaan to estimate the thresholds for the ordinal variable.</p>
<p>To fit a categorical variable like gender, you can use the <code>as.factor</code> function to convert the variable to a factor and then use the <code>fit &lt;- sem(model, UKdata, estimator = "MLR")</code> function to estimate the model. MLR is the default estimator for categorical variables. MLR stands for Maximum Likelihood Robust. It is an estimator used in structural equation modeling (SEM), particularly when dealing with non-normal data or small sample sizes. See the example below using gender:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># Create a data frame with the required base variables</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>UKdata<span class="ot">&lt;-</span>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="fu">select</span>(CNT, PV1SCIE, PV1MATH, ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="fu">na.omit</span>() <span class="co"># Remove the NAs to create a two level variable.</span></span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="co"># set ST004D01T to a factor</span></span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a>UKdata<span class="sc">$</span>ST004D01T <span class="ot">&lt;-</span> <span class="fu">factor</span>(UKdata<span class="sc">$</span>ST004D01T, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Male"</span>, <span class="st">"Female"</span>))</span>
<span id="cb20-10"><a href="#cb20-10"></a></span>
<span id="cb20-11"><a href="#cb20-11"></a></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="co"># Scale the numeric variables</span></span>
<span id="cb20-13"><a href="#cb20-13"></a></span>
<span id="cb20-14"><a href="#cb20-14"></a>UKdata <span class="ot">&lt;-</span> UKdata <span class="sc">%&gt;%</span></span>
<span id="cb20-15"><a href="#cb20-15"></a>  <span class="fu">mutate</span>(<span class="at">PV1SCIE =</span> <span class="fu">scale</span>(PV1SCIE),</span>
<span id="cb20-16"><a href="#cb20-16"></a>         <span class="at">PV1MATH =</span> <span class="fu">scale</span>(PV1MATH))</span>
<span id="cb20-17"><a href="#cb20-17"></a>         </span>
<span id="cb20-18"><a href="#cb20-18"></a><span class="co"># Create the model</span></span>
<span id="cb20-19"><a href="#cb20-19"></a></span>
<span id="cb20-20"><a href="#cb20-20"></a>model <span class="ot">&lt;-</span> <span class="st">"PV1SCIE ~ PV1MATH + ST004D01T"</span></span>
<span id="cb20-21"><a href="#cb20-21"></a></span>
<span id="cb20-22"><a href="#cb20-22"></a>fit <span class="ot">&lt;-</span> <span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<span id="cb20-23"><a href="#cb20-23"></a><span class="fu">summary</span>(fit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 1 iteration

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                         3

  Number of observations                         12972

Model Test User Model:
                                              Standard      Scaled
  Test Statistic                                 0.000       0.000
  Degrees of freedom                                 0           0

Parameter Estimates:

  Standard errors                             Sandwich
  Information bread                           Observed
  Observed information based on                Hessian

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  PV1SCIE ~                                           
    PV1MATH           0.870    0.004  196.331    0.000
    ST004D01T         0.056    0.009    6.457    0.000

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .PV1SCIE           0.246    0.003   73.035    0.000</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you have both categorical and ordinal variables, it’s best to use WLSMV because it can appropriately handle both ordinal variables (using thresholds) and categorical variables (using multinomial logistic regression), while also providing correct standard errors.</p>
</div>
</div>
</section>
<section id="labelling-paths-to-calculate-indirect-effects" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="labelling-paths-to-calculate-indirect-effects"><span class="header-section-number">1.5</span> Labelling paths to calculate indirect effects</h2>
<p>In SEM, indirect effects occur when the effect of one variable on another is mediated through one or more intervening variables. To calculate indirect effects in <code>lavaan</code>, you need to label the paths in your model using the <code>label</code> argument. This allows you to specify which paths you want to include in the calculation of indirect effects.</p>
<p>For example, consider a model where variable <code>PV1MATH</code> (math score) affects variable <code>PV1SICE</code> (science score) through a mediator variable <code>HOMEPOS</code> (wealth). We add coefficients to the paths using labels <code>a</code>, <code>b</code> and <code>c</code>, and then define the indirect effect as the product of the paths <code>a</code> and <code>c</code>. Note we use the operator <code>:=</code> to define the indirect effect.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># Create a data frame with the required  variables</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>UKdata <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="fu">select</span>(CNT, HOMEPOS, PV1MATH, PV1SCIE) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>) </span>
<span id="cb23-5"><a href="#cb23-5"></a></span>
<span id="cb23-6"><a href="#cb23-6"></a>model <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="st">  PV1SCIE ~ a*PV1MATH + b*HOMEPOS</span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="st">  HOMEPOS ~ c*PV1MATH</span></span>
<span id="cb23-9"><a href="#cb23-9"></a></span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="st">  # Indirect effect</span></span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="st">  indirect_effect := a * c</span></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="st">"</span></span>
<span id="cb23-13"><a href="#cb23-13"></a>fit <span class="ot">&lt;-</span> <span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="fu">summary</span>(fit, <span class="at">standardized =</span> <span class="cn">TRUE</span>, <span class="at">fit.measures =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 1 iteration

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                         5

                                                  Used       Total
  Number of observations                         11487       12972

Model Test User Model:
                                              Standard      Scaled
  Test Statistic                                 0.000       0.000
  Degrees of freedom                                 0           0

Model Test Baseline Model:

  Test statistic                             17314.368   14282.056
  Degrees of freedom                                 3           3
  P-value                                        0.000       0.000
  Scaling correction factor                                  1.212

User Model versus Baseline Model:

  Comparative Fit Index (CFI)                    1.000       1.000
  Tucker-Lewis Index (TLI)                       1.000       1.000
                                                                  
  Robust Comparative Fit Index (CFI)                            NA
  Robust Tucker-Lewis Index (TLI)                               NA

Loglikelihood and Information Criteria:

  Loglikelihood user model (H0)             -76323.012  -76323.012
  Loglikelihood unrestricted model (H1)     -76323.012  -76323.012
                                                                  
  Akaike (AIC)                              152656.024  152656.024
  Bayesian (BIC)                            152692.769  152692.769
  Sample-size adjusted Bayesian (SABIC)     152676.880  152676.880

Root Mean Square Error of Approximation:

  RMSEA                                          0.000          NA
  90 Percent confidence interval - lower         0.000          NA
  90 Percent confidence interval - upper         0.000          NA
  P-value H_0: RMSEA &lt;= 0.050                       NA          NA
  P-value H_0: RMSEA &gt;= 0.080                       NA          NA
                                                                  
  Robust RMSEA                                               0.000
  90 Percent confidence interval - lower                     0.000
  90 Percent confidence interval - upper                     0.000
  P-value H_0: Robust RMSEA &lt;= 0.050                            NA
  P-value H_0: Robust RMSEA &gt;= 0.080                            NA

Standardized Root Mean Square Residual:

  SRMR                                           0.000       0.000

Parameter Estimates:

  Standard errors                             Sandwich
  Information bread                           Observed
  Observed information based on                Hessian

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)   Std.lv  Std.all
  PV1SCIE ~                                                             
    PV1MATH    (a)    0.914    0.006  165.914    0.000    0.914    0.845
    HOMEPOS    (b)    5.687    0.585    9.727    0.000    5.687    0.050
  HOMEPOS ~                                                             
    PV1MATH    (c)    0.003    0.000   39.705    0.000    0.003    0.355

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)   Std.lv  Std.all
   .PV1SCIE        2743.115   38.628   71.013    0.000 2743.115    0.254
   .HOMEPOS           0.738    0.013   55.888    0.000    0.738    0.874

Defined Parameters:
                   Estimate  Std.Err  z-value  P(&gt;|z|)   Std.lv  Std.all
    indirect_effct    0.003    0.000   38.391    0.000    0.003    0.300</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/indirect_effects-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>In this example, the paths from <code>PV1MATH</code> to <code>PV1SCIE</code> and from <code>PV1MATH</code> to <code>HOMEPOS</code> are labeled as <code>a</code> and <code>c</code>, respectively. The indirect effect of <code>PV1MATH</code> on <code>PV1SCIE</code> through <code>HOMEPOS</code> is then calculated as the product of these two paths (<code>indirect_effect := a * c</code>). Here we find the coefficient for the indirect effect is only 0.003, indicating a very small indirect effect of mathematics score on science score through wealth.</p>
</section>
<section id="formatting-path-diagrams" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="formatting-path-diagrams"><span class="header-section-number">1.6</span> Formatting path diagrams</h2>
<ul>
<li>To rotate the plot (<code>rotation = 2</code>):</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">rotation =</span> <span class="dv">2</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>To include more letters of variable names in the nodes (<code>nCharNodes = 7</code>) specifies the number of characters displayed (default is 3):</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">rotation =</span> <span class="dv">2</span>, <span class="at">nCharNodes =</span> <span class="dv">7</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>To change the colour of the lines (<code>edge.color="blue"</code>) and the size of the nodes (<code>sizeMan=8</code>):</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">rotation =</span> <span class="dv">2</span>, </span>
<span id="cb28-2"><a href="#cb28-2"></a>         <span class="at">edge.color =</span> <span class="st">"blue"</span>, <span class="at">sizeMan =</span> <span class="dv">8</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>To link the thickness of lines to their value (<code>"std"</code>):</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">rotation =</span> <span class="dv">2</span>, </span>
<span id="cb29-2"><a href="#cb29-2"></a>         <span class="at">edge.color =</span> <span class="st">"blue"</span>, <span class="st">"std"</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>To make the labels larger (<code>edge.label.cex = 0.8</code>):</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">rotation =</span> <span class="dv">2</span>, </span>
<span id="cb30-2"><a href="#cb30-2"></a>         <span class="at">edge.color =</span> <span class="st">"blue"</span>, </span>
<span id="cb30-3"><a href="#cb30-3"></a>         <span class="at">sizeMan =</span> <span class="dv">5</span>, <span class="st">"std"</span>, <span class="at">edge.label.cex =</span> <span class="fl">0.8</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>To change the text size in the nodes (<code>label.cex = 0.8</code>):</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">rotation =</span> <span class="dv">2</span>, </span>
<span id="cb31-2"><a href="#cb31-2"></a>         <span class="at">edge.color =</span> <span class="st">"blue"</span>, </span>
<span id="cb31-3"><a href="#cb31-3"></a>         <span class="at">sizeMan =</span> <span class="dv">5</span>, <span class="st">"std"</span>, <span class="at">edge.label.cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb31-4"><a href="#cb31-4"></a>         <span class="at">label.cex =</span> <span class="fl">0.8</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>To add a title (<code>title("PISA path diagram")</code>):</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">rotation =</span> <span class="dv">2</span>, </span>
<span id="cb32-2"><a href="#cb32-2"></a>         <span class="at">edge.color =</span> <span class="st">"blue"</span>, <span class="at">sizeMan =</span> <span class="dv">5</span>, <span class="st">"std"</span>, </span>
<span id="cb32-3"><a href="#cb32-3"></a>         <span class="at">edge.label.cex =</span> <span class="fl">0.8</span>) </span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="fu">title</span>(<span class="st">"PISA path diagram"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>To give longer node names (<code>nodeNames=nodenames</code>), and you can increase the abbreviation of labels to a set number of characters in the nodes using <code>nCharNodes = 3</code>. <code>node.label.cex</code> sets the size of the node label text:</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>nodenames<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Economic, social and cultural status"</span>,</span>
<span id="cb33-2"><a href="#cb33-2"></a>             <span class="st">"Wealth"</span>, <span class="st">"Math score"</span>, <span class="st">"Reading score"</span>, <span class="st">"Science Score"</span>)</span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">rotation=</span><span class="dv">2</span>, <span class="at">edge.color =</span> <span class="st">"blue"</span>, </span>
<span id="cb33-4"><a href="#cb33-4"></a>         <span class="at">sizeMan =</span><span class="dv">5</span>, <span class="st">"std"</span>, <span class="at">edge.label.cex =</span> <span class="fl">0.8</span>, <span class="at">nodeNames =</span> nodenames,</span>
<span id="cb33-5"><a href="#cb33-5"></a>         <span class="at">nCharNodes =</span> <span class="dv">5</span>)</span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="fu">title</span>(<span class="st">"PISA path diagram"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can find more information on formatting path diagrams using <code>semPaths</code> on <a href="https://sfcheung.github.io/semptools/articles/semptools.html">semptools</a> and on the Comprehensive R Archive network (CRAN) <a href="https://www.rdocumentation.org/packages/semPlot/versions/1.1.6/topics/semPaths">documentation</a> for the package.</p>
</div>
</div>
</section>
<section id="estimating-model-fit" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="estimating-model-fit"><span class="header-section-number">1.7</span> Estimating model fit</h2>
<p>After running a SEM, it is important to determine how well the model fits the data. There are a number of different measures of model fit, no one measure provides a definitive measure of the fit - it is best practice to consider a number of different indicators and come to a holistic judgement. Measures include:</p>
<blockquote class="blockquote">
<p><strong>The Chi-Square Test of Model Fit </strong> Assume the null hypothesis that the model fits the data well. A non-significant p-value indicates good fit. However, this test is sensitive to sample size, and with large samples, even minor deviations may be significant: ‘[Chi-square] is sensitive to sample size because as sample size increases (generally above 200), the χ2 has a tendency to indicate a significant probability level’ <span class="citation" data-cites="schumacker2004beginner">(<a href="#ref-schumacker2004beginner" role="doc-biblioref">Schumacker and Lomax 2004, 92</a>)</span>.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Comparative Fit Index (CFI) and Tucker-Lewis Index (TLI)</strong> Values closer to 1 indicate better fit. Common thresholds for the two indicies are Acceptable fit: &gt; 0.90 Good fit: &gt; 0.95 <span class="citation" data-cites="kline2023principles mcdonald2002principles">(<a href="#ref-kline2023principles" role="doc-biblioref">Kline 2023, 204</a>; <a href="#ref-mcdonald2002principles" role="doc-biblioref">McDonald and Ho 2002</a>)</span></p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Root Mean Square Error of Approximation (RMSEA)</strong> A measure of approximate fit in the population. Common thresholds: Good fit: &lt; 0.06 Acceptable fit: &lt; 0.08 Look at the 90% confidence interval for RMSEA as well.</p>
</blockquote>
<p>To get estimates of model fit, when you run the summary command, include: <code>summary(fit, fit.measures = TRUE)</code></p>
<p>For example:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-30"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-30-1"><a href="#annotated-cell-30-1"></a><span class="co"># Create a UK data frame with plausible values</span></span>
<span id="annotated-cell-30-2"><a href="#annotated-cell-30-2"></a>UKdata<span class="ot">&lt;-</span>PISA_2022 <span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-30-3" class="code-annotation-target"><a href="#annotated-cell-30-3"></a>  <span class="fu">select</span>(CNT, ESCS, HOMEPOS,</span>
<span id="annotated-cell-30-4"><a href="#annotated-cell-30-4"></a>         PV1READ, PV1SCIE, PV1MATH)<span class="sc">%&gt;%</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-30-5" class="code-annotation-target"><a href="#annotated-cell-30-5"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)</span>
<span id="annotated-cell-30-6"><a href="#annotated-cell-30-6"></a></span>
<span id="annotated-cell-30-7"><a href="#annotated-cell-30-7"></a><span class="co"># Scale the test scores</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-30-8" class="code-annotation-target"><a href="#annotated-cell-30-8"></a>UKdata<span class="sc">$</span>PV1READ <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1READ)</span>
<span id="annotated-cell-30-9"><a href="#annotated-cell-30-9"></a>UKdata<span class="sc">$</span>PV1MATH <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1MATH)</span>
<span id="annotated-cell-30-10"><a href="#annotated-cell-30-10"></a>UKdata<span class="sc">$</span>PV1SCIE <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1SCIE)</span>
<span id="annotated-cell-30-11"><a href="#annotated-cell-30-11"></a></span>
<span id="annotated-cell-30-12"><a href="#annotated-cell-30-12"></a><span class="co"># Propose a model with two latent variables - one related to home (lvh), the other cognitive ability (lvc)</span></span>
<span id="annotated-cell-30-13"><a href="#annotated-cell-30-13"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-30-14" class="code-annotation-target"><a href="#annotated-cell-30-14"></a>model<span class="ot">&lt;-</span><span class="st">"lvh =~ ESCS + HOMEPOS</span></span>
<span id="annotated-cell-30-15"><a href="#annotated-cell-30-15"></a><span class="st">        lvc =~ PV1MATH + PV1READ</span></span>
<span id="annotated-cell-30-16"><a href="#annotated-cell-30-16"></a><span class="st">        PV1SCIE ~ lvh + lvc"</span></span>
<span id="annotated-cell-30-17"><a href="#annotated-cell-30-17"></a><span class="co"># Fit the model</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-30-18" class="code-annotation-target"><a href="#annotated-cell-30-18"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UKdata)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-30-19" class="code-annotation-target"><a href="#annotated-cell-30-19"></a><span class="fu">summary</span>(fit, <span class="at">fit.measures =</span> <span class="cn">TRUE</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-30-20" class="code-annotation-target"><a href="#annotated-cell-30-20"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-30" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="3" data-code-annotation="1">line 1 create the data frame for modelling, select variables of interest</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="5" data-code-annotation="2">line 4 filter for the UK</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="8" data-code-annotation="3">line 8 scale the variables to normalise all around a mean of 0 and variance 1</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="14" data-code-annotation="4">line 11 specify the model - note that two latent variables are proposed (lvh, lvc) - these are specified using the <code>=~</code> operator</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="18" data-code-annotation="5">line 12 create the model using the <code>fit</code> function</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="19" data-code-annotation="6">line 3 print the model - <strong><em><code>fit.measures = TRUE</code> reports the fit parameters</em></strong></span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="20" data-code-annotation="7">line 4 use <code>semPath</code> to visualise the model, specifying that we want the coefficients printed on the lines <code>whatLabels = "Estimate"</code></span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 29 iterations

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                        12

                                                  Used       Total
  Number of observations                         11083       12972

Model Test User Model:
                                                      
  Test statistic                                22.605
  Degrees of freedom                                 3
  P-value (Chi-square)                           0.000

Model Test Baseline Model:

  Test statistic                             37896.675
  Degrees of freedom                                10
  P-value                                        0.000

User Model versus Baseline Model:

  Comparative Fit Index (CFI)                    0.999
  Tucker-Lewis Index (TLI)                       0.998

Loglikelihood and Information Criteria:

  Loglikelihood user model (H0)             -57695.609
  Loglikelihood unrestricted model (H1)     -57684.307
                                                      
  Akaike (AIC)                              115415.218
  Bayesian (BIC)                            115502.976
  Sample-size adjusted Bayesian (SABIC)     115464.842

Root Mean Square Error of Approximation:

  RMSEA                                          0.024
  90 Percent confidence interval - lower         0.016
  90 Percent confidence interval - upper         0.034
  P-value H_0: RMSEA &lt;= 0.050                    1.000
  P-value H_0: RMSEA &gt;= 0.080                    0.000

Standardized Root Mean Square Residual:

  SRMR                                           0.004

Parameter Estimates:

  Standard errors                             Standard
  Information                                 Expected
  Information saturated (h1) model          Structured

Latent Variables:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  lvh =~                                              
    ESCS              1.000                           
    HOMEPOS           1.023    0.019   54.286    0.000
  lvc =~                                              
    PV1MATH           1.000                           
    PV1READ           0.898    0.007  130.208    0.000

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  PV1SCIE ~                                           
    lvh               0.000    0.008    0.019    0.985
    lvc               0.990    0.007  137.089    0.000

Covariances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  lvh ~~                                              
    lvc               0.314    0.009   35.365    0.000

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .ESCS              0.194    0.010   18.471    0.000
   .HOMEPOS           0.208    0.011   18.898    0.000
   .PV1MATH           0.124    0.004   33.351    0.000
   .PV1READ           0.298    0.005   61.818    0.000
   .PV1SCIE           0.158    0.004   40.379    0.000
    lvh               0.597    0.014   41.261    0.000
    lvc               0.889    0.014   63.886    0.000</code></pre>
</div>
</div>
<p>Going through the fit measures of that model:</p>
<blockquote class="blockquote">
<p>P-value (Chi-square) 0.000</p>
</blockquote>
<p>The p-value is less than 0.05 suggesting a poor fit</p>
<blockquote class="blockquote">
<p>Comparative Fit Index (CFI) 0.999 Tucker-Lewis Index (TLI) 0.9998</p>
</blockquote>
<p>The CFI and TLI are over 0.95 suggesting a good fit</p>
<blockquote class="blockquote">
<p>Root Mean Square Error of Approximation: RMSEA 0.024 90 Percent confidence interval - lower 0.016 90 Percent confidence interval - upper 0.034</p>
</blockquote>
<p>The RMS error term is 0.024 with the 90% confidence interval between 0.016 and 0.034 An RMSEA of 0.024 suggests good fit, as it is under common thresholds for acceptable fit: Good fit: &lt; 0.06; Acceptable fit: 0.06–0.08 and Poor fit: &gt; 0.08.</p>
<p>As is commonly the case, the model indicators make different suggestions of the goodness of the model’s fit. Overall this seems like not the best fitting model.</p>
<section id="local-fit" class="level3" data-number="1.7.1">
<h3 data-number="1.7.1" class="anchored" data-anchor-id="local-fit"><span class="header-section-number">1.7.1</span> Local fit</h3>
<p>Alongside checking the overall fit of the model, it is also important to check the local fit of the model. Local fit looks at how well individual parts of the model fit the data. One way to look at local fit is to examine the standardised residuals. Standardised residuals are the differences between the observed and predicted values, scaled by the standard deviation. Large residuals indicate areas where the model does not fit well.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># Standardised residuals</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="fu">residuals</span>(fit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>$type
[1] "raw"

$cov
          ESCS HOMEPO PV1MAT PV1REA PV1SCI
ESCS     0.000                            
HOMEPOS  0.000  0.000                     
PV1MATH  0.005  0.000  0.000              
PV1READ -0.013 -0.002  0.000  0.000       
PV1SCIE -0.001  0.001  0.000  0.001  0.000</code></pre>
</div>
</div>
<p>Here, all the standardised residuals are less than 2.0, suggesting a good local fit.</p>
</section>
</section>
<section id="improving-model-fit" class="level2" data-number="1.8">
<h2 data-number="1.8" class="anchored" data-anchor-id="improving-model-fit"><span class="header-section-number">1.8</span> Improving model fit</h2>
<p>After examining the fit of a model, the next step can be to look at the model modification indices which suggest how the model might be improved.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="fu">modificationIndices</span>(fit, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>       lhs op     rhs     mi    epc sepc.lv sepc.all sepc.nox
21    ESCS ~~ PV1READ 18.099 -0.014  -0.014   -0.059   -0.059
20    ESCS ~~ PV1MATH 14.319  0.011   0.011    0.068    0.068
24 HOMEPOS ~~ PV1READ  6.711  0.009   0.009    0.035    0.035
23 HOMEPOS ~~ PV1MATH  6.371 -0.007  -0.007   -0.045   -0.045
16     lvh =~ PV1READ  5.547 -0.023  -0.017   -0.017   -0.017
 [ reached 'max' / getOption("max.print") -- omitted 5 rows ]</code></pre>
</div>
</div>
<p>The table output suggest ways to improve the model to improve the fit. <strong><em>One should be cautious about making changes to a model based purely on such modification indices. The model should fit theory</em></strong>. The <code>lhs</code> and <code>rhs</code> columns refer to the left hand side and right hand side of the equation. The <code>ops</code> column refers to the operator, this suggests the type of relationship that might be added to improve the model:</p>
<blockquote class="blockquote">
<p>~~ (Covariance or Correlation) - you might add: ‘ESCS ~~ PV1READ’ to the model</p>
</blockquote>
<blockquote class="blockquote">
<p>=~ (Latent Variable Measurement Relationship) - suggests adding a new aspect to the home latent variable in the model: lvh =~ PV1READ</p>
</blockquote>
<p>Note, that the suggestions here are purely numeric. It does not take into account the theoretical coherence of the model. For example, adding reading scores to the home environment latent variable (<code>lvh  =~  PV1READ</code>) does not make much sense.</p>
<p>The suggestions to improve are ranked by the <code>mi</code> improvement. <code>mi</code> is a measure of how much the models chi-square value would decrease if you added the additional term. For example, adding <code>ESCS ~~  PV1READ</code> would bring the chi-square value down by 18.099.</p>
<p>The <code>epc</code> is the Expected Parameter Change - the expected value of the new term (covariance, or factor loading). For example, looking at the <code>epc</code> term for <code>ESCS   ~~  PV1READ</code> - if this term were added to the model, that relationship would be expected to have a covariance of -0.014.</p>
<p>We can then add the suggested terms and compare model fit, adding the top two suggestions: <code>ESCS    ~~  PV1READ</code> (a covariance between social class and reading score) and <code>ESCS    ~~  PV1MATH</code> (a covariance between class and mathematics scores) . It is important to check those additions cohere with theory. A link between class and reading and mathematics score seems plausible from knowledge of the link between class and achievement in the literature.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># Propose a modified model </span></span>
<span id="cb39-2"><a href="#cb39-2"></a></span>
<span id="cb39-3"><a href="#cb39-3"></a>model2<span class="ot">&lt;-</span><span class="st">"lvh =~ ESCS + HOMEPOS  </span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="st">        lvc =~ PV1MATH + PV1READ</span></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="st">        PV1SCIE ~ lvh + lvc</span></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="st">        ESCS    ~~  PV1READ</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="st">        HOMEPOS ~~  PV1MATH"</span></span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="co"># Fit the model</span></span>
<span id="cb39-9"><a href="#cb39-9"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model2, <span class="at">data =</span> UKdata)                                        </span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="fu">summary</span>(fit, , <span class="at">fit.measures =</span> <span class="cn">TRUE</span>)                                   </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-20 ended normally after 34 iterations

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                        14

                                                  Used       Total
  Number of observations                         11083       12972

Model Test User Model:
                                                      
  Test statistic                                 2.529
  Degrees of freedom                                 1
  P-value (Chi-square)                           0.112

Model Test Baseline Model:

  Test statistic                             37896.675
  Degrees of freedom                                10
  P-value                                        0.000

User Model versus Baseline Model:

  Comparative Fit Index (CFI)                    1.000
  Tucker-Lewis Index (TLI)                       1.000

Loglikelihood and Information Criteria:

  Loglikelihood user model (H0)             -57685.571
  Loglikelihood unrestricted model (H1)     -57684.307
                                                      
  Akaike (AIC)                              115399.142
  Bayesian (BIC)                            115501.527
  Sample-size adjusted Bayesian (SABIC)     115457.036

Root Mean Square Error of Approximation:

  RMSEA                                          0.012
  90 Percent confidence interval - lower         0.000
  90 Percent confidence interval - upper         0.031
  P-value H_0: RMSEA &lt;= 0.050                    1.000
  P-value H_0: RMSEA &gt;= 0.080                    0.000

Standardized Root Mean Square Residual:

  SRMR                                           0.002

Parameter Estimates:

  Standard errors                             Standard
  Information                                 Expected
  Information saturated (h1) model          Structured

Latent Variables:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  lvh =~                                              
    ESCS              1.000                           
    HOMEPOS           1.022    0.020   52.298    0.000
  lvc =~                                              
    PV1MATH           1.000                           
    PV1READ           0.898    0.007  130.237    0.000

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  PV1SCIE ~                                           
    lvh              -0.007    0.008   -0.833    0.405
    lvc               0.993    0.007  135.416    0.000

Covariances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
 .ESCS ~~                                             
   .PV1READ          -0.013    0.003   -3.703    0.000
 .HOMEPOS ~~                                          
   .PV1MATH          -0.004    0.003   -1.385    0.166
  lvh ~~                                              
    lvc               0.318    0.009   35.568    0.000

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .ESCS              0.193    0.011   17.655    0.000
   .HOMEPOS           0.209    0.011   18.319    0.000
   .PV1MATH           0.125    0.004   33.448    0.000
   .PV1READ           0.298    0.005   61.787    0.000
   .PV1SCIE           0.158    0.004   40.228    0.000
    lvh               0.598    0.015   40.357    0.000
    lvc               0.889    0.014   63.864    0.000</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)                                </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-1-SEM_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
</figure>
</div>
</div>
</div>
<p>If we compare the model fit indices in the improved model to the original:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 9%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Fit Measure</strong></th>
<th><strong>Model 1</strong></th>
<th><strong>Model 2</strong></th>
<th><strong>Improvement?</strong></th>
<th><strong>Comments on Change</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Chi-Square</strong></td>
<td>2.529 (df = 1, p = 0.112)</td>
<td>2.529 (df = 1, p = 0.112)</td>
<td><strong>No Change</strong></td>
<td>Both models have identical chi-square values, indicating no improvement.</td>
</tr>
<tr class="even">
<td><strong>CFI (Comparative Fit Index)</strong></td>
<td>1.000</td>
<td>1.000</td>
<td><strong>No Change</strong></td>
<td>No change in CFI, both models show perfect fit.</td>
</tr>
<tr class="odd">
<td><strong>TLI (Tucker-Lewis Index)</strong></td>
<td>1.000</td>
<td>1.000</td>
<td><strong>No Change</strong></td>
<td>TLI remains the same for both models, indicating no difference in model fit.</td>
</tr>
<tr class="even">
<td><strong>RMSEA</strong></td>
<td>0.012</td>
<td>0.012</td>
<td><strong>No Change</strong></td>
<td>RMSEA is the same in both models, suggesting that fit in terms of RMSEA did not change.</td>
</tr>
</tbody>
</table>
<p>There is no difference in terms of model fit indicators between Model 1 and Model 2. Both models show identical values for Chi-Square, CFI, TLI, RMSEA, SRMR, and other fit indices, indicating that the models are performing equivalently. As the first model fit was relatively high, there was limited scope for improvement here.</p>
<section id="reporting-the-model" class="level3" data-number="1.8.1">
<h3 data-number="1.8.1" class="anchored" data-anchor-id="reporting-the-model"><span class="header-section-number">1.8.1</span> Reporting the model</h3>
<p>Once you have finalised your model, you will want to report various aspects of your SEM. Typically you will be interested in the factor loadings (the standardised coefficients representing the paths between variables). The loadings are displayed on your path diagram but you can produce an output of the loadings separately. For example for <code>model2</code> above which attempts to model science scores with a latent home and cognitive item, you can extract the factor loadings using the <code>standardizedsolution</code> function.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="co"># Report the model</span></span>
<span id="cb42-2"><a href="#cb42-2"></a></span>
<span id="cb42-3"><a href="#cb42-3"></a>model2<span class="ot">&lt;-</span><span class="st">"lvh =~ ESCS + HOMEPOS  </span></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="st">        lvc =~ PV1MATH + PV1READ</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="st">        PV1SCIE ~ lvh + lvc</span></span>
<span id="cb42-6"><a href="#cb42-6"></a><span class="st">        ESCS    ~~  PV1READ</span></span>
<span id="cb42-7"><a href="#cb42-7"></a><span class="st">        HOMEPOS ~~  PV1MATH"</span></span>
<span id="cb42-8"><a href="#cb42-8"></a></span>
<span id="cb42-9"><a href="#cb42-9"></a><span class="co"># Fit the model</span></span>
<span id="cb42-10"><a href="#cb42-10"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model2, <span class="at">data =</span> UKdata)                                        </span>
<span id="cb42-11"><a href="#cb42-11"></a></span>
<span id="cb42-12"><a href="#cb42-12"></a><span class="co"># Extract loadings</span></span>
<span id="cb42-13"><a href="#cb42-13"></a></span>
<span id="cb42-14"><a href="#cb42-14"></a><span class="fu">standardizedsolution</span>(fit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  lhs op     rhs est.std    se       z pvalue ci.lower ci.upper
1 lvh =~    ESCS   0.870 0.008 107.852      0    0.854    0.885
2 lvh =~ HOMEPOS   0.865 0.008 107.716      0    0.850    0.881
3 lvc =~ PV1MATH   0.936 0.002 443.944      0    0.932    0.941
4 lvc =~ PV1READ   0.841 0.003 262.406      0    0.834    0.847
 [ reached 'max' / getOption("max.print") -- omitted 12 rows ]</code></pre>
</div>
</div>
<p>The output table gives you a list of the factor loadings between pairs of variables. For example, the first pair is the latent variable for the home environment (<code>lvh</code>) and social class (<code>ESCS</code>). The loading estimate is given in the <code>est.std</code> column - 0.870 in this case. The columns <code>ci.lower</code> and <code>ci.upper</code> give the 95% confidence interval for the loading.The <code>pvalue</code> column returns the p-value for the loading. There is no well defined cut off in the literature, but if you have variables that have low loadings you may wish to reconsider their inclusion in the model.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>There is disagreement in the literature as concerns the cut off for low factor loading. For example Hulland <span class="citation" data-cites="hulland1999use">(<a href="#ref-hulland1999use" role="doc-biblioref">1999</a>)</span> suggests adopting the value commonly used in factor analysis, &lt; 0.4. By contrast, Fornell and Larcker <span class="citation" data-cites="fornell1981evaluating">(<a href="#ref-fornell1981evaluating" role="doc-biblioref">1981</a>)</span> recommend 0.7 and Chin <span class="citation" data-cites="chin1998partial">(<a href="#ref-chin1998partial" role="doc-biblioref">1998</a>)</span> prefers 0.707. Decisions will be field dependent so it is worth reading papers in your field to get a sense of the conventions in your discipline.</p>
</div>
</div>
<p>Another useful measure are the R<sup>2</sup> values for each item in the model. Each item is treated as a dependent variable and an R<sup>2</sup> value (the proportion of variance it explains) can be calculated using the <code>parameterEstimates</code> function. We then filter for the operator related to R<sup>2</sup> and select the relevant columns to make the data easier to read. An <code>arrange</code> in descending order can also be useful.</p>
<p>The estimates here should be thought of as the percentage of variance of that item that is explained by the latent variable it is associated with.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="co"># Extract R^2 values for the model</span></span>
<span id="cb44-2"><a href="#cb44-2"></a></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="fu">parameterEstimates</span>(fit, <span class="at">rsquare =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="fu">filter</span>(op <span class="sc">==</span> <span class="st">"r2"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-5"><a href="#cb44-5"></a>  <span class="fu">select</span>(<span class="at">Item=</span>rhs, <span class="at">R2 =</span> est) <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(R2))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Item    R2
1 PV1MATH 0.877
2 PV1SCIE 0.846
3    ESCS 0.756
4 HOMEPOS 0.749
5 PV1READ 0.706</code></pre>
</div>
</div>
<p>For example, <code>ESCS</code> in the model is associated with <code>lvh</code>, the home environment latent variable. Therefore the R<sup>2</sup> value here indicates that 75.6% of the variance in <code>ESCS</code> is explained by <code>lvh</code>.</p>
</section>
</section>
<section id="seminar-activities" class="level2" data-number="1.9">
<h2 data-number="1.9" class="anchored" data-anchor-id="seminar-activities"><span class="header-section-number">1.9</span> Seminar activities</h2>
<section id="task-1---create-a-model-of-science-score" class="level3" data-number="1.9.1">
<h3 data-number="1.9.1" class="anchored" data-anchor-id="task-1---create-a-model-of-science-score"><span class="header-section-number">1.9.1</span> Task 1 - create a model of science score</h3>
<div class="question">
<p>Consider the mathematics score in the PISA data (<code>PV1SCIE</code>). On a piece of paper, draw out a path diagram of the variables that might influence science score. Try and estimate the relative strength of the effect of those variables on mathematics score. You might consider variables such as <code>IQ</code> and <code>teacher_quality</code>.</p>
</div>
</section>
<section id="task-2---simple-models-of-achievement" class="level3" data-number="1.9.2">
<h3 data-number="1.9.2" class="anchored" data-anchor-id="task-2---simple-models-of-achievement"><span class="header-section-number">1.9.2</span> Task 2 - simple models of achievement</h3>
<div class="question">
<p>Try to create an SEM for science score in the UK. Let us assume that the variables theory suggest you include in your model are ability at mathematics and reading (<code>PV1MATH</code> and <code>PV1READ</code>) and wealth (<code>HOMEPOS</code>). Build a simple model in which those three variables have a direct relationship to science score, but don’t influence each other. Describe what your model suggests about the relationship between the variables.</p>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="co"># Create a data frame for UK science scores, with the variables we need</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="co"># For the model: Math, science, reading and wealth (HOMEPOS)</span></span>
<span id="cb46-3"><a href="#cb46-3"></a></span>
<span id="cb46-4"><a href="#cb46-4"></a></span>
<span id="cb46-5"><a href="#cb46-5"></a>UK_Sci_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb46-6"><a href="#cb46-6"></a>  <span class="fu">select</span>(CNT, HOMEPOS, PV1READ, PV1SCIE, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb46-7"><a href="#cb46-7"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)</span>
<span id="cb46-8"><a href="#cb46-8"></a></span>
<span id="cb46-9"><a href="#cb46-9"></a><span class="co"># Scale the the test scores so they are similar to the already scaled</span></span>
<span id="cb46-10"><a href="#cb46-10"></a><span class="co"># HOMEPOS score (i.e. have a mean of 0 and a sd of 1)</span></span>
<span id="cb46-11"><a href="#cb46-11"></a></span>
<span id="cb46-12"><a href="#cb46-12"></a>UK_Sci_data <span class="ot">&lt;-</span> UK_Sci_data <span class="sc">%&gt;%</span></span>
<span id="cb46-13"><a href="#cb46-13"></a>  <span class="fu">mutate</span>(<span class="at">PV1MATH =</span> <span class="fu">scale</span>(PV1MATH),</span>
<span id="cb46-14"><a href="#cb46-14"></a>         <span class="at">PV1SCIE =</span> <span class="fu">scale</span>(PV1SCIE),</span>
<span id="cb46-15"><a href="#cb46-15"></a>         <span class="at">PV1READ =</span> <span class="fu">scale</span>(PV1READ))</span>
<span id="cb46-16"><a href="#cb46-16"></a></span>
<span id="cb46-17"><a href="#cb46-17"></a></span>
<span id="cb46-18"><a href="#cb46-18"></a>model<span class="ot">&lt;-</span><span class="st">"PV1SCIE ~ HOMEPOS + PV1MATH + PV1READ"</span></span>
<span id="cb46-19"><a href="#cb46-19"></a></span>
<span id="cb46-20"><a href="#cb46-20"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UK_Sci_data, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<span id="cb46-21"><a href="#cb46-21"></a><span class="fu">summary</span>(fit)</span>
<span id="cb46-22"><a href="#cb46-22"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span>
<span id="cb46-23"><a href="#cb46-23"></a></span>
<span id="cb46-24"><a href="#cb46-24"></a><span class="co"># Science is most influenced by mathematics scores in this model (factor loading = 0.66), following</span></span>
<span id="cb46-25"><a href="#cb46-25"></a><span class="co"># by a smaller impact of reading (0.25). When the two academic scores are taken into account</span></span>
<span id="cb46-26"><a href="#cb46-26"></a><span class="co"># wealth (HOMEPOS) doesn't exert a large influence on science scores. The relatively high covariance</span></span>
<span id="cb46-27"><a href="#cb46-27"></a><span class="co"># between reading and mathematics scores (0.81) suggests this is not a great model. The residual term </span></span>
<span id="cb46-28"><a href="#cb46-28"></a><span class="co"># variance of 23.9% suggests that a significant portion of the variance in science scores is unexplained by the model.</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="question">
<p>Try to create an SEM for mathematics score in the UK. Let us assume that the variables theory suggest you include in your model are ability at reading (<code>PV1READ</code>) and wealth (<code>HOMEPOS</code>) and sense of belonging (<code>BELONG</code>). Build a simple model in which those three variables have a direct relationship to mathematics score, but don’t influence each other. Describe what your model suggests about the relationship between the variables.</p>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># Create a data frame for UK math scores, with the variables we need</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="co"># For the model: Math, reading, wealth (HOMEPOS) and class (BELONG)</span></span>
<span id="cb47-3"><a href="#cb47-3"></a></span>
<span id="cb47-4"><a href="#cb47-4"></a></span>
<span id="cb47-5"><a href="#cb47-5"></a>UK_math_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>  <span class="fu">select</span>(CNT, HOMEPOS, PV1READ, PV1MATH, BELONG) <span class="sc">%&gt;%</span></span>
<span id="cb47-7"><a href="#cb47-7"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)</span>
<span id="cb47-8"><a href="#cb47-8"></a></span>
<span id="cb47-9"><a href="#cb47-9"></a><span class="co"># Scale the the test scores so they are similar to the already scaled</span></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="co"># HOMEPOS score (i.e. have a mean of 0 and a sd of 1)</span></span>
<span id="cb47-11"><a href="#cb47-11"></a></span>
<span id="cb47-12"><a href="#cb47-12"></a>UK_math_data <span class="ot">&lt;-</span> UK_math_data <span class="sc">%&gt;%</span></span>
<span id="cb47-13"><a href="#cb47-13"></a>  <span class="fu">mutate</span>(<span class="at">PV1MATH =</span> <span class="fu">scale</span>(PV1MATH),</span>
<span id="cb47-14"><a href="#cb47-14"></a>         <span class="at">PV1READ =</span> <span class="fu">scale</span>(PV1READ))</span>
<span id="cb47-15"><a href="#cb47-15"></a></span>
<span id="cb47-16"><a href="#cb47-16"></a></span>
<span id="cb47-17"><a href="#cb47-17"></a>model<span class="ot">&lt;-</span><span class="st">"PV1MATH ~ HOMEPOS + PV1READ + BELONG"</span></span>
<span id="cb47-18"><a href="#cb47-18"></a></span>
<span id="cb47-19"><a href="#cb47-19"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UK_math_data)</span>
<span id="cb47-20"><a href="#cb47-20"></a><span class="fu">summary</span>(fit)</span>
<span id="cb47-21"><a href="#cb47-21"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span>
<span id="cb47-22"><a href="#cb47-22"></a></span>
<span id="cb47-23"><a href="#cb47-23"></a><span class="co"># This regression shows a positive and statistically significant relationship between HOMEPOS (wealth) and PV1MATH (Math scores). The relationship is statistically signifcant (p&lt;0.05). or each unit increase in HOMEPOS, PV1MATH increases by 0.126 units. This shows a very strong (0.753) and significant relationship between PV1READ (Reading scores) and PV1MATH (Math scores).  The weakest relationship is between BELONG and PV1MATH (0.055). The residual variance in PV1MATH (math scores), which is the part of the math score variance not explained by the predictors HOMEPOS, PV1READ, and BELONG. The estimate of 0.372 suggests that a significant amount of variance in PV1MATH remains unexplained, even after accounting for the predictors.  </span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="question">
<p>Create your own SEM using any continuous variables in some country (e.g, <code>PV1READ</code>, <code>HOMEPOS</code>, <code>BELONG</code> etc.). Describe what your model suggests about the relationship between the variables.</p>
</div>
</section>
<section id="task-3---a-model-with-a-latent-variable" class="level3" data-number="1.9.3">
<h3 data-number="1.9.3" class="anchored" data-anchor-id="task-3---a-model-with-a-latent-variable"><span class="header-section-number">1.9.3</span> Task 3 - a model with a latent variable</h3>
<div class="question">
<p>Performance in science (<code>PV1READ</code>) might be thought to depend on two latent variables. Cognitive ability (you might label this <code>cog</code>) - which loads on <code>PV1MATH</code> and <code>PV1SCIE</code> and the home environment (<code>home</code>) which loads on wealth (<code>HOMEPOS</code>) and social class (<code>ESCS</code>)</p>
<p>Build an SEM model of reading achievement in the UK with these two latent variables and comment on what the model shows you.</p>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># Create data set</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>UKdata <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3"></a>  <span class="fu">select</span>(CNT, PV1SCIE, PV1MATH, PV1READ, HOMEPOS, ESCS) <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>) </span>
<span id="cb48-5"><a href="#cb48-5"></a></span>
<span id="cb48-6"><a href="#cb48-6"></a><span class="co"># Set up the model with</span></span>
<span id="cb48-7"><a href="#cb48-7"></a></span>
<span id="cb48-8"><a href="#cb48-8"></a></span>
<span id="cb48-9"><a href="#cb48-9"></a>model<span class="ot">&lt;-</span><span class="st">"PV1MATH ~ cog + home</span></span>
<span id="cb48-10"><a href="#cb48-10"></a><span class="st">        cog =~ PV1READ + PV1SCIE</span></span>
<span id="cb48-11"><a href="#cb48-11"></a><span class="st">        home =~ HOMEPOS + ESCS "</span></span>
<span id="cb48-12"><a href="#cb48-12"></a></span>
<span id="cb48-13"><a href="#cb48-13"></a>fit <span class="ot">&lt;-</span> <span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<span id="cb48-14"><a href="#cb48-14"></a><span class="fu">summary</span>(fit)</span>
<span id="cb48-15"><a href="#cb48-15"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="task-4---a-more-complex-latent-variable" class="level3" data-number="1.9.4">
<h3 data-number="1.9.4" class="anchored" data-anchor-id="task-4---a-more-complex-latent-variable"><span class="header-section-number">1.9.4</span> Task 4 - a more complex latent variable</h3>
<div class="question">
<p>Performance in science (<code>PV1MATH</code>) might be thought to depend on a number of latent variables. For example, a latent variable related to cognitive ability (you might label this <code>cog</code>) to school variables (<code>sch</code>) and to the home environment (<code>home</code>).</p>
<p>Build an SEM model of science achievement in <code>Hong Kong (China)</code> (chosen as it has the least missing data) with these three latent variables and comment on what the model shows you.</p>
<p>Variables that might be of interest include:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 79%">
</colgroup>
<thead>
<tr class="header">
<th>Item name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HOMEPOS</td>
<td>Family Wealth</td>
</tr>
<tr class="even">
<td>ESCS</td>
<td>Index of economic, social and cultural status</td>
</tr>
<tr class="odd">
<td>BELONG</td>
<td>Sense of belonging</td>
</tr>
<tr class="even">
<td>PARINVOL</td>
<td>Parental involvement</td>
</tr>
<tr class="odd">
<td>DISCLIM</td>
<td>Disciplinary climate in mathematics (WLE)”</td>
</tr>
<tr class="even">
<td>BULLIED</td>
<td>Bullied at school</td>
</tr>
<tr class="odd">
<td>PV1SCIE</td>
<td>Science score</td>
</tr>
<tr class="even">
<td>PV1MATH</td>
<td>Mathematics score</td>
</tr>
<tr class="odd">
<td>PV1READ</td>
<td>Reading score</td>
</tr>
</tbody>
</table>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># Create data set</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>HKdata <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3"></a>  <span class="fu">select</span>(CNT, PV1SCIE, PV1MATH, PV1READ, HOMEPOS, ESCS, BELONG, PARINVOL, DISCLIM, BULLIED) <span class="sc">%&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Hong Kong (China)"</span>) </span>
<span id="cb49-5"><a href="#cb49-5"></a></span>
<span id="cb49-6"><a href="#cb49-6"></a><span class="co"># Set up the model with</span></span>
<span id="cb49-7"><a href="#cb49-7"></a><span class="co"># Cogntive latent variable (cog) - based on academic scores PV1READ and PV1SCIE</span></span>
<span id="cb49-8"><a href="#cb49-8"></a><span class="co"># Home latent variable (home) - based on HOMEPOS (wealth), ESCS (social class), PARINVOL (parental involvement)</span></span>
<span id="cb49-9"><a href="#cb49-9"></a><span class="co"># School latent variable (sch) - based on DISCLIM (discipline in maths), BULLIED (level of bullying), BELONG (sense of belonging)</span></span>
<span id="cb49-10"><a href="#cb49-10"></a></span>
<span id="cb49-11"><a href="#cb49-11"></a>model<span class="ot">&lt;-</span><span class="st">"PV1MATH ~ cog + home + sch</span></span>
<span id="cb49-12"><a href="#cb49-12"></a><span class="st">        cog =~ PV1READ + PV1SCIE</span></span>
<span id="cb49-13"><a href="#cb49-13"></a><span class="st">        home =~ HOMEPOS + ESCS + PARINVOL</span></span>
<span id="cb49-14"><a href="#cb49-14"></a><span class="st">        sch =~  DISCLIM + BULLIED + BELONG</span></span>
<span id="cb49-15"><a href="#cb49-15"></a><span class="st">        PV1SCIE ~ PV1MATH"</span></span>
<span id="cb49-16"><a href="#cb49-16"></a></span>
<span id="cb49-17"><a href="#cb49-17"></a>fit <span class="ot">&lt;-</span> <span class="fu">sem</span>(model, <span class="at">data =</span> HKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<span id="cb49-18"><a href="#cb49-18"></a><span class="fu">summary</span>(fit)</span>
<span id="cb49-19"><a href="#cb49-19"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="task-5---models-with-categorical-variables" class="level3" data-number="1.9.5">
<h3 data-number="1.9.5" class="anchored" data-anchor-id="task-5---models-with-categorical-variables"><span class="header-section-number">1.9.5</span> Task 5 - models with categorical variables</h3>
<div class="question">
<p>Create a model of mathematics scores in the UK, using the predictors gender (<code>ST004D01T</code>), reading score (<code>PV1READ</code>), wealth (<code>HOMEPOS</code>), and social class (<code>ESCS</code>).</p>
<p>Hint: remember to turn gender into a factor variable and use <code>estimator = "MLR"</code> for the categorical variable. Remember to scale the test items.</p>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="co"># Create a data frame with the required base variables</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>UKdata<span class="ot">&lt;-</span>PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3"></a>  <span class="fu">select</span>(CNT, ESCS, HOMEPOS, PV1READ, PV1MATH, ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-6"><a href="#cb50-6"></a>  <span class="fu">rename</span>(<span class="at">gen =</span> ST004D01T) <span class="co"># for ease of display</span></span>
<span id="cb50-7"><a href="#cb50-7"></a></span>
<span id="cb50-8"><a href="#cb50-8"></a><span class="co"># set ST004D01T to a factor</span></span>
<span id="cb50-9"><a href="#cb50-9"></a></span>
<span id="cb50-10"><a href="#cb50-10"></a>UKdata<span class="sc">$</span>gen <span class="ot">&lt;-</span> <span class="fu">factor</span>(UKdata<span class="sc">$</span>gen, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Male"</span>, <span class="st">"Female"</span>))</span>
<span id="cb50-11"><a href="#cb50-11"></a></span>
<span id="cb50-12"><a href="#cb50-12"></a></span>
<span id="cb50-13"><a href="#cb50-13"></a><span class="co"># Scale the numeric variables</span></span>
<span id="cb50-14"><a href="#cb50-14"></a></span>
<span id="cb50-15"><a href="#cb50-15"></a>UKdata <span class="ot">&lt;-</span> UKdata <span class="sc">%&gt;%</span></span>
<span id="cb50-16"><a href="#cb50-16"></a>  <span class="fu">mutate</span>(<span class="at">ESCS =</span> <span class="fu">scale</span>(ESCS),</span>
<span id="cb50-17"><a href="#cb50-17"></a>         <span class="at">HOMEPOS =</span> <span class="fu">scale</span>(HOMEPOS),</span>
<span id="cb50-18"><a href="#cb50-18"></a>         <span class="at">PV1READ =</span> <span class="fu">scale</span>(PV1READ),</span>
<span id="cb50-19"><a href="#cb50-19"></a>         <span class="at">PV1MATH =</span> <span class="fu">scale</span>(PV1MATH))</span>
<span id="cb50-20"><a href="#cb50-20"></a>         </span>
<span id="cb50-21"><a href="#cb50-21"></a><span class="co"># Create the model</span></span>
<span id="cb50-22"><a href="#cb50-22"></a></span>
<span id="cb50-23"><a href="#cb50-23"></a>model <span class="ot">&lt;-</span> <span class="st">"PV1MATH ~ gen + HOMEPOS + ESCS"</span></span>
<span id="cb50-24"><a href="#cb50-24"></a></span>
<span id="cb50-25"><a href="#cb50-25"></a>fit <span class="ot">&lt;-</span> <span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">estimator =</span> <span class="st">"MLR"</span>)</span>
<span id="cb50-26"><a href="#cb50-26"></a><span class="fu">summary</span>(fit)</span>
<span id="cb50-27"><a href="#cb50-27"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="task-6---models-with-categorical-variables" class="level3" data-number="1.9.6">
<h3 data-number="1.9.6" class="anchored" data-anchor-id="task-6---models-with-categorical-variables"><span class="header-section-number">1.9.6</span> Task 6 - models with categorical variables</h3>
<div class="question">
<p>Make a SEM of reading scores in the PISA data for students in the United States. Consider co-variation between independent variables. First consider what independent variables in the data set might influence reading scores. Some potential items of interest include:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 79%">
</colgroup>
<thead>
<tr class="header">
<th>Item name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ST005Q01JA</td>
<td>What is the <highest level="" of="" schooling=""> completed by your mother?</highest></td>
</tr>
<tr class="even">
<td>ST007Q01JA</td>
<td>What is the <highest level="" of="" schooling=""> completed by your father?</highest></td>
</tr>
<tr class="odd">
<td>ST256Q02JA</td>
<td>In your home: Classic literature (e.g.&nbsp;<shakespeare>)</shakespeare></td>
</tr>
<tr class="even">
<td>ST255Q01JA</td>
<td>How many books are there in your home?</td>
</tr>
<tr class="odd">
<td>HOMEPOS</td>
<td>Family Wealth</td>
</tr>
<tr class="even">
<td>ESCS</td>
<td>Index of economic, social and cultural status</td>
</tr>
<tr class="odd">
<td>ST254Q02JA</td>
<td>How many of the following [digital devices] are in your</td>
</tr>
<tr class="even">
<td></td>
<td>[home]: Desktop computers</td>
</tr>
</tbody>
</table>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you use ordinal variables, don’t forget to specify them as such in the model. Ensure: • the variable is categorised as an ordinal variable • In the <code>fit</code> function we need to label the ordinal functions. • Set the model estimate to WLSMV (Weighted Least Squares Mean and Variance-adjusted).</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="co"># Using ST255Q01JA  How many books are there in your home?</span></span>
<span id="cb51-2"><a href="#cb51-2"></a><span class="co"># ST254Q02JA    How many in your home: Computers (desktop computer, portable laptop, or notebook)</span></span>
<span id="cb51-3"><a href="#cb51-3"></a></span>
<span id="cb51-4"><a href="#cb51-4"></a>USdata <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb51-5"><a href="#cb51-5"></a>  <span class="fu">select</span>(CNT, ESCS, HOMEPOS, PV1READ, ST255Q01JA, ST254Q02JA, ST005Q01JA, ST007Q01JA,</span>
<span id="cb51-6"><a href="#cb51-6"></a>         ST256Q02JA, ST255Q01JA) <span class="sc">%&gt;%</span></span>
<span id="cb51-7"><a href="#cb51-7"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United States"</span>)</span>
<span id="cb51-8"><a href="#cb51-8"></a></span>
<span id="cb51-9"><a href="#cb51-9"></a><span class="co"># set ordinal variables to ordered</span></span>
<span id="cb51-10"><a href="#cb51-10"></a></span>
<span id="cb51-11"><a href="#cb51-11"></a>USdata<span class="sc">$</span>ST254Q02JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(USdata<span class="sc">$</span>ST254Q02JA)</span>
<span id="cb51-12"><a href="#cb51-12"></a>USdata<span class="sc">$</span>ST255Q01JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(USdata<span class="sc">$</span>ST255Q01JA)</span>
<span id="cb51-13"><a href="#cb51-13"></a>USdata<span class="sc">$</span>ST254Q02JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(USdata<span class="sc">$</span>ST254Q02JA)</span>
<span id="cb51-14"><a href="#cb51-14"></a>USdata<span class="sc">$</span>ST005Q01JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(USdata<span class="sc">$</span>ST005Q01JA)</span>
<span id="cb51-15"><a href="#cb51-15"></a>USdata<span class="sc">$</span>ST007Q01JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(USdata<span class="sc">$</span>ST007Q01JA)</span>
<span id="cb51-16"><a href="#cb51-16"></a></span>
<span id="cb51-17"><a href="#cb51-17"></a><span class="co"># Scale the numeric variables</span></span>
<span id="cb51-18"><a href="#cb51-18"></a></span>
<span id="cb51-19"><a href="#cb51-19"></a>USdata <span class="ot">&lt;-</span> USdata <span class="sc">%&gt;%</span></span>
<span id="cb51-20"><a href="#cb51-20"></a>  <span class="fu">mutate</span>(<span class="at">ESCS =</span> <span class="fu">scale</span>(ESCS),</span>
<span id="cb51-21"><a href="#cb51-21"></a>         <span class="at">HOMEPOS =</span> <span class="fu">scale</span>(HOMEPOS),</span>
<span id="cb51-22"><a href="#cb51-22"></a>         <span class="at">PV1READ =</span> <span class="fu">scale</span>(PV1READ)) <span class="sc">%&gt;%</span></span>
<span id="cb51-23"><a href="#cb51-23"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb51-24"><a href="#cb51-24"></a></span>
<span id="cb51-25"><a href="#cb51-25"></a></span>
<span id="cb51-26"><a href="#cb51-26"></a>model <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb51-27"><a href="#cb51-27"></a><span class="st">  # Latent variable definitions</span></span>
<span id="cb51-28"><a href="#cb51-28"></a><span class="st">  # Parental ed</span></span>
<span id="cb51-29"><a href="#cb51-29"></a><span class="st">  par_ed =~ ST005Q01JA + ST007Q01JA</span></span>
<span id="cb51-30"><a href="#cb51-30"></a><span class="st">  # Home environment</span></span>
<span id="cb51-31"><a href="#cb51-31"></a><span class="st">  home =~ ST256Q02JA + ST255Q01JA</span></span>
<span id="cb51-32"><a href="#cb51-32"></a><span class="st">  # social class</span></span>
<span id="cb51-33"><a href="#cb51-33"></a><span class="st">  clas =~ HOMEPOS + ESCS</span></span>
<span id="cb51-34"><a href="#cb51-34"></a><span class="st">  </span></span>
<span id="cb51-35"><a href="#cb51-35"></a><span class="st">  # Observed variable for digital access</span></span>
<span id="cb51-36"><a href="#cb51-36"></a><span class="st">  dig =~ ST254Q02JA</span></span>
<span id="cb51-37"><a href="#cb51-37"></a><span class="st">  </span></span>
<span id="cb51-38"><a href="#cb51-38"></a><span class="st">  # Regression relationships</span></span>
<span id="cb51-39"><a href="#cb51-39"></a><span class="st">  PV1READ ~ par_ed+ home + clas + dig"</span></span>
<span id="cb51-40"><a href="#cb51-40"></a></span>
<span id="cb51-41"><a href="#cb51-41"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> USdata, <span class="at">ordered =</span> <span class="fu">c</span>(<span class="st">"ST255Q01JA"</span>, <span class="st">"ST254Q02JA"</span>, <span class="st">"ST005Q01JA"</span>, <span class="st">"ST007Q01JA"</span>,</span>
<span id="cb51-42"><a href="#cb51-42"></a>                                           <span class="st">"ST256Q02JA"</span>),</span>
<span id="cb51-43"><a href="#cb51-43"></a>         <span class="at">estimator =</span> <span class="st">"WLSMV"</span>)</span>
<span id="cb51-44"><a href="#cb51-44"></a><span class="fu">summary</span>(fit)</span>
<span id="cb51-45"><a href="#cb51-45"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>, <span class="at">label.cex =</span> <span class="fl">0.8</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="task-7---model-checks-and-improvements" class="level3" data-number="1.9.7">
<h3 data-number="1.9.7" class="anchored" data-anchor-id="task-7---model-checks-and-improvements"><span class="header-section-number">1.9.7</span> Task 7 - model checks and improvements</h3>
<div class="question">
<p>Using the model you developed in task 6: a) assess the model fit - how good is your model? b) use model modification indices to improve your model</p>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># Create a UK data frame with plausible values for reading math and science</span></span>
<span id="cb52-2"><a href="#cb52-2"></a></span>
<span id="cb52-3"><a href="#cb52-3"></a>UKdata <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb52-4"><a href="#cb52-4"></a>  <span class="fu">select</span>(CNT, ESCS, HOMEPOS, ST005Q01JA, ST007Q01JA, PV1READ, PV1SCIE, </span>
<span id="cb52-5"><a href="#cb52-5"></a>         PV1MATH, ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb52-6"><a href="#cb52-6"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)</span>
<span id="cb52-7"><a href="#cb52-7"></a></span>
<span id="cb52-8"><a href="#cb52-8"></a><span class="co"># Convert to ordinal variables to ordinal</span></span>
<span id="cb52-9"><a href="#cb52-9"></a></span>
<span id="cb52-10"><a href="#cb52-10"></a>UKdata<span class="sc">$</span>ST005Q01JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(UKdata<span class="sc">$</span>ST005Q01JA)</span>
<span id="cb52-11"><a href="#cb52-11"></a>UKdata<span class="sc">$</span>ST007Q01JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(UKdata<span class="sc">$</span>ST007Q01JA)</span>
<span id="cb52-12"><a href="#cb52-12"></a>UKdata<span class="sc">$</span>ST004D01T <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(UKdata<span class="sc">$</span>ST004D01T)</span>
<span id="cb52-13"><a href="#cb52-13"></a></span>
<span id="cb52-14"><a href="#cb52-14"></a><span class="co"># Scale the test scores</span></span>
<span id="cb52-15"><a href="#cb52-15"></a></span>
<span id="cb52-16"><a href="#cb52-16"></a>UKdata<span class="sc">$</span>PV1READ <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1READ)</span>
<span id="cb52-17"><a href="#cb52-17"></a>UKdata<span class="sc">$</span>PV1MATH <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1MATH)</span>
<span id="cb52-18"><a href="#cb52-18"></a>UKdata<span class="sc">$</span>PV1SCIE <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1SCIE)</span>
<span id="cb52-19"><a href="#cb52-19"></a></span>
<span id="cb52-20"><a href="#cb52-20"></a><span class="co"># Propose a model with two latent variables - one related to identity (lvi), the other ability (lva)</span></span>
<span id="cb52-21"><a href="#cb52-21"></a></span>
<span id="cb52-22"><a href="#cb52-22"></a>model<span class="ot">&lt;-</span><span class="st">"lvi =~ ESCS + HOMEPOS + ST005Q01JA + ST007Q01JA + ST004D01T</span></span>
<span id="cb52-23"><a href="#cb52-23"></a><span class="st">        lva =~ PV1MATH + PV1READ</span></span>
<span id="cb52-24"><a href="#cb52-24"></a><span class="st">        PV1SCIE ~ lvi + lva"</span></span>
<span id="cb52-25"><a href="#cb52-25"></a></span>
<span id="cb52-26"><a href="#cb52-26"></a><span class="co"># Fit the model</span></span>
<span id="cb52-27"><a href="#cb52-27"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data=</span>UKdata, <span class="at">ordered =</span> <span class="fu">c</span>(<span class="st">"ST005Q01JA"</span>, <span class="st">"ST007Q01JA"</span>, <span class="st">"ST004D01T"</span>),</span>
<span id="cb52-28"><a href="#cb52-28"></a>         <span class="at">estimator =</span> <span class="st">"WLSMV"</span>)</span>
<span id="cb52-29"><a href="#cb52-29"></a><span class="fu">summary</span>(fit, <span class="at">fit.measures =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-30"><a href="#cb52-30"></a></span>
<span id="cb52-31"><a href="#cb52-31"></a><span class="co"># Evaluating my models fit</span></span>
<span id="cb52-32"><a href="#cb52-32"></a><span class="co"># Chi square is 0.000 which is &lt;0.05 suggesting a poor fit</span></span>
<span id="cb52-33"><a href="#cb52-33"></a><span class="co"># CFI is &gt;0.95 suggesting good fit</span></span>
<span id="cb52-34"><a href="#cb52-34"></a><span class="co"># TLI is &gt;0.95 suggesting good fit</span></span>
<span id="cb52-35"><a href="#cb52-35"></a><span class="co"># RMSEA is 0.036 suggesting a very good fit</span></span>
<span id="cb52-36"><a href="#cb52-36"></a></span>
<span id="cb52-37"><a href="#cb52-37"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span>
<span id="cb52-38"><a href="#cb52-38"></a></span>
<span id="cb52-39"><a href="#cb52-39"></a><span class="fu">modificationIndices</span>(fit, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-40"><a href="#cb52-40"></a><span class="co">#  The top two suggestions here are adding 'lva ~~  HOMEPOS' and 'lva   ~~ST004D01T' Don't seem</span></span>
<span id="cb52-41"><a href="#cb52-41"></a><span class="co"># to be justified from theory. Ability might not link to wealth and gender</span></span>
<span id="cb52-42"><a href="#cb52-42"></a><span class="co"># HOMEPOS   ~~  ST007Q01JA is a plausible suggestion - there is likely to be a link between father's lvel of education and wealth. And HOMEPOS  ~~  PV1SCIE - wealth links to science scores</span></span>
<span id="cb52-43"><a href="#cb52-43"></a></span>
<span id="cb52-44"><a href="#cb52-44"></a></span>
<span id="cb52-45"><a href="#cb52-45"></a>model_2 <span class="ot">&lt;-</span><span class="st">"lvi =~ ESCS + HOMEPOS + ST005Q01JA + ST007Q01JA + ST004D01T</span></span>
<span id="cb52-46"><a href="#cb52-46"></a><span class="st">        lva =~ PV1MATH + PV1READ</span></span>
<span id="cb52-47"><a href="#cb52-47"></a><span class="st">        PV1SCIE ~ lvi + lva</span></span>
<span id="cb52-48"><a href="#cb52-48"></a><span class="st">        HOMEPOS ~~  ST007Q01JA</span></span>
<span id="cb52-49"><a href="#cb52-49"></a><span class="st">        HOMEPOS ~~  PV1SCIE"</span></span>
<span id="cb52-50"><a href="#cb52-50"></a></span>
<span id="cb52-51"><a href="#cb52-51"></a><span class="co"># Fit the model</span></span>
<span id="cb52-52"><a href="#cb52-52"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model_2, <span class="at">data=</span>UKdata)</span>
<span id="cb52-53"><a href="#cb52-53"></a><span class="fu">summary</span>(fit, <span class="at">fit.measures =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-54"><a href="#cb52-54"></a></span>
<span id="cb52-55"><a href="#cb52-55"></a><span class="co"># Evaluating my models fit</span></span>
<span id="cb52-56"><a href="#cb52-56"></a><span class="co"># Chi square is 0.000 suggesting still a poor fit (but the chi-square statistics has come down from:  608.789 to 455.399)</span></span>
<span id="cb52-57"><a href="#cb52-57"></a><span class="co"># CFI is &gt;0.988 suggesting good fit -this has gone up!</span></span>
<span id="cb52-58"><a href="#cb52-58"></a><span class="co"># TLI is  0.979 which is an improvement</span></span>
<span id="cb52-59"><a href="#cb52-59"></a><span class="co"># RMSEA is now 0.054, down from 0.036 a slightly worse fit than before!</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="task-8---report-factor-loadings-and-r2-for-your-model" class="level3" data-number="1.9.8">
<h3 data-number="1.9.8" class="anchored" data-anchor-id="task-8---report-factor-loadings-and-r2-for-your-model"><span class="header-section-number">1.9.8</span> Task 8 - report factor loadings and R<sup>2</sup> for your model</h3>
<div class="question">
<p>In task 6, you built a model of two latent variables underlying UK students’ performance in science - a science self-identity variable (related to the home environment, for example, gender, parents’ level of education) and a cognitive ability variable (indicated by performance in other subjects).</p>
<p>You have modified the model using modification indices. Now extract the factor loadings and the R^2@ of your items. Discuss what the coefficients tell you about the variables in your model.</p>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>UKdata <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">select</span>(CNT, ESCS, HOMEPOS, ST005Q01JA, ST007Q01JA, PV1READ, PV1SCIE, </span>
<span id="cb53-3"><a href="#cb53-3"></a>         PV1MATH, ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb53-4"><a href="#cb53-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-5"><a href="#cb53-5"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb53-6"><a href="#cb53-6"></a></span>
<span id="cb53-7"><a href="#cb53-7"></a><span class="co"># Convert to ordinal variables to ordinal</span></span>
<span id="cb53-8"><a href="#cb53-8"></a></span>
<span id="cb53-9"><a href="#cb53-9"></a>UKdata<span class="sc">$</span>ST005Q01JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(UKdata<span class="sc">$</span>ST005Q01JA)</span>
<span id="cb53-10"><a href="#cb53-10"></a>UKdata<span class="sc">$</span>ST005Q01JA <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(UKdata<span class="sc">$</span>ST005Q01JA)</span>
<span id="cb53-11"><a href="#cb53-11"></a></span>
<span id="cb53-12"><a href="#cb53-12"></a><span class="co"># Convert categorical variables to factors</span></span>
<span id="cb53-13"><a href="#cb53-13"></a></span>
<span id="cb53-14"><a href="#cb53-14"></a>UKdata<span class="sc">$</span>ST004D01T <span class="ot">&lt;-</span> <span class="fu">factor</span>(UKdata<span class="sc">$</span>ST004D01T, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Male"</span>, <span class="st">"Female"</span>))</span>
<span id="cb53-15"><a href="#cb53-15"></a></span>
<span id="cb53-16"><a href="#cb53-16"></a></span>
<span id="cb53-17"><a href="#cb53-17"></a><span class="co"># Scale the test scores</span></span>
<span id="cb53-18"><a href="#cb53-18"></a></span>
<span id="cb53-19"><a href="#cb53-19"></a>UKdata<span class="sc">$</span>PV1READ <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1READ)</span>
<span id="cb53-20"><a href="#cb53-20"></a>UKdata<span class="sc">$</span>PV1MATH <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1MATH)</span>
<span id="cb53-21"><a href="#cb53-21"></a>UKdata<span class="sc">$</span>PV1SCIE <span class="ot">&lt;-</span> <span class="fu">scale</span>(UKdata<span class="sc">$</span>PV1SCIE)</span>
<span id="cb53-22"><a href="#cb53-22"></a></span>
<span id="cb53-23"><a href="#cb53-23"></a><span class="co"># Propose a model with two latent variables - one related to identity (lvi), the other ability (lva)</span></span>
<span id="cb53-24"><a href="#cb53-24"></a></span>
<span id="cb53-25"><a href="#cb53-25"></a>model<span class="ot">&lt;-</span><span class="st">"lvi =~ ESCS + HOMEPOS + ST005Q01JA + ST007Q01JA + ST004D01T</span></span>
<span id="cb53-26"><a href="#cb53-26"></a><span class="st">        lva =~ PV1MATH + PV1READ</span></span>
<span id="cb53-27"><a href="#cb53-27"></a><span class="st">        PV1SCIE ~ lvi + lva"</span></span>
<span id="cb53-28"><a href="#cb53-28"></a></span>
<span id="cb53-29"><a href="#cb53-29"></a><span class="co"># Fit the model</span></span>
<span id="cb53-30"><a href="#cb53-30"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model, <span class="at">data =</span> UKdata, <span class="at">ordered =</span> <span class="fu">c</span>(<span class="st">"ST005Q01JA"</span>, <span class="st">"ST007Q01JA"</span>, <span class="st">"ST004D01T"</span>),</span>
<span id="cb53-31"><a href="#cb53-31"></a>         <span class="at">estimator =</span> <span class="st">"WLSMV"</span>)</span>
<span id="cb53-32"><a href="#cb53-32"></a></span>
<span id="cb53-33"><a href="#cb53-33"></a><span class="co"># Extract loadings</span></span>
<span id="cb53-34"><a href="#cb53-34"></a><span class="fu">standardizedsolution</span>(fit)</span>
<span id="cb53-35"><a href="#cb53-35"></a></span>
<span id="cb53-36"><a href="#cb53-36"></a><span class="co"># The self-identity latent variable loads strongly to social class (0.859) and less strongly to</span></span>
<span id="cb53-37"><a href="#cb53-37"></a><span class="co"># wealth (0.718). Curiously, the self-identity latent variable has a strong negative loading (-0.636) to # mother's highest level of  schooling (ST005Q01JA) and to father's level of schooling (ST007Q01JA) (-0.619).</span></span>
<span id="cb53-38"><a href="#cb53-38"></a><span class="co"># Self-identity loads very weakly to gender (-0.001). The loading for gender is not significant. By contrast the achievement  test scores PV1MATH (0.940) and PV1READ (0.836) load strongly on the achievement latent variable (lva)</span></span>
<span id="cb53-39"><a href="#cb53-39"></a></span>
<span id="cb53-40"><a href="#cb53-40"></a><span class="co"># Extract R^2</span></span>
<span id="cb53-41"><a href="#cb53-41"></a></span>
<span id="cb53-42"><a href="#cb53-42"></a><span class="fu">parameterEstimates</span>(fit, <span class="at">rsquare =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-43"><a href="#cb53-43"></a>  <span class="fu">filter</span>(op <span class="sc">==</span> <span class="st">"r2"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb53-44"><a href="#cb53-44"></a>  <span class="fu">select</span>(<span class="at">Item=</span>rhs, <span class="at">R2 =</span> est) <span class="sc">%&gt;%</span></span>
<span id="cb53-45"><a href="#cb53-45"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(R2))</span>
<span id="cb53-46"><a href="#cb53-46"></a></span>
<span id="cb53-47"><a href="#cb53-47"></a><span class="co"># The achievement variables are the best explained by the achievement latent variable</span></span>
<span id="cb53-48"><a href="#cb53-48"></a><span class="co"># 88.4% of the mathematics score, 84.6% of the science score and 69.8% of the reading score are </span></span>
<span id="cb53-49"><a href="#cb53-49"></a><span class="co"># explained by the latent achievement variable (lva)</span></span>
<span id="cb53-50"><a href="#cb53-50"></a><span class="co"># The self-identity variable accounts for 73.8% of social class (ESCS)</span></span>
<span id="cb53-51"><a href="#cb53-51"></a><span class="co"># 51.6% of wealth (HOMEPOS) and 45.8% of mother's occupation (ST005Q01JA) and  38.3% of father's </span></span>
<span id="cb53-52"><a href="#cb53-52"></a><span class="co"># occupation (ST007Q01JA). As the loading and its p-value led us to expect - gender is not explained</span></span>
<span id="cb53-53"><a href="#cb53-53"></a><span class="co"># by the latent variable (0%)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="task-9---create-your-own-model-of-overall-achievement-in-hong-kong-china" class="level3" data-number="1.9.9">
<h3 data-number="1.9.9" class="anchored" data-anchor-id="task-9---create-your-own-model-of-overall-achievement-in-hong-kong-china"><span class="header-section-number">1.9.9</span> Task 9 - create your own model of overall achievement in Hong Kong (China)</h3>
<div class="question">
<p>Develop your own SEM model of overall achievement in Hong Kong (China). I have chosen Hong Kong as it has the least missing data. Create a new variable <code>z_pv_overall</code> which is the mean score across <code>PV1READ</code>, <code>PV1MATH</code>, and <code>PV1SCIE</code>. Do then use <code>scale</code> to standardise the score.</p>
<p>Reflect on the theory you know and select a range of variables (recall the function <code>lapply(PISA_2022, attr, "label")</code> will give you the names of all the times) to build a model of overall achievement. Do include some latent variables of your choice.</p>
<p>Perform checks of model fit for your first model and use modification indices to improve the model. Report the factor loads, and R<sup>2</sup> terms. Discuss what your model tells you about overall achievement in PISA data for the UK.</p>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Do check all the items you choose have data for the UK before building your model</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Answer</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="co"># Create a Hong Kong data frame with required variables</span></span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a>HK_data <span class="ot">&lt;-</span> PISA_2022 <span class="sc">%&gt;%</span></span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="fu">select</span>(CNT, PV1READ, PV1SCIE, PV1MATH, BELONG, DISCLIM,</span>
<span id="cb54-5"><a href="#cb54-5"></a>         ST016Q01NA, WB150Q01HA, WB156Q01HA) <span class="sc">%&gt;%</span> <span class="co"># Rename for ease</span></span>
<span id="cb54-6"><a href="#cb54-6"></a>         <span class="fu">rename</span>(<span class="at">sat =</span> ST016Q01NA, </span>
<span id="cb54-7"><a href="#cb54-7"></a>                <span class="at">hel =</span> WB150Q01HA, </span>
<span id="cb54-8"><a href="#cb54-8"></a>                <span class="at">fri =</span> WB156Q01HA) <span class="sc">%&gt;%</span></span>
<span id="cb54-9"><a href="#cb54-9"></a>  <span class="fu">mutate</span>(<span class="at">hel =</span> <span class="fu">case_when</span>(hel <span class="sc">==</span> <span class="st">"Very good"</span> <span class="sc">~</span> <span class="dv">5</span>,</span>
<span id="cb54-10"><a href="#cb54-10"></a>                         hel <span class="sc">==</span> <span class="st">"Good"</span> <span class="sc">~</span> <span class="dv">4</span>,</span>
<span id="cb54-11"><a href="#cb54-11"></a>                         hel <span class="sc">==</span> <span class="st">"Fair"</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb54-12"><a href="#cb54-12"></a>                         hel <span class="sc">==</span> <span class="st">"Poor"</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb54-13"><a href="#cb54-13"></a>                         hel <span class="sc">==</span> <span class="st">"Very poor"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb54-14"><a href="#cb54-14"></a>                         <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span>)) <span class="sc">%&gt;%</span> <span class="co"># Convert to numeric</span></span>
<span id="cb54-15"><a href="#cb54-15"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Hong Kong (China)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-16"><a href="#cb54-16"></a>  <span class="fu">mutate</span>(<span class="at">z_pv_overall =</span> <span class="fu">scale</span>(PV1READ <span class="sc">+</span> PV1MATH <span class="sc">+</span> PV1SCIE <span class="sc">/</span><span class="dv">3</span>)) <span class="sc">%&gt;%</span> <span class="co">#  scaled overall achievement score</span></span>
<span id="cb54-17"><a href="#cb54-17"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(z_pv_overall),</span>
<span id="cb54-18"><a href="#cb54-18"></a>         <span class="sc">!</span><span class="fu">is.na</span>(sat),</span>
<span id="cb54-19"><a href="#cb54-19"></a>         <span class="sc">!</span><span class="fu">is.na</span>(hel),</span>
<span id="cb54-20"><a href="#cb54-20"></a>         <span class="sc">!</span><span class="fu">is.na</span>(fri))</span>
<span id="cb54-21"><a href="#cb54-21"></a></span>
<span id="cb54-22"><a href="#cb54-22"></a><span class="co"># Convert to ordinal variables to ordinal</span></span>
<span id="cb54-23"><a href="#cb54-23"></a></span>
<span id="cb54-24"><a href="#cb54-24"></a>HK_data<span class="sc">$</span>hel <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(HK_data<span class="sc">$</span>hel)</span>
<span id="cb54-25"><a href="#cb54-25"></a>HK_data<span class="sc">$</span>sat <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(HK_data<span class="sc">$</span>sat)</span>
<span id="cb54-26"><a href="#cb54-26"></a>HK_data<span class="sc">$</span>fri <span class="ot">&lt;-</span> <span class="fu">as.ordered</span>(HK_data<span class="sc">$</span>fri)</span>
<span id="cb54-27"><a href="#cb54-27"></a></span>
<span id="cb54-28"><a href="#cb54-28"></a><span class="co"># Create a model with two latent variables</span></span>
<span id="cb54-29"><a href="#cb54-29"></a><span class="co"># lvw - wellbeing</span></span>
<span id="cb54-30"><a href="#cb54-30"></a><span class="co"># ST016Q01NA "Overall, how satisfied are you with your life as a whole these days?"</span></span>
<span id="cb54-31"><a href="#cb54-31"></a><span class="co"># WB150Q01HA "How is your health?"</span></span>
<span id="cb54-32"><a href="#cb54-32"></a><span class="co"># WB156Q01HA "At present, how many close friends do you have?"</span></span>
<span id="cb54-33"><a href="#cb54-33"></a></span>
<span id="cb54-34"><a href="#cb54-34"></a><span class="co">#</span></span>
<span id="cb54-35"><a href="#cb54-35"></a><span class="co"># lve - school environment</span></span>
<span id="cb54-36"><a href="#cb54-36"></a><span class="co"># DISCLIM "Disciplinary climate in mathematics (WLE)"</span></span>
<span id="cb54-37"><a href="#cb54-37"></a><span class="co"># BELONG  "Sense of belonging (WLE)"</span></span>
<span id="cb54-38"><a href="#cb54-38"></a><span class="co"># </span></span>
<span id="cb54-39"><a href="#cb54-39"></a></span>
<span id="cb54-40"><a href="#cb54-40"></a><span class="co"># define the model</span></span>
<span id="cb54-41"><a href="#cb54-41"></a>model_well_school <span class="ot">&lt;-</span> <span class="st">"lvw =~  sat + hel + fri</span></span>
<span id="cb54-42"><a href="#cb54-42"></a><span class="st">        lve =~ BELONG + DISCLIM</span></span>
<span id="cb54-43"><a href="#cb54-43"></a><span class="st">        z_pv_overall ~ lvw + lve"</span></span>
<span id="cb54-44"><a href="#cb54-44"></a></span>
<span id="cb54-45"><a href="#cb54-45"></a><span class="co"># Fit the model</span></span>
<span id="cb54-46"><a href="#cb54-46"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model_well_school, <span class="at">data =</span> HK_data, <span class="at">ordered =</span> <span class="fu">c</span>(<span class="st">"sat"</span>, <span class="st">"hel"</span>, <span class="st">"fri"</span>),</span>
<span id="cb54-47"><a href="#cb54-47"></a>         <span class="at">estimator =</span> <span class="st">"WLSMV"</span>)</span>
<span id="cb54-48"><a href="#cb54-48"></a></span>
<span id="cb54-49"><a href="#cb54-49"></a><span class="co"># plot</span></span>
<span id="cb54-50"><a href="#cb54-50"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span>
<span id="cb54-51"><a href="#cb54-51"></a></span>
<span id="cb54-52"><a href="#cb54-52"></a><span class="co"># Extract loadings</span></span>
<span id="cb54-53"><a href="#cb54-53"></a><span class="fu">standardizedsolution</span>(fit)</span>
<span id="cb54-54"><a href="#cb54-54"></a></span>
<span id="cb54-55"><a href="#cb54-55"></a><span class="co"># For the latent variable lvw (Well-being)  sat (satisfaction): Factor loading = 0.661 has a strong and significant relationship with well-being. Health has a moderate ( 0.421) and significant relationship with well-being. Friends have a very weak (0.077) but statistically significant relationship with well-being, suggesting it contributes very little to the construct.</span></span>
<span id="cb54-56"><a href="#cb54-56"></a><span class="co"># For lve (School environment) Belonging has a moderate (0.445) and significant relationship with the school environment.Disciplinary climate has a weaker (0.262) but still statistically significant relationship with the school environment.</span></span>
<span id="cb54-57"><a href="#cb54-57"></a><span class="co"># Overall z_pv_overall ~ lvw (effect of well-being on the outcome):not significant, p=0.518. There is no significant relationship between well-being and z_pv_overall in this model.</span></span>
<span id="cb54-58"><a href="#cb54-58"></a><span class="co"># z_pv_overall ~ lve (effect of school environment on the outcome): not significant, </span></span>
<span id="cb54-59"><a href="#cb54-59"></a><span class="co"># p = 0.424. Interpretation: The school environment does not have a significant impact on z_pv_overall in # this model.</span></span>
<span id="cb54-60"><a href="#cb54-60"></a></span>
<span id="cb54-61"><a href="#cb54-61"></a><span class="co"># Extract R^2</span></span>
<span id="cb54-62"><a href="#cb54-62"></a></span>
<span id="cb54-63"><a href="#cb54-63"></a><span class="fu">parameterEstimates</span>(fit, <span class="at">rsquare =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-64"><a href="#cb54-64"></a>  <span class="fu">filter</span>(op <span class="sc">==</span> <span class="st">"r2"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-65"><a href="#cb54-65"></a>  <span class="fu">select</span>(<span class="at">Item=</span>rhs, <span class="at">R2 =</span> est) <span class="sc">%&gt;%</span></span>
<span id="cb54-66"><a href="#cb54-66"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(R2))</span>
<span id="cb54-67"><a href="#cb54-67"></a></span>
<span id="cb54-68"><a href="#cb54-68"></a><span class="co"># Approximately 43.7% of the variance in life satisfaction is explained by the latent variable lvw (well-being). This is a relatively strong R2 indicating that sat is a meaningful and well-explained indicator of well-being. About 19.8% of the variance in sense of belonging is explained by the latent variable lve (school environment). While this is a moderate level of explanation, it suggests that there may be other unmeasured factors influencing the sense of belonging.</span></span>
<span id="cb54-69"><a href="#cb54-69"></a></span>
<span id="cb54-70"><a href="#cb54-70"></a><span class="co"># Outcome Variable (z_pv_overall): The weak R2 (15%)  highlights the need for additional predictors or model refinements to better explain its variance.</span></span>
<span id="cb54-71"><a href="#cb54-71"></a></span>
<span id="cb54-72"><a href="#cb54-72"></a><span class="co"># Model fit</span></span>
<span id="cb54-73"><a href="#cb54-73"></a><span class="fu">summary</span>(fit, <span class="at">fit.measures =</span> <span class="cn">TRUE</span>) </span>
<span id="cb54-74"><a href="#cb54-74"></a><span class="co"># The chi square p-value is 0 - indicating poor fit</span></span>
<span id="cb54-75"><a href="#cb54-75"></a><span class="co"># The CFI of 0.806 is not adequate</span></span>
<span id="cb54-76"><a href="#cb54-76"></a><span class="co"># The TLI of 0.585 is poor</span></span>
<span id="cb54-77"><a href="#cb54-77"></a><span class="co"># The RMSEA of 0.089 suggesting a moderate fit</span></span>
<span id="cb54-78"><a href="#cb54-78"></a></span>
<span id="cb54-79"><a href="#cb54-79"></a><span class="co"># Run model improvement indices</span></span>
<span id="cb54-80"><a href="#cb54-80"></a><span class="fu">modificationIndices</span>(fit, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-81"><a href="#cb54-81"></a></span>
<span id="cb54-82"><a href="#cb54-82"></a><span class="co"># The improvement indices suggest adding: fri ~~ z_pv_overall, fri ~~ BELONG, lvw =~  BELONG, lvw =~      DISCLIM. These make some sense from a theoretical point of view</span></span>
<span id="cb54-83"><a href="#cb54-83"></a></span>
<span id="cb54-84"><a href="#cb54-84"></a><span class="co"># the new model becomes</span></span>
<span id="cb54-85"><a href="#cb54-85"></a></span>
<span id="cb54-86"><a href="#cb54-86"></a>model_well_school_2 <span class="ot">&lt;-</span> <span class="st">"lvw =~  sat + hel + fri</span></span>
<span id="cb54-87"><a href="#cb54-87"></a><span class="st">        lve =~ BELONG + DISCLIM</span></span>
<span id="cb54-88"><a href="#cb54-88"></a><span class="st">        z_pv_overall ~ lvw + lve</span></span>
<span id="cb54-89"><a href="#cb54-89"></a><span class="st">        fri ~~ z_pv_overall</span></span>
<span id="cb54-90"><a href="#cb54-90"></a><span class="st">        fri ~~ BELONG</span></span>
<span id="cb54-91"><a href="#cb54-91"></a><span class="st">        lvw =~  DISCLIM"</span></span>
<span id="cb54-92"><a href="#cb54-92"></a></span>
<span id="cb54-93"><a href="#cb54-93"></a><span class="co"># Fit the revised model</span></span>
<span id="cb54-94"><a href="#cb54-94"></a>fit<span class="ot">&lt;-</span><span class="fu">sem</span>(model_well_school_2, <span class="at">data =</span> HK_data)</span>
<span id="cb54-95"><a href="#cb54-95"></a></span>
<span id="cb54-96"><a href="#cb54-96"></a><span class="co"># plot</span></span>
<span id="cb54-97"><a href="#cb54-97"></a><span class="fu">semPaths</span>(fit, <span class="at">whatLabels =</span> <span class="st">"Estimate"</span>)</span>
<span id="cb54-98"><a href="#cb54-98"></a></span>
<span id="cb54-99"><a href="#cb54-99"></a><span class="co"># Extract loadings</span></span>
<span id="cb54-100"><a href="#cb54-100"></a><span class="fu">standardizedsolution</span>(fit)</span>
<span id="cb54-101"><a href="#cb54-101"></a></span>
<span id="cb54-102"><a href="#cb54-102"></a><span class="co"># The environment latent variable is now significant (p=0.039) where in the first model it was not not significant  (p = 0.424). The wellbeing latent varibale remains not significant (p=0.071) - it was 0.424 in the first model. </span></span>
<span id="cb54-103"><a href="#cb54-103"></a></span>
<span id="cb54-104"><a href="#cb54-104"></a><span class="co"># Extract R^2</span></span>
<span id="cb54-105"><a href="#cb54-105"></a></span>
<span id="cb54-106"><a href="#cb54-106"></a><span class="fu">parameterEstimates</span>(fit, <span class="at">rsquare =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-107"><a href="#cb54-107"></a>  <span class="fu">filter</span>(op <span class="sc">==</span> <span class="st">"r2"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-108"><a href="#cb54-108"></a>  <span class="fu">select</span>(<span class="at">Item=</span>rhs, <span class="at">R2 =</span> est) <span class="sc">%&gt;%</span></span>
<span id="cb54-109"><a href="#cb54-109"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(R2))</span>
<span id="cb54-110"><a href="#cb54-110"></a></span>
<span id="cb54-111"><a href="#cb54-111"></a><span class="co"># Overall the explanatory power of the model is still low - the low latent variables only explaining </span></span>
<span id="cb54-112"><a href="#cb54-112"></a><span class="co"># 4% of the variation in the outcome variable. This is a reduction from the first model where the </span></span>
<span id="cb54-113"><a href="#cb54-113"></a><span class="co"># z_pv_overall variable was explained by 15% of the latent variables. The second model does explain</span></span>
<span id="cb54-114"><a href="#cb54-114"></a><span class="co"># some of the variables - "DISCLIM" R2 rose from 6.9% to 90% and "sat" from 43.7% to  46.2%</span></span>
<span id="cb54-115"><a href="#cb54-115"></a></span>
<span id="cb54-116"><a href="#cb54-116"></a><span class="co"># Model fit</span></span>
<span id="cb54-117"><a href="#cb54-117"></a><span class="fu">summary</span>(fit, <span class="at">fit.measures =</span> <span class="cn">TRUE</span>) </span>
<span id="cb54-118"><a href="#cb54-118"></a><span class="co"># The chi-square is 0 suggesting poor model fit - but the chi square test statistic has come down</span></span>
<span id="cb54-119"><a href="#cb54-119"></a><span class="co"># from 201.830 to 27.209 showing improvement</span></span>
<span id="cb54-120"><a href="#cb54-120"></a><span class="co"># The CFI is now  0.977 a better fit than the 0.806 - now into good fit</span></span>
<span id="cb54-121"><a href="#cb54-121"></a><span class="co"># The TLI has risen to 0.913 (was 0.585) - it is now good!</span></span>
<span id="cb54-122"><a href="#cb54-122"></a><span class="co"># The RMSEA has fallen from 0.089 to 0.040 showing an improvement and just gets under the 0.06 cut off</span></span>
<span id="cb54-123"><a href="#cb54-123"></a><span class="co"># for good fit</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="further-information" class="level2" data-number="1.10">
<h2 data-number="1.10" class="anchored" data-anchor-id="further-information"><span class="header-section-number">1.10</span> Further information</h2>
<ul>
<li>A good introduction to the <code>lavaan</code> package, which will support your understanding of SEM in R, can be found here <a href="https://lavaan.ugent.be/tutorial/">lavaan</a></li>
<li>You may find Schumacker and Lomax’s <span class="citation" data-cites="schumacker2004beginner">(<a href="#ref-schumacker2004beginner" role="doc-biblioref">Schumacker and Lomax 2004</a>)</span> book, <em>A beginner’s guide to structural equation modeling</em>, a helpful introduction.</li>
<li>The package <code>lavaangui</code> provides functions to help to produce publication-ready path diagrams using a GUI interface See <a href="https://github.com/karchjd/lavaangui/">lavaangui</a> for more details.</li>
</ul>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-chin1998partial" class="csl-entry" role="listitem">
Chin, Wynne W. 1998. <span>“The Partial Least Squares Approach to Structural Equation Modeling.”</span> <em>Modern Methods for Business Research/Lawrence Erlbaum Associates</em>.
</div>
<div id="ref-fornell1981evaluating" class="csl-entry" role="listitem">
Fornell, Claes, and David F Larcker. 1981. <span>“Evaluating Structural Equation Models with Unobservable Variables and Measurement Error.”</span> <em>Journal of Marketing Research</em> 18 (1): 39–50.
</div>
<div id="ref-hair2021partial" class="csl-entry" role="listitem">
Hair Jr, Joseph F, G Tomas M Hult, Christian M Ringle, Marko Sarstedt, Nicholas P Danks, and Soumya Ray. 2021. <em>Partial Least Squares Structural Equation Modeling (PLS-SEM) Using r: A Workbook</em>. Springer Nature.
</div>
<div id="ref-hoyle2012handbook" class="csl-entry" role="listitem">
Hoyle, Rick H. 2012. <em>Handbook of Structural Equation Modeling</em>. Guilford press.
</div>
<div id="ref-hulland1999use" class="csl-entry" role="listitem">
Hulland, John. 1999. <span>“Use of Partial Least Squares (PLS) in Strategic Management Research: A Review of Four Recent Studies.”</span> <em>Strategic Management Journal</em> 20 (2): 195–204.
</div>
<div id="ref-kline2023principles" class="csl-entry" role="listitem">
Kline, Rex B. 2023. <em>Principles and Practice of Structural Equation Modeling</em>. Guilford publications.
</div>
<div id="ref-lomax2013introduction" class="csl-entry" role="listitem">
Lomax, Richard. 2013. <span>“Introduction to Structural Equation Modeling.”</span> <em>Applied Quantitative Analysis in Education and the Social Sciences</em>, 245–64.
</div>
<div id="ref-mcdonald2002principles" class="csl-entry" role="listitem">
McDonald, Roderick P, and Moon-Ho Ringo Ho. 2002. <span>“Principles and Practice in Reporting Structural Equation Analyses.”</span> <em>Psychological Methods</em> 7 (1): 64.
</div>
<div id="ref-schumacker2004beginner" class="csl-entry" role="listitem">
Schumacker, Randall E, and Richard G Lomax. 2004. <em>A Beginner’s Guide to Structural Equation Modeling</em>. psychology press.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>